---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Manager IDs Setup - FPL Manager Watch">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Manager IDs Setup</h1>
    </header>

    <div id="loading" class="card">
      <div class="card-body text-center">
        <p class="text-muted">Checking authentication...</p>
      </div>
    </div>

    <div id="require-login" class="card" style="display: none;">
      <div class="card-body text-center">
        <h2 class="card-title">Login Required</h2>
        <p class="text-muted">You need to be logged in to manage your manager IDs.</p>
        <div style="margin-top: var(--space-4);">
          <a href="/login" class="btn btn--primary">Go to Login</a>
        </div>
      </div>
    </div>

    <div id="auth-check" style="display: none;">
      <!-- Quick Start - Compact -->
      <section class="card card--compact">
        <div class="card-body card-body--compact">
          <h2 class="card-title card-title--small">Quick Start</h2>
          <ol class="help-list help-list--compact">
            <li>Enter manager EntryIDs (one per line, max 50)</li>
            <li>Click "Save" ‚Äî IDs sync across all devices</li>
          </ol>
          <p class="tip tip--compact">
            <strong>Tip:</strong> Find EntryID in the FPL URL:
          </p>
          <code class="code-block code-block--compact">fantasy.premierleague.com/entry/<strong>1234</strong>/event/01</code>
        </div>
      </section>

      <!-- Entry IDs -->
      <section class="card">
        <div class="card-body">
          <form id="manager-form">
            <div class="control">
              <label class="label" for="ids">Manager EntryIDs</label>
            </div>

            <div class="ids-layout">
              <div class="ids-textarea-wrapper">
                <textarea
                  id="ids"
                  class="textarea"
                  rows="10"
                  placeholder="44&#10;200&#10;1320&#10;..."
                  disabled
                ></textarea>
              </div>

              <div class="ids-actions">
                <span class="ids-count">Managers: <strong id="count">0</strong></span>
                <button type="button" id="edit-btn" class="btn btn--neutral btn--full-width">‚úèÔ∏è Edit</button>
                <button type="submit" id="save-btn" class="btn btn--success btn--full-width" disabled>üíæ Save</button>
              </div>
            </div>
          </form>

          <div id="status" style="margin-top: var(--space-3);"></div>
        </div>
      </section>
    </div>
  </main>
</Layout>

<style>
  .card--compact {
    margin-bottom: var(--space-3);
  }

  .card-body--compact {
    padding: var(--space-3);
  }

  .card-title--small {
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .help-list--compact {
    padding-left: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .tip--compact {
    font-size: var(--text-xs);
    margin-top: 0;
    margin-bottom: var(--space-1);
  }

  .code-block--compact {
    display: block;
    padding: var(--space-2);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    word-break: break-all;
    overflow-wrap: break-word;
  }

  .ids-layout {
    display: flex;
    flex-direction: row;
    gap: var(--space-4);
    margin-top: var(--space-2);
    align-items: flex-start;
  }

  .ids-textarea-wrapper {
    width: 140px;
    flex-shrink: 0;
  }

  .ids-textarea-wrapper .textarea {
    width: 100%;
    font-size: var(--text-sm);
    min-height: 200px;
  }

  .ids-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    width: 120px;
  }

  .ids-count {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
  }

  .ids-count strong {
    color: var(--color-success);
  }

  .btn--full-width {
    width: 100%;
  }

  .textarea:disabled {
    background: var(--color-surface-alt);
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Desktop ONLY: Shrink cards to content and center */
  @media (min-width: 640px) {
    #auth-check {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #auth-check .card {
      width: auto;
      min-width: 400px;
      max-width: 550px;
    }

    .ids-layout {
      max-width: none;
    }

    .ids-textarea-wrapper {
      width: 280px;
    }

    .ids-textarea-wrapper .textarea {
      min-height: 300px;
    }

    .ids-actions {
      width: 160px;
    }
  }

  @media (max-width: 360px) {
    .ids-layout {
      flex-direction: column;
    }

    .ids-textarea-wrapper {
      width: 100%;
    }

    .ids-actions {
      flex-direction: row;
      flex-wrap: wrap;
      width: 100%;
    }

    .ids-actions .btn--full-width {
      flex: 1;
      min-width: 80px;
    }
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'

  const authCheckDiv = document.getElementById('auth-check') as HTMLElement
  const loadingDiv = document.getElementById('loading') as HTMLElement
  const requireLoginDiv = document.getElementById('require-login') as HTMLElement
  const form = document.getElementById('manager-form') as HTMLFormElement
  const textarea = document.getElementById('ids') as HTMLTextAreaElement
  const status = document.getElementById('status') as HTMLElement
  const countEl = document.getElementById('count') as HTMLElement
  const editBtn = document.getElementById('edit-btn') as HTMLButtonElement
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement

  let currentUser: any = null
  let isEditing = false

  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser()

    if (user) {
      currentUser = user
      loadingDiv.style.display = 'none'
      authCheckDiv.style.display = 'block'
      loadManagerIds()
    } else {
      loadingDiv.style.display = 'none'
      requireLoginDiv.style.display = 'block'
    }
  }

  async function loadManagerIds() {
    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', currentUser.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return
      }

      if (data && data.manager_ids) {
        textarea.value = data.manager_ids.join('\n')
        updateCount()
      }
    } catch (e) {
      console.error('Error:', e)
    }
  }

  async function saveManagerIds(ids: number[]) {
    try {
      const { data: existing } = await supabase
        .from('user_manager_lists')
        .select('id')
        .eq('user_id', currentUser.id)
        .single()

      if (existing) {
        const { error } = await supabase
          .from('user_manager_lists')
          .update({
            manager_ids: ids,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id)

        if (error) throw error
      } else {
        const { error } = await supabase
          .from('user_manager_lists')
          .insert({
            user_id: currentUser.id,
            manager_ids: ids
          })

        if (error) throw error
      }

      return true
    } catch (e) {
      console.error('Error saving manager IDs:', e)
      return false
    }
  }

  function updateCount() {
    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))
    countEl.textContent = String(ids.length)
    if (ids.length > 50) {
      countEl.style.color = "var(--color-danger)"
      countEl.textContent = `${ids.length} (max 50!)`
    } else {
      countEl.style.color = ids.length > 0 ? "var(--color-success)" : "var(--color-text-muted)"
    }
  }

  function setEditMode(editing: boolean) {
    isEditing = editing
    textarea.disabled = !editing
    saveBtn.disabled = !editing
    editBtn.textContent = editing ? '‚ùå Cancel' : '‚úèÔ∏è Edit'
    
    if (!editing) {
      loadManagerIds()
      status.innerHTML = ''
    }
  }

  editBtn.addEventListener('click', () => {
    setEditMode(!isEditing)
  })

  textarea.addEventListener('input', updateCount)

  form.onsubmit = async (e) => {
    e.preventDefault()
    
    if (!isEditing) return

    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))

    if (ids.length === 0) {
      status.innerHTML = "<p class='status status--error'>‚ö†Ô∏è Enter at least one valid EntryID.</p>"
      return
    }

    if (ids.length > 50) {
      status.innerHTML = "<p class='status status--error'>‚ö†Ô∏è Maximum 50 managers allowed.</p>"
      return
    }

    const uniqueIds = [...new Set(ids)].map(id => parseInt(id))

    const success = await saveManagerIds(uniqueIds)

    if (success) {
      let msg = `<p class='status status--success'>‚úÖ Saved ${uniqueIds.length} manager IDs!</p>`

      if (uniqueIds.length !== ids.length) {
        textarea.value = uniqueIds.join('\n')
        updateCount()
        msg += `<p class='status status--warning' style='margin-top: var(--space-2);'>Removed ${ids.length - uniqueIds.length} duplicate(s).</p>`
      }
      status.innerHTML = msg
      setEditMode(false)
    } else {
      status.innerHTML = "<p class='status status--error'>‚ùå Error saving. Please try again.</p>"
    }
  }

  checkAuth()
</script>