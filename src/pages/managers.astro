---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
import "../styles/pages/managers.css";
---
<Layout title="Manager IDs Setup - FPL Manager Watch">
  <Nav />

  <main class="page">

    <div id="loading" class="card">
      <div class="card-body text-center">
        <p class="text-muted">Checking authentication...</p>
      </div>
    </div>

    <div id="require-login" class="card" style="display: none;">
      <div class="card-body text-center">
        <h2 class="card-title">Login Required</h2>
        <p class="text-muted">You need to be logged in to manage your manager IDs.</p>
        <div style="margin-top: var(--space-4);">
          <a href="/login" class="btn btn--primary">Go to Login</a>
        </div>
      </div>
    </div>

    <div id="auth-check" style="display: none;">
      <!-- Quick Start - Compact -->
      <section class="card card--compact">
        <div class="card-body card-body--compact">
          <h2 class="card-title card-title--small">Quick Start: Manager IDs Setup</h2>
          <ol class="help-list help-list--compact">
            <li>Add EntryIDs manually (<strong>one per line</strong>, max 50) <em>or</em> use <strong>Import from league</strong></li>
            <li>Changes save automatically ‚Äî IDs sync across devices</li>
          </ol>

          <p class="tip tip--compact">
            <strong>Tip:</strong> Find IDs in official FPL URLs:
          </p>
          <code class="code-block code-block--compact">
            <strong><em class="qs-hl">Manager ID</em></strong> -
            fantasy.premierleague.com/entry/<strong class="qs-hl"><em>1234</em></strong>/event/01<br />
            <strong><em class="qs-hl">League ID</em></strong> -
            fantasy.premierleague.com/leagues/<strong class="qs-hl"><em>1234</em></strong>/standings/c
          </code>
        </div>
      </section>

      <!-- Entry IDs -->
      <section class="card">
        <div class="card-body">
          <form id="manager-form">
            <div class="ids-header">
              <label class="label" for="ids">
                 Manager EntryIDs <span class="ids-count-inline">(<strong id="count">0</strong>)</span>
              </label>
              <button type="button" id="manager-sources-open" class="btn-icon-info" title="View manager sources">‚ÑπÔ∏è</button>
            </div>

            <div class="ids-layout">
              <div class="ids-textarea-wrapper">
                <textarea
                  id="ids"
                  class="textarea"
                  rows="10"
                  placeholder="44&#10;200&#10;1320&#10;..."
                  disabled
                ></textarea>
              </div>

              <div class="ids-actions">
                <button type="button" id="edit-btn" class="btn btn--neutral btn--full-width">Edit Manager IDs</button>
                <button type="submit" id="save-btn" class="btn btn--success btn--full-width" disabled>üíæ Save</button>

                <button type="button" id="featured-open" class="btn btn--featured btn--full-width">
                  Browse featured managers
                </button>

                <button type="button" id="league-open" class="btn btn--league btn--full-width">
                  Import from mini league
                </button>
                <button type="button" id="manager-leagues-open" class="btn btn--league btn--full-width">
                  Import leagues from any manager
                </button>
              </div>
            </div>
          </form>
          <div id="status" style="margin-top: var(--space-3);"></div>
        </div>
      </section>

      <!-- Manager Sources Sheet -->
      <section id="manager-sources-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Manager sources</div>
            <div class="top-sheet__subtitle">View where each manager was imported from</div>
          </div>
          <button type="button" id="manager-sources-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <input id="manager-sources-search" class="input" type="text" placeholder="Search by ID or name..." autocomplete="off" />
          </div>

          <div id="manager-sources-list" class="manager-sources-list"></div>
        </div>
      </section>


      <!-- Featured managers top sheet (non-blocking; keeps textarea editable) -->
      <section id="featured-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Featured managers</div>
            <div class="top-sheet__subtitle">Tick/untick manager(s), then 'Apply changes' Click on a manager's name to see past season's final rankings.</div>
          </div>

          <button type="button" id="featured-close" class="top-sheet__close" aria-label="Close">
            ‚úï
          </button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="featured-search">Search</label>
            <input
              id="featured-search"
              class="input"
              placeholder="Search featured managers‚Ä¶"
              autocomplete="off"
            />
          </div>
          <div id="featured-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="featured-delta" class="top-sheet__status" aria-live="polite"></div>
          <div id="featured-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="featured-clear" class="btn btn--neutral">Clear</button>
            <button type="button" id="featured-apply" class="btn btn--success" disabled>
              Apply changes
            </button>
          </div>
        </div>
      </section>

      <!-- Manager history sheet -->
      <section id="manager-history-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div id="manager-history-title" class="top-sheet__title">Manager history</div>
            <div class="top-sheet__subtitle">Season-ending ranks from previous years.</div>
            <div id="manager-history-summary" class="top-sheet__subtitle manager-history-summary"></div>
          </div>
          <button type="button" id="manager-history-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div id="manager-history-status" class="top-sheet__status" aria-live="polite"></div>
          <div id="manager-history-list" class="manager-history-list"></div>
        </div>
      </section>

      <!-- League import sheet (save league IDs, choose a league) -->
      <section id="league-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Import from league</div>
            <div class="top-sheet__subtitle">Import and save a league, then choose manager(s) to add to your list.</div>
          </div>
          <button type="button" id="league-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="league-id-input">League ID</label>
            <input id="league-id-input" class="input" inputmode="url" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="League ID, e.g. 67893 or League URL" />
            <div class="text-muted" style="margin-top: 6px; font-size: var(--text-sm);">
              Tip: Use URL or ID within URL <code>fantasy.premierleague.com/leagues/<strong>123456</strong>/standings/c</code>
            </div>
          </div>

          <div style="display:flex; gap: var(--space-2); margin-bottom: var(--space-1);">
            <button type="button" id="league-save" class="btn btn--success">Save league</button>
            <button type="button" id="league-refresh" class="btn btn--neutral">Refresh list</button>
          </div>

          <div id="league-status" class="top-sheet__status" aria-live="polite"></div>

          <div style="margin-top: var(--space-1);">
            <div class="text-muted" style="margin-bottom: var(--space-2);">Saved leagues</div>
            <div id="league-list" class="featured-list"></div>
          </div>
        </div>

        <div class="top-sheet__footer">
          <div class="top-sheet__status">
            Open a league to select/deselect manager(s). Changes apply to your manager list.
          </div>
        </div>
      </section>

      <section id="manager-leagues-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Import leagues from manager</div>
            <div class="top-sheet__subtitle">Enter a <strong><em>Manager ID</em></strong>, then choose which leagues to save. Remove leagues in the 'Import from mini league' sheet.</div>
          </div>
          <button type="button" id="manager-leagues-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="manager-leagues-entry">Manager ID</label>
            <input id="manager-leagues-entry" class="input" inputmode="url" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="Manager ID or URL" />
            <div class="text-muted" style="margin-top: 6px; font-size: var(--text-sm);">
              Tip: Use URL or ID within URL <code>fantasy.premierleague.com/entry/<strong>123456</strong>/event/01</code>
            </div>
          </div>

          <div style="display:flex; gap: var(--space-2); margin-bottom: var(--space-1);">
            <button type="button" id="manager-leagues-fetch" class="btn btn--success">Fetch leagues</button>
          </div>

          <div id="manager-leagues-status" class="top-sheet__status" aria-live="polite"></div>

          <div id="manager-leagues-list" class="featured-list"></div>
         </div>

        <div class="top-sheet__footer">
          <div class="top-sheet__status" aria-live="polite">Max saved leagues: 15</div>
          <div class="top-sheet__actions">
            <button type="button" id="manager-leagues-apply" class="btn btn--success" disabled>
              Save selected leagues
            </button>
          </div>
        </div>
      </section>

      <!-- League standings sheet (tick/untick managers, then apply) -->
      <section id="league-standings-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div id="league-standings-title" class="top-sheet__title">League standings</div>
            <div id="league-standings-subtitle" class="top-sheet__subtitle"></div>
          </div>
          <button type="button" id="league-standings-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div id="league-standings-banner" class="top-sheet__status" aria-live="polite"></div>

          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="league-search">Search</label>
            <input
              id="league-search"
              class="input"
              placeholder="Search team, manager, or EntryID‚Ä¶"
              autocomplete="off"
            />
          </div>
 
          <div id="league-standings-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="league-apply-success" class="top-sheet__status" aria-live="polite"></div>
          <div id="league-apply-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="league-select-none" class="btn btn--neutral">Select none</button>
            <button type="button" id="league-apply" class="btn btn--success" disabled>Apply changes</button>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script type="module">
  import "../scripts/managers.page.ts";
</script>
