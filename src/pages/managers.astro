---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Manager IDs Setup - FPL Manager Watch">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Manager IDs Setup</h1>
    </header>

    <div id="loading" class="card">
      <div class="card-body text-center">
        <p class="text-muted">Checking authentication...</p>
      </div>
    </div>

    <div id="require-login" class="card" style="display: none;">
      <div class="card-body text-center">
        <h2 class="card-title">Login Required</h2>
        <p class="text-muted">You need to be logged in to manage your manager IDs.</p>
        <div style="margin-top: var(--space-4);">
          <a href="/login" class="btn btn--primary">Go to Login</a>
        </div>
      </div>
    </div>

    <div id="auth-check" style="display: none;">
      <!-- Quick Start - Compact -->
      <section class="card card--compact">
        <div class="card-body card-body--compact">
          <h2 class="card-title card-title--small">Quick Start</h2>
          <ol class="help-list help-list--compact">
            <li>Add EntryIDs manually (one per line, max 50) <em>or</em> use <strong>Import from league</strong></li>
            <li>Click <strong>Save</strong> ‚Äî IDs sync across devices</li>
          </ol>

          <p class="tip tip--compact">
            <strong>Tip:</strong> Find IDs in official FPL URLs:
          </p>
          <code class="code-block code-block--compact">
            fantasy.premierleague.com/entry/<strong>1234</strong>/event/01<br />
            fantasy.premierleague.com/leagues/<strong>1234</strong>/standings/c
          </code>
        </div>
      </section>

      <!-- Entry IDs -->
      <section class="card">
        <div class="card-body">
          <form id="manager-form">
            <div class="ids-header">
              <label class="label" for="ids">Manager EntryIDs</label>
              <span class="ids-count">Managers: <strong id="count">0</strong></span>
            </div>

            <div class="ids-layout">
              <div class="ids-textarea-wrapper">
                <textarea
                  id="ids"
                  class="textarea"
                  rows="10"
                  placeholder="44&#10;200&#10;1320&#10;..."
                  disabled
                ></textarea>
              </div>

              <div class="ids-actions">
                <button type="button" id="edit-btn" class="btn btn--neutral btn--full-width">‚úèÔ∏è Edit</button>
                <button type="submit" id="save-btn" class="btn btn--success btn--full-width" disabled>üíæ Save</button>

                <button type="button" id="featured-open" class="btn btn--featured btn--full-width">
                  Browse featured managers
                </button>

                <button type="button" id="league-open" class="btn btn--league btn--full-width">
                  Import from mini league
                </button>
              </div>
            </div>
          </form>
          <div id="status" style="margin-top: var(--space-3);"></div>
        </div>
      </section>

      <!-- Featured managers top sheet (non-blocking; keeps textarea editable) -->
      <section id="featured-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Featured managers</div>
            <div class="top-sheet__subtitle">Select one or more, then add them to your list.</div>
          </div>

          <button type="button" id="featured-close" class="top-sheet__close" aria-label="Close">
            ‚úï
          </button>
        </div>

        <div class="top-sheet__body">
          <div id="featured-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="featured-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="featured-clear" class="btn btn--neutral">Clear</button>
            <button type="button" id="featured-add" class="btn btn--success" disabled>
              Add selected (0)
            </button>
          </div>
        </div>
      </section>

      <!-- League import sheet (save league IDs, choose a league) -->
      <section id="league-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Import from league</div>
            <div class="top-sheet__subtitle">Save a league, then choose teams to import.</div>
          </div>
          <button type="button" id="league-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="league-id-input">League ID</label>
            <input id="league-id-input" class="input" inputmode="numeric" placeholder="e.g. 649356" />
            <div class="text-muted" style="margin-top: 6px; font-size: var(--text-sm);">
              Tip: from URL <code>/leagues/<strong>649356</strong>/standings/c</code>
            </div>
          </div>

          <div style="display:flex; gap: var(--space-2); margin-bottom: var(--space-3);">
            <button type="button" id="league-save" class="btn btn--success">Save league</button>
            <button type="button" id="league-refresh" class="btn btn--neutral">Refresh list</button>
          </div>

          <div id="league-status" class="top-sheet__status" aria-live="polite"></div>

          <div style="margin-top: var(--space-3);">
            <div class="text-muted" style="margin-bottom: var(--space-2);">Saved leagues</div>
            <div id="league-list" class="featured-list"></div>
          </div>
        </div>

        <div class="top-sheet__footer">
          <div class="top-sheet__status">
            Open a league to select managers. Changes apply to your manager list.
          </div>
        </div>
      </section>

      <!-- League standings sheet (tick/untick managers, then apply) -->
      <section id="league-standings-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div id="league-standings-title" class="top-sheet__title">League standings</div>
            <div id="league-standings-subtitle" class="top-sheet__subtitle"></div>
          </div>
          <button type="button" id="league-standings-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div id="league-standings-banner" class="top-sheet__status" aria-live="polite"></div>

          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="league-search">Search</label>
            <input
              id="league-search"
              class="input"
              placeholder="Search team, manager, or EntryID‚Ä¶"
              autocomplete="off"
            />
          </div>
 
          <div id="league-standings-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="league-apply-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="league-select-none" class="btn btn--neutral">Select none</button>
            <button type="button" id="league-apply" class="btn btn--success" disabled>Apply changes</button>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>


<style>
  .input {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    color: inherit;
    outline: none;
  }

  .input:focus {
    border-color: rgba(59, 130, 246, 0.65);
  }

  .card--compact {
    margin-bottom: var(--space-2);
  }

  .card-body--compact {
    padding: var(--space-2) var(--space-3);
  }

  .card-title--small {
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .help-list--compact {
    padding-left: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
  }

  .tip--compact {
    font-size: var(--text-xs);
    margin-top: 0;
    margin-bottom: 2px;
  }

  .code-block--compact {
    display: block;
    padding: var(--space-1) var(--space-2);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    word-break: break-all;
    overflow-wrap: break-word;
    line-height: 1.4;
  }

  .ids-layout {
    display: flex;
    flex-direction: row;
    gap: var(--space-4);
    margin-top: 0;
    align-items: flex-start;
  }

  .ids-textarea-wrapper {
    width: clamp(165px, 42vw, 220px);
    flex-shrink: 0;
  }

  .ids-textarea-wrapper .textarea {
    width: 100%;
    font-size: var(--text-sm);
    min-height: 320px;
  }

  .ids-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    width: 140px;
  }

  .ids-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }

  .ids-count {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .ids-count strong {
    color: var(--color-success);
  }
  
  .btn--full-width {
    width: 100%;
  }

  .textarea:disabled {
    background: var(--color-surface-alt);
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Custom button variant for "Browse featured managers" */
  .btn--featured {
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    text-align: center;
    line-height: 1.15;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  /* Bright yellow button for "Import from league" */
  .btn--league {
    background: #facc15; /* amber-400 */
    color: #111827; /* slate-900 */
    border: 1px solid rgba(0, 0, 0, 0.15);
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    text-align: center;
    line-height: 1.15;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  .btn--league:hover {
    background: #fbbf24; /* amber-300 */
  }

  .btn--league:active {
    background: #f59e0b; /* amber-500 */
  }

  .btn--league:focus-visible {
    outline: 2px solid rgba(250, 204, 21, 0.6);
    outline-offset: 2px;
  }

  /* --- TOP SHEET --- */
  .top-sheet {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;

    height: 95vh;
    max-height: 95vh;

    background: var(--color-surface, #111827);
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    z-index: 1000;

    transform: translateY(-105%);
    transition: transform 220ms ease;
    display: grid;
    grid-template-rows: auto 1fr auto;

    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
  }

  .top-sheet.is-open {
    transform: translateY(0);
  }

  .top-sheet__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3);
  }

  .top-sheet__title {
    font-weight: 700;
  }

  .top-sheet__subtitle {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-top: 2px;
  }

  .top-sheet__close {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.18);
    color: inherit;
    border-radius: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
  }

  .top-sheet__body {
    overflow: auto;
    padding: 0 var(--space-3) var(--space-3);
    -webkit-overflow-scrolling: touch;
  }

  .featured-list {
    display: grid;
    gap: var(--space-2);
  }

  .featured-item {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px 10px;

    padding: 10px var(--space-2);
    border: 1px solid rgba(255, 255, 255, 0.10);
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.03);

    font-size: 0.92em;
    line-height: 1.2;
  }

  .featured-item__name {
    font-weight: 700;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__note {
    color: var(--color-text-muted);
    font-size: 0.95em;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__id {
    margin-left: auto;
    flex-shrink: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__id code {
    font-family: var(--font-mono);
    font-size: 0.95em;
    white-space: nowrap;
  }

  .featured-item .featured-check,
  .featured-item .league-check {
    flex-shrink: 0;
    transform: scale(0.95);
  }

  .top-sheet__footer {
    border-top: 1px solid rgba(255, 255, 255, 0.10);
    padding: var(--space-2) var(--space-3);
    background: rgba(0, 0, 0, 0.15);
  }

  .top-sheet__status {
    min-height: 1.2em;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .top-sheet__actions {
    display: flex;
    gap: var(--space-2);
    justify-content: flex-end;
  }

  /* =========================
     MOBILE (<= 639px)
     ========================= */
  @media (max-width: 639px) {
    /* Make the right-column buttons more compact on mobile */
    .ids-actions .btn {
      min-height: 38px;
      padding: 8px 12px;
      font-size: 0.85rem;
    }

    .ids-actions .btn--featured,
    .ids-actions .btn--league {
      line-height: 1.1;
      padding-top: 8px;
      padding-bottom: 8px;
    }

    /* Compact saved leagues rows in the import sheet */
    #league-sheet .featured-item {
      padding-top: 6px;
      padding-bottom: 6px;
    }

    /* FORCE compact buttons inside ALL top-sheet modals on mobile
       (this overrides Layout.astro's global .btn sizing) */
    #league-sheet .btn,
    #league-standings-sheet .btn,
    #featured-sheet .btn {
      min-height: 34px !important;
      padding: 6px 10px !important;
      font-size: 0.85rem !important;
    }

    /* FIX: Tighter spacing in league import sheet */
    #league-sheet .control {
      gap: var(--space-1);
      margin-bottom: var(--space-1);
    }

    #league-sheet .input {
      min-height: 36px;
      padding: 6px 10px;
    }

    #league-sheet .text-muted {
      margin-top: 4px !important;
      margin-bottom: 0 !important;
    }

    /* Move saved leagues header closer to buttons */
    #league-sheet .top-sheet__body > div:last-child {
      margin-top: var(--space-1) !important;
    }

    #league-sheet .top-sheet__body > div:last-child > .text-muted {
      margin-bottom: var(--space-1) !important;
    }

    /* Make top-sheet taller on mobile */
    .top-sheet {
      height: 62vh;
      max-height: 62vh;
    }
  }

  /* =========================
     DESKTOP (>= 640px)
     ========================= */
  @media (min-width: 640px) {
    .page {
      align-items: center;
    }

    #auth-check {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    #auth-check .card {
      width: auto;
      min-width: 440px;
      max-width: 620px;
    }

    .ids-textarea-wrapper {
      width: 300px;
    }

    .ids-textarea-wrapper .textarea {
      min-height: 320px;
    }

    .ids-actions {
      width: 190px;
    }

    .top-sheet {
      height: 70vh;
      max-height: 70vh;
      left: 50%;
      right: auto;
      width: min(820px, 96vw);
      transform: translate(-50%, -105%);
      border-left: 1px solid rgba(255, 255, 255, 0.12);
      border-right: 1px solid rgba(255, 255, 255, 0.12);
      border-bottom-left-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
    }

    .top-sheet.is-open {
      transform: translate(-50%, 0);
    }

    .featured-item {
      font-size: 0.95em;
    }
  }

  /* =========================
     VERY SMALL PHONES (<= 360px)
     ========================= */
  @media (max-width: 360px) {
    .ids-layout {
      flex-direction: column;
    }

    .ids-textarea-wrapper {
      width: 100%;
    }

    .ids-actions {
      flex-direction: row;
      flex-wrap: wrap;
      width: 100%;
      gap: var(--space-2);
    }

    .ids-actions .btn--full-width {
      flex: 1;
      min-width: 80px;
    }
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'
  import { featuredManagers } from '../data/featuredManagers'

  // =========================
  // Single source of truth
  // =========================
  const MAX_MANAGERS = 50

  const authCheckDiv = document.getElementById('auth-check') as HTMLElement
  const loadingDiv = document.getElementById('loading') as HTMLElement
  const requireLoginDiv = document.getElementById('require-login') as HTMLElement
  const form = document.getElementById('manager-form') as HTMLFormElement
  const textarea = document.getElementById('ids') as HTMLTextAreaElement
  const status = document.getElementById('status') as HTMLElement
  const countEl = document.getElementById('count') as HTMLElement
  const editBtn = document.getElementById('edit-btn') as HTMLButtonElement
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement

  let currentUser: any = null
  let isEditing = false

  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser()

    if (user) {
      currentUser = user
      loadingDiv.style.display = 'none'
      authCheckDiv.style.display = 'block'
      loadManagerIds()
    } else {
      loadingDiv.style.display = 'none'
      requireLoginDiv.style.display = 'block'
    }
  }

  async function loadManagerIds() {
    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', currentUser.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return
      }

      if (data && data.manager_ids) {
        textarea.value = data.manager_ids.join('\n')
        updateCount()
      } else {
        textarea.value = ''
        updateCount()
      }
    } catch (e) {
      console.error('Error:', e)
    }
  }

  async function saveManagerIds(ids: number[]) {
    try {
      const { data: existing } = await supabase
        .from('user_manager_lists')
        .select('id')
        .eq('user_id', currentUser.id)
        .single()

      if (existing) {
        const { error } = await supabase
          .from('user_manager_lists')
          .update({
            manager_ids: ids,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id)

        if (error) throw error
      } else {
        const { error } = await supabase
          .from('user_manager_lists')
          .insert({
            user_id: currentUser.id,
            manager_ids: ids
          })

        if (error) throw error
      }

      return true
    } catch (e) {
      console.error('Error saving manager IDs:', e)
      return false
    }
  }

  function updateCount() {
    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))
    countEl.textContent = String(ids.length)
    if (ids.length > MAX_MANAGERS) {
      countEl.style.color = "var(--color-danger)"
      countEl.textContent = `${ids.length} (max ${MAX_MANAGERS}!)`
    } else {
      countEl.style.color = ids.length > 0 ? "var(--color-success)" : "var(--color-text-muted)"
    }
  }

  function setEditMode(editing: boolean) {
    isEditing = editing
    textarea.disabled = !editing
    saveBtn.disabled = !editing
    editBtn.textContent = editing ? '‚ùå Cancel' : '‚úèÔ∏è Edit'

    if (!editing) {
      loadManagerIds()
      status.innerHTML = ''
    }
  }

  editBtn.addEventListener('click', () => {
    setEditMode(!isEditing)
  })

  textarea.addEventListener('input', updateCount)

  form.onsubmit = async (e) => {
    e.preventDefault()

    if (!isEditing) return

    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))

    if (ids.length === 0) {
      status.innerHTML = "<p class='status status--error'>‚ö†Ô∏è Enter at least one valid EntryID.</p>"
      return
    }

    if (ids.length > MAX_MANAGERS) {
      status.innerHTML = `<p class='status status--error'>‚ö†Ô∏è Maximum ${MAX_MANAGERS} managers allowed.</p>`
      return
    }

    const uniqueIds = [...new Set(ids)].map(id => parseInt(id))

    const success = await saveManagerIds(uniqueIds)

    if (success) {
      let msg = `<p class='status status--success'>‚úÖ Saved ${uniqueIds.length} manager IDs!</p>`

      if (uniqueIds.length !== ids.length) {
        textarea.value = uniqueIds.join('\n')
        updateCount()
        msg += `<p class='status status--warning' style='margin-top: var(--space-2);'>Removed ${ids.length - uniqueIds.length} duplicate(s).</p>`
      }
      status.innerHTML = msg
      setEditMode(false)
    } else {
      status.innerHTML = "<p class='status status--error'>‚ùå Error saving. Please try again.</p>"
    }
  }

  // =========================
  // Featured managers top sheet
  // =========================
  const featuredOpenBtn = document.getElementById('featured-open') as HTMLButtonElement
  const featuredSheet = document.getElementById('featured-sheet') as HTMLElement
  const featuredCloseBtn = document.getElementById('featured-close') as HTMLButtonElement
  const featuredListEl = document.getElementById('featured-list') as HTMLElement
  const featuredAddBtn = document.getElementById('featured-add') as HTMLButtonElement
  const featuredClearBtn = document.getElementById('featured-clear') as HTMLButtonElement
  const featuredStatusEl = document.getElementById('featured-status') as HTMLElement

  const selectedFeaturedIds = new Set<number>()

  function openFeaturedSheet() {
    featuredSheet.classList.add('is-open')
    featuredSheet.setAttribute('aria-hidden', 'false')
  }

  function closeFeaturedSheet() {
    featuredSheet.classList.remove('is-open')
    featuredSheet.setAttribute('aria-hidden', 'true')
  }

  function parseTextareaIds(): number[] {
    const trimmed = textarea.value.trim()
    if (!trimmed) return []
    return trimmed
      .split(/[\s,]+/)
      .filter(x => x.match(/^\d+$/))
      .map(x => parseInt(x, 10))
  }

  function updateFeaturedActions() {
    featuredAddBtn.disabled = selectedFeaturedIds.size === 0
    featuredAddBtn.textContent = `Add selected (${selectedFeaturedIds.size})`
  }

  function escapeHtml(s: string) {
    return s.replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&': return '&amp;'
        case '<': return '&lt;'
        case '>': return '&gt;'
        case '"': return '&quot;'
        case "'": return '&#39;'
        default: return ch
      }
    })
  }

  function renderFeaturedList() {
    featuredListEl.innerHTML = featuredManagers.map((m) => {
      const safeName = escapeHtml(String(m.name ?? ''))
      const safeNote = m.note ? escapeHtml(String(m.note)) : ''
      const entryId = Number(m.entryId)

      return `
        <label class="featured-item">
          <input type="checkbox" class="featured-check" data-id="${entryId}" />
          <span class="featured-item__name">${safeName}</span>
          ${safeNote ? `<span class="featured-item__note">‚Äî ${safeNote}</span>` : ``}
          <span class="featured-item__id">${safeNote ? `‚Äî ` : ``}<code>${entryId}</code></span>
        </label>
      `
    }).join('')

    featuredListEl.querySelectorAll<HTMLInputElement>('input.featured-check').forEach((cb) => {
      cb.addEventListener('change', () => {
        const id = parseInt(cb.dataset.id || '', 10)
        if (!Number.isFinite(id)) return

        if (cb.checked) selectedFeaturedIds.add(id)
        else selectedFeaturedIds.delete(id)

        updateFeaturedActions()
      })
    })
  }

  function clearFeaturedSelection() {
    selectedFeaturedIds.clear()
    featuredListEl.querySelectorAll<HTMLInputElement>('input.featured-check').forEach(cb => { cb.checked = false })
    updateFeaturedActions()
  }

  featuredOpenBtn?.addEventListener('click', () => {
    if (!featuredListEl.dataset.rendered) {
      renderFeaturedList()
      featuredListEl.dataset.rendered = 'true'
    }
    featuredStatusEl.textContent = ''
    openFeaturedSheet()
  })

  featuredCloseBtn?.addEventListener('click', () => closeFeaturedSheet())

  featuredClearBtn?.addEventListener('click', () => {
    featuredStatusEl.textContent = ''
    clearFeaturedSelection()
  })

  featuredAddBtn?.addEventListener('click', () => {
    if (selectedFeaturedIds.size === 0) return

    if (!isEditing) setEditMode(true)

    const existing = new Set(parseTextareaIds())
    const toAdd = [...selectedFeaturedIds].filter(id => !existing.has(id))

    if (toAdd.length === 0) {
      featuredStatusEl.textContent = 'All selected managers are already in your list.'
      return
    }

    const combinedCount = existing.size + toAdd.length
    if (combinedCount > MAX_MANAGERS) {
      featuredStatusEl.textContent = `Too many managers. Limit is ${MAX_MANAGERS}.`
      return
    }

    const current = textarea.value.trim()
    const appended = (current ? current + '\n' : '') + toAdd.join('\n')
    textarea.value = appended + '\n'

    updateCount()
    featuredStatusEl.textContent = `Added ${toAdd.length} manager${toAdd.length === 1 ? '' : 's'}.`

    clearFeaturedSelection()
  })

  updateFeaturedActions()

  // =========================
  // League import
  // =========================

  const leagueOpenBtn = document.getElementById('league-open') as HTMLButtonElement
  const leagueSheet = document.getElementById('league-sheet') as HTMLElement
  const leagueCloseBtn = document.getElementById('league-close') as HTMLButtonElement
  const leagueIdInput = document.getElementById('league-id-input') as HTMLInputElement
  const leagueSaveBtn = document.getElementById('league-save') as HTMLButtonElement
  const leagueRefreshBtn = document.getElementById('league-refresh') as HTMLButtonElement
  const leagueStatusEl = document.getElementById('league-status') as HTMLElement
  const leagueListEl = document.getElementById('league-list') as HTMLElement

  const standingsSheet = document.getElementById('league-standings-sheet') as HTMLElement
  const standingsCloseBtn = document.getElementById('league-standings-close') as HTMLButtonElement
  const standingsTitleEl = document.getElementById('league-standings-title') as HTMLElement
  const standingsSubtitleEl = document.getElementById('league-standings-subtitle') as HTMLElement
  const standingsBannerEl = document.getElementById('league-standings-banner') as HTMLElement
  const standingsListEl = document.getElementById('league-standings-list') as HTMLElement
  const leagueSearchInput = document.getElementById('league-search') as HTMLInputElement
  const applyStatusEl = document.getElementById('league-apply-status') as HTMLElement
  const selectNoneBtn = document.getElementById('league-select-none') as HTMLButtonElement
  const applyBtn = document.getElementById('league-apply') as HTMLButtonElement

  type SavedLeague = { league_id: number; league_name: string | null }
  type StandingRow = { rank: number; entryId: number; entryName: string; playerName?: string | null }

  let activeLeague: { id: number; name: string | null } | null = null
  let activeStandings: StandingRow[] = []
  let activeSelectedEntryIds = new Set<number>()
  let previouslyImportedForActiveLeague = new Set<number>()
  let standingsSearchQuery = ''

  function openLeagueSheet() {
    leagueSheet.classList.add('is-open')
    leagueSheet.setAttribute('aria-hidden', 'false')
  }
  function closeLeagueSheet() {
    leagueSheet.classList.remove('is-open')
    leagueSheet.setAttribute('aria-hidden', 'true')
  }
  function openStandingsSheet() {
    standingsSheet.classList.add('is-open')
    standingsSheet.setAttribute('aria-hidden', 'false')
  }
  function closeStandingsSheet() {
    standingsSheet.classList.remove('is-open')
    standingsSheet.setAttribute('aria-hidden', 'true')
  }

  async function fetchLeagueMeta(leagueId: number) {
    const res = await fetch(`/api/fpl/league/${leagueId}`)
    if (!res.ok) throw new Error('League lookup failed')
    return await res.json() as { leagueId: number; leagueName: string | null }
  }

  async function fetchAllStandingsClassic(leagueId: number): Promise<{ leagueName: string | null; rows: StandingRow[] }> {
    let page = 1
    let all: StandingRow[] = []
    let leagueName: string | null = null

    while (true) {
      const res = await fetch(`/api/fpl/league/${leagueId}/standings?page=${page}`)
      if (!res.ok) throw new Error('Standings fetch failed')
      const data = await res.json() as any
      leagueName = leagueName ?? data?.league?.name ?? null
      const results = Array.isArray(data?.results) ? data.results : []
      all = all.concat(results)
      if (!data?.hasNext) break
      page++
      if (page > 50) break
    }

    all.sort((a, b) => a.rank - b.rank)
    return { leagueName, rows: all }
  }

  async function loadSavedLeagues() {
    leagueListEl.innerHTML = ''
    leagueStatusEl.textContent = ''

    const { data, error } = await supabase
      .from('user_saved_leagues')
      .select('league_id, league_name')
      .eq('user_id', currentUser.id)
      .order('updated_at', { ascending: false })

    if (error) {
      console.error(error)
      leagueStatusEl.textContent = 'Error loading saved leagues.'
      return
    }

    const leagues: SavedLeague[] = (data || []).map((x: any) => ({
      league_id: Number(x.league_id),
      league_name: x.league_name ? String(x.league_name) : null,
    }))

    if (leagues.length === 0) {
      leagueListEl.innerHTML = `<div class="text-muted">No saved leagues yet.</div>`
      return
    }

    leagueListEl.innerHTML = leagues.map((l) => {
      const name = l.league_name ? escapeHtml(l.league_name) : `League ${l.league_id}`
      return `
        <div class="featured-item" style="justify-content: space-between;">
          <div style="display:flex; flex-direction:column; gap:2px;">
            <div class="featured-item__name" style="margin:0;">
              ${name} <span class="featured-item__note">‚Äî ID: <code>${l.league_id}</code></span>
            </div>
          </div>

          <div style="display:flex; gap: var(--space-2); align-items:center;">
            <button type="button" class="btn btn--neutral" data-action="open" data-league-id="${l.league_id}">Open</button>
            <button type="button" class="btn btn--neutral" data-action="remove" data-league-id="${l.league_id}">Remove</button>
          </div>
        </div>
      `
    }).join('')

    leagueListEl.querySelectorAll<HTMLButtonElement>('button[data-action="open"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const leagueId = Number(btn.dataset.leagueId)
        await openLeagueStandings(leagueId)
      })
    })

    leagueListEl.querySelectorAll<HTMLButtonElement>('button[data-action="remove"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const leagueId = Number(btn.dataset.leagueId)
        const ok = confirm(`Remove league ${leagueId}? (This does not change your manager list yet.)`)
        if (!ok) return
        const { error } = await supabase
          .from('user_saved_leagues')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('league_id', leagueId)
        if (error) {
          console.error(error)
          leagueStatusEl.textContent = 'Failed to remove league.'
          return
        }
        await supabase
          .from('user_league_imports')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('league_id', leagueId)

        await loadSavedLeagues()
      })
    })
  }

  async function saveLeagueById() {
    leagueStatusEl.textContent = ''
    const raw = (leagueIdInput.value || '').trim()
    if (!raw.match(/^\d+$/)) {
      leagueStatusEl.textContent = 'Enter a valid numeric league ID.'
      return
    }

    const leagueId = Number(raw)

    leagueSaveBtn.disabled = true
    try {
      const meta = await fetchLeagueMeta(leagueId)

      const { error } = await supabase
        .from('user_saved_leagues')
        .upsert({
          user_id: currentUser.id,
          league_id: leagueId,
          league_name: meta.leagueName,
          updated_at: new Date().toISOString(),
        }, { onConflict: 'user_id,league_id' })

      if (error) throw error

      leagueStatusEl.textContent = `Saved: ${meta.leagueName || `League ${leagueId}`}`
      leagueIdInput.value = ''
      await loadSavedLeagues()
    } catch (e) {
      console.error(e)
      leagueStatusEl.textContent = 'Could not save league. Check the ID and try again.'
    } finally {
      leagueSaveBtn.disabled = false
    }
  }

  async function loadPreviouslyImportedForLeague(leagueId: number) {
    const { data, error } = await supabase
      .from('user_league_imports')
      .select('entry_id')
      .eq('user_id', currentUser.id)
      .eq('league_id', leagueId)

    if (error) {
      console.error(error)
      return new Set<number>()
    }

    return new Set<number>((data || []).map((r: any) => Number(r.entry_id)))
  }

  async function leagueNamesByIds(leagueIds: number[]) {
    if (leagueIds.length === 0) return new Map<number, string>()
    const { data, error } = await supabase
      .from('user_saved_leagues')
      .select('league_id, league_name')
      .eq('user_id', currentUser.id)
      .in('league_id', leagueIds)

    if (error) {
      console.error(error)
      return new Map<number, string>()
    }

    const m = new Map<number, string>()
    for (const row of (data || []) as any[]) {
      m.set(Number(row.league_id), row.league_name ? String(row.league_name) : `League ${row.league_id}`)
    }
    return m
  }

  async function loadCrossLeagueInfoForEntries(entryIds: number[], excludeLeagueId: number) {
    const { data, error } = await supabase
      .from('user_league_imports')
      .select('entry_id, league_id')
      .eq('user_id', currentUser.id)
      .in('entry_id', entryIds)

    if (error) {
      console.error(error)
      return new Map<number, number[]>()
    }

    const map = new Map<number, number[]>()
    for (const row of (data || []) as any[]) {
      const entryId = Number(row.entry_id)
      const leagueId = Number(row.league_id)
      if (leagueId === excludeLeagueId) continue
      const arr = map.get(entryId) || []
      arr.push(leagueId)
      map.set(entryId, arr)
    }
    return map
  }

  function renderStandingsList() {
    const q = (standingsSearchQuery || '').trim().toLowerCase()

    const filtered = !q
      ? activeStandings
      : activeStandings.filter((r) => {
          const entryName = (r.entryName || '').toLowerCase()
          const playerName = (r.playerName || '').toLowerCase()
          const entryIdStr = String(r.entryId)
          return (
            entryName.includes(q) ||
            playerName.includes(q) ||
            entryIdStr.includes(q)
          )
        })

    standingsListEl.innerHTML = filtered.map((r) => {
      const checked = activeSelectedEntryIds.has(r.entryId) ? 'checked' : ''
      const safeEntryName = escapeHtml(r.entryName || '')
      const safePlayerName = r.playerName ? escapeHtml(r.playerName) : ''
      return `
        <label class="featured-item">
          <input type="checkbox" class="league-check" data-entry-id="${r.entryId}" ${checked} />
          <span class="featured-item__name">#${r.rank} ${safeEntryName}</span>
          ${safePlayerName ? `<span class="featured-item__note">‚Äî ${safePlayerName}</span>` : ``}
          <span class="featured-item__id"><code>${r.entryId}</code></span>
        </label>
    `
    }).join('')

    standingsListEl.querySelectorAll<HTMLInputElement>('input.league-check').forEach((cb) => {
      cb.addEventListener('change', async () => {
        const entryId = Number(cb.dataset.entryId)
        if (!Number.isFinite(entryId)) return

        if (cb.checked) activeSelectedEntryIds.add(entryId)
        else activeSelectedEntryIds.delete(entryId)

        await updateStandingsBannerAndWarnings()
      })
    })
  }

  async function updateStandingsBannerAndWarnings() {
    const currentManagerIds = new Set<number>(parseTextareaIds())

    const selected = [...activeSelectedEntryIds]
    const selectedCount = selected.length

    const toRemove = [...previouslyImportedForActiveLeague].filter((id) => !activeSelectedEntryIds.has(id))
    const toAdd = selected.filter((id) => !currentManagerIds.has(id))

    const totalAfter = currentManagerIds.size - toRemove.filter((id) => currentManagerIds.has(id)).length + toAdd.length
    const remaining = MAX_MANAGERS - totalAfter

    const hasDelta = (toRemove.length > 0) || (toAdd.length > 0)
    applyBtn.disabled = !hasDelta

    const allRelevant = Array.from(new Set([...toRemove, ...toAdd]))
    const crossLeagueIdsMap = await loadCrossLeagueInfoForEntries(allRelevant, activeLeague!.id)
    const otherLeagueIds = Array.from(new Set(Array.from(crossLeagueIdsMap.values()).flat()))
    const namesMap = await leagueNamesByIds(otherLeagueIds)

    const lines: string[] = []
    lines.push(`Selected in this league: ${selectedCount}`)
    lines.push(`Total after apply: ${totalAfter} / ${MAX_MANAGERS}`)
    lines.push(`Remaining slots after apply: ${remaining}`)

    const warnLines: string[] = []

    for (const id of toAdd) {
      const other = crossLeagueIdsMap.get(id) || []
      if (other.length > 0) {
        const leagues = other.map((lid) => namesMap.get(lid) || `League ${lid}`).join(', ')
        warnLines.push(`‚ö†Ô∏è EntryID ${id} is already selected in: ${leagues}.`)
      }
    }

    for (const id of toRemove) {
      const other = crossLeagueIdsMap.get(id) || []
      if (other.length > 0) {
        const leagues = other.map((lid) => namesMap.get(lid) || `League ${lid}`).join(', ')
        warnLines.push(`‚ö†Ô∏è EntryID ${id} is also selected in: ${leagues}. Unticking here will remove it from your manager list entirely.`)
      }
    }

    standingsBannerEl.textContent = lines.join(' ‚Ä¢ ')
    applyStatusEl.textContent = warnLines.join(' ')
  }

  async function openLeagueStandings(leagueId: number) {
    applyStatusEl.textContent = ''
    standingsBannerEl.textContent = 'Loading league standings...'
    standingsListEl.innerHTML = ''
    applyBtn.disabled = true

    closeLeagueSheet()

    try {
      const standings = await fetchAllStandingsClassic(leagueId)
      activeLeague = { id: leagueId, name: standings.leagueName }

      await supabase
        .from('user_saved_leagues')
        .upsert({
          user_id: currentUser.id,
          league_id: leagueId,
          league_name: standings.leagueName,
          updated_at: new Date().toISOString(),
        }, { onConflict: 'user_id,league_id' })

      activeStandings = standings.rows

      standingsSearchQuery = ''
      if (leagueSearchInput) leagueSearchInput.value = ''

      previouslyImportedForActiveLeague = await loadPreviouslyImportedForLeague(leagueId)

      // Build a set of all EntryIDs in this league standings
      const leagueEntryIdSet = new Set<number>(activeStandings.map((r) => r.entryId))

      // Your current saved managers (manual + featured + any previous imports)
      const currentManagerIdSet = new Set<number>(parseTextareaIds())

      // Find managers you already have that are in this league
      const matchesFromCurrentList = new Set<number>()
      for (const id of currentManagerIdSet) {
        if (leagueEntryIdSet.has(id)) matchesFromCurrentList.add(id)
      }

      // Auto-select: union(previouslyImportedForActiveLeague, matchesFromCurrentList)
      activeSelectedEntryIds = new Set<number>([
        ...previouslyImportedForActiveLeague,
        ...matchesFromCurrentList,
      ])

      standingsTitleEl.textContent = standings.leagueName ? standings.leagueName : `League ${leagueId}`
      standingsSubtitleEl.textContent = `Tick/untick managers, then Apply changes.`

      renderStandingsList()
      openStandingsSheet()
      await updateStandingsBannerAndWarnings()
    } catch (e) {
      console.error(e)
      standingsBannerEl.textContent = 'Failed to load standings. Check league ID and try again.'
      openStandingsSheet()
    }
  }

  async function applyLeagueChanges() {
    if (!activeLeague) return

    applyBtn.disabled = true
    selectNoneBtn.disabled = true

    try {
      if (!isEditing) setEditMode(true)

      // clear any old main-page message
      status.innerHTML = ''

      const current = new Set<number>(parseTextareaIds())

      const toRemove = [...previouslyImportedForActiveLeague].filter((id) => !activeSelectedEntryIds.has(id))
      const toAdd = [...activeSelectedEntryIds].filter((id) => !current.has(id))

      const next = new Set<number>(current)
      for (const id of toRemove) next.delete(id)
      for (const id of toAdd) next.add(id)

      if (next.size > MAX_MANAGERS) {
        const msg = `‚ùå Too many managers. Limit is ${MAX_MANAGERS}. Reduce your selection.`
        applyStatusEl.textContent = msg
        status.innerHTML = `<p class='status status--error'>${msg}</p>`
        return
      }

      // Update textarea (local) first
      textarea.value = Array.from(next).join('\n') + '\n'
      updateCount()

      // Update import mapping table to reflect current selection for this league
      if (toRemove.length > 0) {
        const { error } = await supabase
          .from('user_league_imports')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('league_id', activeLeague.id)
          .in('entry_id', toRemove as any)

        if (error) throw error
      }

      if (activeSelectedEntryIds.size > 0) {
        const lookup = new Map<number, StandingRow>()
        activeStandings.forEach((r) => lookup.set(r.entryId, r))

        const payload = [...activeSelectedEntryIds].map((entryId) => {
          const row = lookup.get(entryId)
          return {
            user_id: currentUser.id,
            league_id: activeLeague!.id,
            entry_id: entryId,
            entry_name: row?.entryName || null,
            rank: row?.rank || null,
            updated_at: new Date().toISOString(),
          }
        })

        const { error } = await supabase
          .from('user_league_imports')
          .upsert(payload, { onConflict: 'user_id,league_id,entry_id' })

        if (error) throw error
      }

      // Sync "previously imported" set to the current selection
      previouslyImportedForActiveLeague = new Set<number>(activeSelectedEntryIds)

      // Success message (once)
      const removedCount = toRemove.length
      const addedCount = toAdd.length

      let msg = ''
      if (addedCount > 0 && removedCount > 0) {
        msg = `‚úÖ ${addedCount} manager(s) added and ${removedCount} removed. Click ‚ÄúSave‚Äù to sync across devices.`
      } else if (addedCount > 0) {
        msg = `‚úÖ ${addedCount} manager(s) added to your list. Click ‚ÄúSave‚Äù to sync across devices.`
      } else if (removedCount > 0) {
        msg = `‚úÖ ${removedCount} manager(s) removed from your list. Click ‚ÄúSave‚Äù to sync across devices.`
      } else {
        msg = `No changes to apply.`
      }

      applyStatusEl.textContent = msg
      status.innerHTML = `<p class='status ${msg.startsWith('‚úÖ') ? 'status--success' : 'status--warning'}'>${msg}</p>`

      await updateStandingsBannerAndWarnings()
    } catch (e) {
      console.error(e)
      const msg = '‚ùå Failed to apply changes. Please try again.'
      applyStatusEl.textContent = msg
      status.innerHTML = `<p class='status status--error'>${msg}</p>`
    } finally {
      selectNoneBtn.disabled = false
      await updateStandingsBannerAndWarnings()
    }
  }

  leagueOpenBtn?.addEventListener('click', async () => {
    leagueStatusEl.textContent = ''
    openLeagueSheet()
    await loadSavedLeagues()
  })

  leagueCloseBtn?.addEventListener('click', () => closeLeagueSheet())
  leagueRefreshBtn?.addEventListener('click', async () => loadSavedLeagues())
  leagueSaveBtn?.addEventListener('click', async () => saveLeagueById())

  standingsCloseBtn?.addEventListener('click', () => closeStandingsSheet())

  leagueSearchInput?.addEventListener('input', () => {
    standingsSearchQuery = leagueSearchInput.value || ''
    renderStandingsList()
  })

  selectNoneBtn?.addEventListener('click', async () => {
    activeSelectedEntryIds.clear()
    standingsListEl.querySelectorAll<HTMLInputElement>('input.league-check').forEach((cb) => (cb.checked = false))
    await updateStandingsBannerAndWarnings()
  })

  applyBtn?.addEventListener('click', async () => {
    const toRemove = [...previouslyImportedForActiveLeague].filter((id) => !activeSelectedEntryIds.has(id))
    if (toRemove.length > 0) {
      const ok = confirm(`Apply changes?\n\nThis will remove ${toRemove.length} manager(s) from your list if unticked here.`)
      if (!ok) return
    }
    await applyLeagueChanges()
  })

  checkAuth()
</script>
