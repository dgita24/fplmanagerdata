---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Manager IDs Setup - FPL Manager Watch">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Manager IDs Setup</h1>
    </header>

    <div id="loading" class="card">
      <div class="card-body text-center">
        <p class="text-muted">Checking authentication...</p>
      </div>
    </div>

    <div id="require-login" class="card" style="display: none;">
      <div class="card-body text-center">
        <h2 class="card-title">Login Required</h2>
        <p class="text-muted">You need to be logged in to manage your manager IDs.</p>
        <div style="margin-top: var(--space-4);">
          <a href="/login" class="btn btn--primary">Go to Login</a>
        </div>
      </div>
    </div>

    <div id="auth-check" style="display: none;">
      <!-- Quick Start - Compact -->
      <section class="card card--compact">
        <div class="card-body card-body--compact">
          <h2 class="card-title card-title--small">Quick Start</h2>
          <ol class="help-list help-list--compact">
            <li>Enter manager EntryIDs (one per line, max 35)</li>
            <li>Click "Save" ‚Äî IDs sync across all devices</li>
          </ol>
          <p class="tip tip--compact">
            <strong>Tip:</strong> Find EntryID in the FPL URL:
          </p>
          <code class="code-block code-block--compact">fantasy.premierleague.com/entry/<strong>1234</strong>/event/01</code>
        </div>
      </section>

      <!-- Entry IDs -->
      <section class="card">
        <div class="card-body">
          <form id="manager-form">
            <div class="control">
              <label class="label" for="ids">Manager EntryIDs</label>
            </div>

            <div class="ids-layout">
              <div class="ids-textarea-wrapper">
                <textarea
                  id="ids"
                  class="textarea"
                  rows="10"
                  placeholder="44&#10;200&#10;1320&#10;..."
                  disabled
                ></textarea>
              </div>

              <div class="ids-actions">
                <span class="ids-count">Managers: <strong id="count">0</strong></span>
                <button type="button" id="edit-btn" class="btn btn--neutral btn--full-width">‚úèÔ∏è Edit</button>
                <button type="submit" id="save-btn" class="btn btn--success btn--full-width" disabled>üíæ Save</button>

                <!-- Now a real button styled like Save (but different colour) -->
                <button type="button" id="featured-open" class="btn btn--featured btn--full-width">
                  Browse featured managers
                </button>
              </div>
            </div>
          </form>

          <div id="status" style="margin-top: var(--space-3);"></div>
        </div>
      </section>

      <!-- Featured managers top sheet (non-blocking; keeps textarea editable) -->
      <section id="featured-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Featured managers</div>
            <div class="top-sheet__subtitle">Select one or more, then add them to your list.</div>
          </div>

          <button type="button" id="featured-close" class="top-sheet__close" aria-label="Close">
            ‚úï
          </button>
        </div>

        <div class="top-sheet__body">
          <div id="featured-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="featured-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="featured-clear" class="btn btn--neutral">Clear</button>
            <button type="button" id="featured-add" class="btn btn--success" disabled>
              Add selected (0)
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>

<style>
  .card--compact {
    margin-bottom: var(--space-3);
  }

  .card-body--compact {
    padding: var(--space-3);
  }

  .card-title--small {
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .help-list--compact {
    padding-left: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .tip--compact {
    font-size: var(--text-xs);
    margin-top: 0;
    margin-bottom: var(--space-1);
  }

  .code-block--compact {
    display: block;
    padding: var(--space-2);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    word-break: break-all;
    overflow-wrap: break-word;
  }

  .ids-layout {
    display: flex;
    flex-direction: row;
    gap: var(--space-4);
    margin-top: var(--space-2);
    align-items: flex-start;
  }

  .ids-textarea-wrapper {
    width: 140px;
    flex-shrink: 0;
  }

  .ids-textarea-wrapper .textarea {
    width: 100%;
    font-size: var(--text-sm);
    min-height: 200px;
  }

  .ids-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    width: 140px;
  }

  .ids-count {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
  }

  .ids-count strong {
    color: var(--color-success);
  }

  .btn--full-width {
    width: 100%;
  }

  .textarea:disabled {
    background: var(--color-surface-alt);
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Custom button variant for "Browse featured managers"
     (inherits sizing/typography from your existing .btn styles) */
  .btn--featured {
    white-space: normal;        /* allow multi-line text */
    overflow-wrap: anywhere;    /* break long words if needed */
    word-break: break-word;     /* fallback */
    text-align: center;         /* looks better on 2 lines */
    line-height: 1.15;
    padding-top: 10px;          /* optional: keeps vertical balance if it wraps */
    padding-bottom: 10px;
  }

  .btn--featured:hover {
    background: #1d4ed8; /* blue-700 */
  }

  /* --- Featured managers TOP SHEET --- */
  .top-sheet {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;

    height: 52vh;
    max-height: 52vh;

    background: var(--color-surface, #111827);
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    z-index: 1000;

    transform: translateY(-105%);
    transition: transform 220ms ease;
    display: grid;
    grid-template-rows: auto 1fr auto;

    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
  }

  .top-sheet.is-open {
    transform: translateY(0);
  }

  .top-sheet__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3);
  }

  .top-sheet__title {
    font-weight: 700;
  }

  .top-sheet__subtitle {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-top: 2px;
  }

  .top-sheet__close {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.18);
    color: inherit;
    border-radius: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
  }

  .top-sheet__body {
    overflow: auto;
    padding: 0 var(--space-3) var(--space-3);
    -webkit-overflow-scrolling: touch;
  }

  .featured-list {
    display: grid;
    gap: var(--space-2);
  }

  /* ONE-LINE layout per manager (wraps when needed) */
  .featured-item {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px 10px;

    padding: 10px var(--space-2);
    border: 1px solid rgba(255, 255, 255, 0.10);
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.03);

    font-size: 0.92em;
    line-height: 1.2;
  }

  .featured-item__name {
    font-weight: 700;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__note {
    color: var(--color-text-muted);
    font-size: 0.95em;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__id {
    margin-left: auto;
    flex-shrink: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__id code {
    font-family: var(--font-mono);
    font-size: 0.95em;
    white-space: nowrap;
  }

  .featured-item .featured-check {
    flex-shrink: 0;
    transform: scale(0.95);
  }

  .top-sheet__footer {
    border-top: 1px solid rgba(255, 255, 255, 0.10);
    padding: var(--space-2) var(--space-3);
    background: rgba(0, 0, 0, 0.15);
  }

  .top-sheet__status {
    min-height: 1.2em;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .top-sheet__actions {
    display: flex;
    gap: var(--space-2);
    justify-content: flex-end;
  }

  /* Desktop ONLY: Shrink cards to content and center */
  @media (min-width: 640px) {
    .page {
      align-items: center;
    }

    #auth-check {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    #auth-check .card {
      width: auto;
      min-width: 440px;
      max-width: 620px;
    }

    .ids-textarea-wrapper {
      width: 300px;
    }

    .ids-textarea-wrapper .textarea {
      min-height: 320px;
    }

    .ids-actions {
      width: 190px;
    }

    .top-sheet {
      height: 70vh;
      max-height: 70vh;
      left: 50%;
      right: auto;
      width: min(820px, 96vw);
      transform: translate(-50%, -105%);
      border-left: 1px solid rgba(255, 255, 255, 0.12);
      border-right: 1px solid rgba(255, 255, 255, 0.12);
      border-bottom-left-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
    }

    .top-sheet.is-open {
      transform: translate(-50%, 0);
    }

    .featured-item {
      font-size: 0.95em;
    }
  }

  @media (max-width: 360px) {
    .ids-layout {
      flex-direction: column;
    }

    .ids-textarea-wrapper {
      width: 100%;
    }

    .ids-actions {
      flex-direction: row;
      flex-wrap: wrap;
      width: 100%;
    }

    .ids-actions .btn--full-width {
      flex: 1;
      min-width: 80px;
    }
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'
  import { featuredManagers } from '../data/featuredManagers'

  const authCheckDiv = document.getElementById('auth-check') as HTMLElement
  const loadingDiv = document.getElementById('loading') as HTMLElement
  const requireLoginDiv = document.getElementById('require-login') as HTMLElement
  const form = document.getElementById('manager-form') as HTMLFormElement
  const textarea = document.getElementById('ids') as HTMLTextAreaElement
  const status = document.getElementById('status') as HTMLElement
  const countEl = document.getElementById('count') as HTMLElement
  const editBtn = document.getElementById('edit-btn') as HTMLButtonElement
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement

  let currentUser: any = null
  let isEditing = false

  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser()

    if (user) {
      currentUser = user
      loadingDiv.style.display = 'none'
      authCheckDiv.style.display = 'block'
      loadManagerIds()
    } else {
      loadingDiv.style.display = 'none'
      requireLoginDiv.style.display = 'block'
    }
  }

  async function loadManagerIds() {
    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', currentUser.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return
      }

      if (data && data.manager_ids) {
        textarea.value = data.manager_ids.join('\n')
        updateCount()
      }
    } catch (e) {
      console.error('Error:', e)
    }
  }

  async function saveManagerIds(ids: number[]) {
    try {
      const { data: existing } = await supabase
        .from('user_manager_lists')
        .select('id')
        .eq('user_id', currentUser.id)
        .single()

      if (existing) {
        const { error } = await supabase
          .from('user_manager_lists')
          .update({
            manager_ids: ids,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id)

        if (error) throw error
      } else {
        const { error } = await supabase
          .from('user_manager_lists')
          .insert({
            user_id: currentUser.id,
            manager_ids: ids
          })

        if (error) throw error
      }

      return true
    } catch (e) {
      console.error('Error saving manager IDs:', e)
      return false
    }
  }

  function updateCount() {
    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))
    countEl.textContent = String(ids.length)
    if (ids.length > 35) {
      countEl.style.color = "var(--color-danger)"
      countEl.textContent = `${ids.length} (max 50!)`
    } else {
      countEl.style.color = ids.length > 0 ? "var(--color-success)" : "var(--color-text-muted)"
    }
  }

  function setEditMode(editing: boolean) {
    isEditing = editing
    textarea.disabled = !editing
    saveBtn.disabled = !editing
    editBtn.textContent = editing ? '‚ùå Cancel' : '‚úèÔ∏è Edit'

    if (!editing) {
      loadManagerIds()
      status.innerHTML = ''
    }
  }

  editBtn.addEventListener('click', () => {
    setEditMode(!isEditing)
  })

  textarea.addEventListener('input', updateCount)

  form.onsubmit = async (e) => {
    e.preventDefault()

    if (!isEditing) return

    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))

    if (ids.length === 0) {
      status.innerHTML = "<p class='status status--error'>‚ö†Ô∏è Enter at least one valid EntryID.</p>"
      return
    }

    if (ids.length > 35) {
      status.innerHTML = "<p class='status status--error'>‚ö†Ô∏è Maximum 50 managers allowed.</p>"
      return
    }

    const uniqueIds = [...new Set(ids)].map(id => parseInt(id))

    const success = await saveManagerIds(uniqueIds)

    if (success) {
      let msg = `<p class='status status--success'>‚úÖ Saved ${uniqueIds.length} manager IDs!</p>`

      if (uniqueIds.length !== ids.length) {
        textarea.value = uniqueIds.join('\n')
        updateCount()
        msg += `<p class='status status--warning' style='margin-top: var(--space-2);'>Removed ${ids.length - uniqueIds.length} duplicate(s).</p>`
      }
      status.innerHTML = msg
      setEditMode(false)
    } else {
      status.innerHTML = "<p class='status status--error'>‚ùå Error saving. Please try again.</p>"
    }
  }

  // --- Featured managers top sheet ---
  const featuredOpenBtn = document.getElementById('featured-open') as HTMLButtonElement
  const featuredSheet = document.getElementById('featured-sheet') as HTMLElement
  const featuredCloseBtn = document.getElementById('featured-close') as HTMLButtonElement
  const featuredListEl = document.getElementById('featured-list') as HTMLElement
  const featuredAddBtn = document.getElementById('featured-add') as HTMLButtonElement
  const featuredClearBtn = document.getElementById('featured-clear') as HTMLButtonElement
  const featuredStatusEl = document.getElementById('featured-status') as HTMLElement

  const selectedFeaturedIds = new Set<number>()

  function openFeaturedSheet() {
    featuredSheet.classList.add('is-open')
    featuredSheet.setAttribute('aria-hidden', 'false')
  }

  function closeFeaturedSheet() {
    featuredSheet.classList.remove('is-open')
    featuredSheet.setAttribute('aria-hidden', 'true')
  }

  function parseTextareaIds(): number[] {
    const trimmed = textarea.value.trim()
    if (!trimmed) return []
    return trimmed
      .split(/[\s,]+/)
      .filter(x => x.match(/^\d+$/))
      .map(x => parseInt(x, 10))
  }

  function updateFeaturedActions() {
    featuredAddBtn.disabled = selectedFeaturedIds.size === 0
    featuredAddBtn.textContent = `Add selected (${selectedFeaturedIds.size})`
  }

  function escapeHtml(s: string) {
    return s.replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&': return '&amp;'
        case '<': return '&lt;'
        case '>': return '&gt;'
        case '"': return '&quot;'
        case "'": return '&#39;'
        default: return ch
      }
    })
  }

  function renderFeaturedList() {
    featuredListEl.innerHTML = featuredManagers.map((m) => {
      const safeName = escapeHtml(String(m.name ?? ''))
      const safeNote = m.note ? escapeHtml(String(m.note)) : ''
      const entryId = Number(m.entryId)

      return `
        <label class="featured-item">
          <input type="checkbox" class="featured-check" data-id="${entryId}" />
          <span class="featured-item__name">${safeName}</span>
          ${safeNote ? `<span class="featured-item__note">‚Äî ${safeNote}</span>` : ``}
          <span class="featured-item__id">${safeNote ? `‚Äî ` : ``}<code>${entryId}</code></span>
        </label>
      `
    }).join('')

    featuredListEl.querySelectorAll<HTMLInputElement>('input.featured-check').forEach((cb) => {
      cb.addEventListener('change', () => {
        const id = parseInt(cb.dataset.id || '', 10)
        if (!Number.isFinite(id)) return

        if (cb.checked) selectedFeaturedIds.add(id)
        else selectedFeaturedIds.delete(id)

        updateFeaturedActions()
      })
    })
  }

  function clearFeaturedSelection() {
    selectedFeaturedIds.clear()
    featuredListEl.querySelectorAll<HTMLInputElement>('input.featured-check').forEach(cb => { cb.checked = false })
    updateFeaturedActions()
  }

  featuredOpenBtn?.addEventListener('click', () => {
    if (!featuredListEl.dataset.rendered) {
      renderFeaturedList()
      featuredListEl.dataset.rendered = 'true'
    }
    featuredStatusEl.textContent = ''
    openFeaturedSheet()
  })

  featuredCloseBtn?.addEventListener('click', () => closeFeaturedSheet())

  featuredClearBtn?.addEventListener('click', () => {
    featuredStatusEl.textContent = ''
    clearFeaturedSelection()
  })

  featuredAddBtn?.addEventListener('click', () => {
    if (selectedFeaturedIds.size === 0) return

    if (!isEditing) setEditMode(true)

    const existing = new Set(parseTextareaIds())
    const toAdd = [...selectedFeaturedIds].filter(id => !existing.has(id))

    if (toAdd.length === 0) {
      featuredStatusEl.textContent = 'All selected managers are already in your list.'
      return
    }

    const current = textarea.value.trim()
    const appended = (current ? current + '\n' : '') + toAdd.join('\n')
    textarea.value = appended + '\n'

    updateCount()
    featuredStatusEl.textContent = `Added ${toAdd.length} manager${toAdd.length === 1 ? '' : 's'}.`

    clearFeaturedSelection()
  })

  updateFeaturedActions()
  checkAuth()
</script>
