---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Manager IDs Setup - FPL Manager Watch">
  <Nav />

  <main class="page">

    <div id="loading" class="card">
      <div class="card-body text-center">
        <p class="text-muted">Checking authentication...</p>
      </div>
    </div>

    <div id="require-login" class="card" style="display: none;">
      <div class="card-body text-center">
        <h2 class="card-title">Login Required</h2>
        <p class="text-muted">You need to be logged in to manage your manager IDs.</p>
        <div style="margin-top: var(--space-4);">
          <a href="/login" class="btn btn--primary">Go to Login</a>
        </div>
      </div>
    </div>

    <div id="auth-check" style="display: none;">
      <!-- Quick Start - Compact -->
      <section class="card card--compact">
        <div class="card-body card-body--compact">
          <h2 class="card-title card-title--small">Quick Start: Manager IDs Setup</h2>
          <ol class="help-list help-list--compact">
            <li>Add EntryIDs manually (<strong>one per line</strong>, max 50) <em>or</em> use <strong>Import from league</strong></li>
            <li>Changes save automatically ‚Äî IDs sync across devices</li>
          </ol>

          <p class="tip tip--compact">
            <strong>Tip:</strong> Find IDs in official FPL URLs:
          </p>
          <code class="code-block code-block--compact">
            <strong><em class="qs-hl">Manager ID</em></strong> -
            fantasy.premierleague.com/entry/<strong class="qs-hl"><em>1234</em></strong>/event/01<br />
            <strong><em class="qs-hl">League ID</em></strong> -
            fantasy.premierleague.com/leagues/<strong class="qs-hl"><em>1234</em></strong>/standings/c
          </code>
        </div>
      </section>

      <!-- Entry IDs -->
      <section class="card">
        <div class="card-body">
          <form id="manager-form">
            <div class="ids-header">
              <label class="label" for="ids">
                 Manager EntryIDs <span class="ids-count-inline">(<strong id="count">0</strong>)</span>
              </label>
              <button type="button" id="manager-sources-open" class="btn-icon-info" title="View manager sources">‚ÑπÔ∏è</button>
            </div>

            <div class="ids-layout">
              <div class="ids-textarea-wrapper">
                <textarea
                  id="ids"
                  class="textarea"
                  rows="10"
                  placeholder="44&#10;200&#10;1320&#10;..."
                  disabled
                ></textarea>
              </div>

              <div class="ids-actions">
                <button type="button" id="edit-btn" class="btn btn--neutral btn--full-width">Edit Manager IDs</button>
                <button type="submit" id="save-btn" class="btn btn--success btn--full-width" disabled>üíæ Save</button>

                <button type="button" id="featured-open" class="btn btn--featured btn--full-width">
                  Browse featured managers
                </button>

                <button type="button" id="league-open" class="btn btn--league btn--full-width">
                  Import from mini league
                </button>
                <button type="button" id="manager-leagues-open" class="btn btn--league btn--full-width">
                  Import leagues from any manager
                </button>
              </div>
            </div>
          </form>
          <div id="status" style="margin-top: var(--space-3);"></div>
        </div>
      </section>

      <!-- Manager Sources Sheet -->
      <section id="manager-sources-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Manager sources</div>
            <div class="top-sheet__subtitle">View where each manager was imported from</div>
          </div>
          <button type="button" id="manager-sources-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <input id="manager-sources-search" class="input" type="text" placeholder="Search by ID or name..." autocomplete="off" />
          </div>

          <div id="manager-sources-list" class="manager-sources-list"></div>
        </div>
      </section>


      <!-- Featured managers top sheet (non-blocking; keeps textarea editable) -->
      <section id="featured-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Featured managers</div>
            <div class="top-sheet__subtitle">Tick/untick manager(s), then 'Apply changes' Click on a manager's name to see past season's final rankings.</div>
          </div>

          <button type="button" id="featured-close" class="top-sheet__close" aria-label="Close">
            ‚úï
          </button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="featured-search">Search</label>
            <input
              id="featured-search"
              class="input"
              placeholder="Search featured managers‚Ä¶"
              autocomplete="off"
            />
          </div>
          <div id="featured-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="featured-delta" class="top-sheet__status" aria-live="polite"></div>
          <div id="featured-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="featured-clear" class="btn btn--neutral">Clear</button>
            <button type="button" id="featured-apply" class="btn btn--success" disabled>
              Apply changes
            </button>
          </div>
        </div>
      </section>

      <!-- Manager history sheet -->
      <section id="manager-history-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div id="manager-history-title" class="top-sheet__title">Manager history</div>
            <div class="top-sheet__subtitle">Season-ending ranks from previous years.</div>
            <div id="manager-history-summary" class="top-sheet__subtitle manager-history-summary"></div>
          </div>
          <button type="button" id="manager-history-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div id="manager-history-status" class="top-sheet__status" aria-live="polite"></div>
          <div id="manager-history-list" class="manager-history-list"></div>
        </div>
      </section>

      <!-- League import sheet (save league IDs, choose a league) -->
      <section id="league-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Import from league</div>
            <div class="top-sheet__subtitle">Import and save a league, then choose manager(s) to add to your list.</div>
          </div>
          <button type="button" id="league-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="league-id-input">League ID</label>
            <input id="league-id-input" class="input" inputmode="url" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="League ID, e.g. 67893 or League URL" />
            <div class="text-muted" style="margin-top: 6px; font-size: var(--text-sm);">
              Tip: Use URL or ID within URL <code>fantasy.premierleague.com/leagues/<strong>123456</strong>/standings/c</code>
            </div>
          </div>

          <div style="display:flex; gap: var(--space-2); margin-bottom: var(--space-1);">
            <button type="button" id="league-save" class="btn btn--success">Save league</button>
            <button type="button" id="league-refresh" class="btn btn--neutral">Refresh list</button>
          </div>

          <div id="league-status" class="top-sheet__status" aria-live="polite"></div>

          <div style="margin-top: var(--space-1);">
            <div class="text-muted" style="margin-bottom: var(--space-2);">Saved leagues</div>
            <div id="league-list" class="featured-list"></div>
          </div>
        </div>

        <div class="top-sheet__footer">
          <div class="top-sheet__status">
            Open a league to select/deselect manager(s). Changes apply to your manager list.
          </div>
        </div>
      </section>

      <section id="manager-leagues-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div class="top-sheet__title">Import leagues from manager</div>
            <div class="top-sheet__subtitle">Enter a <strong><em>Manager ID</em></strong>, then choose which leagues to save. Remove leagues in the 'Import from mini league' sheet.</div>
          </div>
          <button type="button" id="manager-leagues-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="manager-leagues-entry">Manager ID</label>
            <input id="manager-leagues-entry" class="input" inputmode="url" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="Manager ID or URL" />
            <div class="text-muted" style="margin-top: 6px; font-size: var(--text-sm);">
              Tip: Use URL or ID within URL <code>fantasy.premierleague.com/entry/<strong>123456</strong>/event/01</code>
            </div>
          </div>

          <div style="display:flex; gap: var(--space-2); margin-bottom: var(--space-1);">
            <button type="button" id="manager-leagues-fetch" class="btn btn--success">Fetch leagues</button>
          </div>

          <div id="manager-leagues-status" class="top-sheet__status" aria-live="polite"></div>

          <div id="manager-leagues-list" class="featured-list"></div>
         </div>

        <div class="top-sheet__footer">
          <div class="top-sheet__status" aria-live="polite">Max saved leagues: 15</div>
          <div class="top-sheet__actions">
            <button type="button" id="manager-leagues-apply" class="btn btn--success" disabled>
              Save selected leagues
            </button>
          </div>
        </div>
      </section>

      <!-- League standings sheet (tick/untick managers, then apply) -->
      <section id="league-standings-sheet" class="top-sheet" aria-hidden="true">
        <div class="top-sheet__header">
          <div>
            <div id="league-standings-title" class="top-sheet__title">League standings</div>
            <div id="league-standings-subtitle" class="top-sheet__subtitle"></div>
          </div>
          <button type="button" id="league-standings-close" class="top-sheet__close" aria-label="Close">‚úï</button>
        </div>

        <div class="top-sheet__body">
          <div id="league-standings-banner" class="top-sheet__status" aria-live="polite"></div>

          <div class="control" style="margin-bottom: var(--space-2);">
            <label class="label" for="league-search">Search</label>
            <input
              id="league-search"
              class="input"
              placeholder="Search team, manager, or EntryID‚Ä¶"
              autocomplete="off"
            />
          </div>
 
          <div id="league-standings-list" class="featured-list"></div>
        </div>

        <div class="top-sheet__footer">
          <div id="league-apply-success" class="top-sheet__status" aria-live="polite"></div>
          <div id="league-apply-status" class="top-sheet__status" aria-live="polite"></div>
          <div class="top-sheet__actions">
            <button type="button" id="league-select-none" class="btn btn--neutral">Select none</button>
            <button type="button" id="league-apply" class="btn btn--success" disabled>Apply changes</button>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>


<style is:global>
  .input {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    color: inherit;
    outline: none;
  }

  .input:focus {
    border-color: rgba(59, 130, 246, 0.65);
  }

  /* Quick Start highlight tokens */
  .code-block--compact .qs-hl {
    color: var(--color-warning);
    font-family: var(--font-sans);
    font-weight: 800 !important;
    font-style: italic;
    font-size: 1.10em;
  }

  #manager-leagues-sheet .top-sheet__subtitle strong {
    color: var(--color-warning);
    font-weight: 800;
  }

  .card--compact {
    margin-bottom: var(--space-2);
  }

  .card-body--compact {
    padding: var(--space-2) var(--space-3);
  }

  .card-title--small {
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .help-list--compact {
    padding-left: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
  }

  .tip--compact {
    font-size: var(--text-xs);
    margin-top: 0;
    margin-bottom: 2px;
  }

  .code-block--compact {
    display: block;
    padding: var(--space-1) var(--space-2);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    word-break: break-all;
    overflow-wrap: break-word;
    line-height: 1.4;
  }

  .ids-layout {
    display: flex;
    flex-direction: row;
    gap: var(--space-4);
    margin-top: 0;
    align-items: flex-start;
  }

  .ids-textarea-wrapper {
    width: clamp(165px, 42vw, 220px);
    flex-shrink: 0;
  }

  .ids-textarea-wrapper .textarea {
    width: 100%;
    font-size: var(--text-sm);
    min-height: 380px;
  }

  .ids-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    width: 140px;
  }

  .ids-header {
    margin-bottom: var(--space-2);
  }

  .btn-icon-info {
    border: none;
    background: transparent;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 2px 6px;
    margin-left: 4px;
    opacity: 0.7;
    transition: opacity 0.15s ease;
    vertical-align: middle;
    line-height: 1; 
  }

  .btn-icon-info:hover {
    opacity: 1;
  }

  .manager-sources-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Ensure checkboxes stay blue when checked */
    input[type="checkbox"]:checked {
      accent-color: var(--color-primary);
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .manager-source-item {
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-bg);
      line-height: 1.4;
    }

    .manager-source-item__header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .manager-source-item__name {
      font-size: 0.95rem;
      font-weight: 500;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .manager-source-item__id {
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--color-primary);
      font-weight: 600;
      flex-shrink: 0;
    }

    .manager-source-item__source {
      margin-top: 4px;
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }

    .manager-source-item__footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 8px;
    }

    .manager-source-item__delete {
      border: none;
      background: transparent;
      font-size: 0.95rem;
      cursor: pointer;
      padding: 4px;
      opacity: 0.5;
      transition: opacity 0.15s ease;
      flex-shrink: 0;
    }

    .manager-source-item__delete:hover {
      opacity: 1;
    }

    /* Make the sheet narrower on desktop, fullscreen on mobile */
    #manager-sources-sheet.top-sheet {
      max-width: 500px;
    }

    @media (max-width: 640px) {
      #manager-sources-sheet.top-sheet {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        max-width: 100%;
        height: 100vh;
        height: 100dvh;
        max-height: 100dvh;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }

      #manager-sources-sheet .top-sheet__header {
        padding-top: calc(var(--space-3) + env(safe-area-inset-top));
      }
    }
  .ids-count-inline {
    font-size: inherit;
    font-weight: inherit;
    color: var(--color-text-secondary);
    margin-left: var(--space-1);
  }

  .ids-count-inline strong {
    color: var(--color-success);
    font-weight: inherit;
  }
  
  .btn--full-width {
    width: 100%;
  }

  /* Managers page: slightly taller action buttons on tablet/desktop */
  @media (min-width: 640px) {
    .ids-actions .btn {
      min-height: 44px;              /* taller tap target */
      padding-top: 12px;
      padding-bottom: 12px;
    }
  }

  /* Allow Edit button text to fit on small devices */
  #edit-btn {
    white-space: normal;      /* overrides Layout's .btn { white-space: nowrap } */
    overflow-wrap: anywhere;
    line-height: 1.15;
    font-size: 0.9rem;
  }


  .textarea:disabled {
    background: var(--color-surface-alt);
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Custom button variant for "Browse featured managers" */
  .btn--featured {
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    text-align: center;
    line-height: 1.15;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  /* Bright yellow button for "Import from league" */
  .btn--league {
    background: #facc15; /* amber-400 */
    color: #111827; /* slate-900 */
    border: 1px solid rgba(0, 0, 0, 0.15);
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    text-align: center;
    line-height: 1.15;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  .btn--league:hover {
    background: #fbbf24; /* amber-300 */
  }

  .btn--league:active {
    background: #f59e0b; /* amber-500 */
  }

  .btn--league:focus-visible {
    outline: 2px solid rgba(250, 204, 21, 0.6);
    outline-offset: 2px;
  }

  /* --- TOP SHEET --- */
  .top-sheet {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;

    height: 62vh;
    max-height:62vh;

    background: var(--color-surface, #111827);
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    z-index: 1000;

    transform: translateY(-105%);
    transition: transform 220ms ease;
    display: grid;
    grid-template-rows: auto 1fr auto;

    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
  }

  .top-sheet.is-open {
    transform: translateY(0);
  }

  .top-sheet__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3);
  }

  .top-sheet__title {
    font-weight: 700;
  }

  .top-sheet__subtitle {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-top: 2px;
  }

  .top-sheet__close {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.18);
    color: inherit;
    border-radius: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
  }

  #featured-sheet .top-sheet__close,
  #manager-leagues-sheet .top-sheet__close,
  #league-sheet .top-sheet__close,
  #league-standings-sheet .top-sheet__close {
    width: 56px;
    height: 40px;
    min-width: 56px;
    flex: 0 0 56px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 1.3rem;
    background: rgba(255, 255, 255, 0.08);
  }

  .top-sheet__body {
    overflow: auto;
    padding: 0 var(--space-3) var(--space-3);
    -webkit-overflow-scrolling: touch;
  }

  .featured-list {
    display: grid;
    gap: var(--space-2);
  }

  .featured-item {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 4px 8px;

    padding: 6px var(--space-2);
    border: 1px solid rgba(255, 255, 255, 0.10);
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.03);

    font-size: 0.92em;
    line-height: 1.2;

    align-items: center;
  }

  .featured-item__name {
    font-weight: 700;
    font-size: 0.9em;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__note {
    color: var(--color-text-muted);
    font-size: 0.95em;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__id {
    margin-left: auto;
    flex-shrink: 0;
    overflow-wrap: anywhere;
  }

  .featured-item__id code {
    font-family: var(--font-mono);
    font-size: 0.95em;
    white-space: nowrap;
  }

  .featured-item__name-button {
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
    color: var(--color-primary);
    font: inherit;
    cursor: pointer;
    text-align: left;
  }

  .featured-item__name-button:hover {
    color: #93c5fd; /* light blue */
    text-decoration: underline;
  }

  .featured-item__name-button:hover {
    text-decoration: underline;
  }

  .manager-history-list {
    display: grid;
    gap: var(--space-2);
  }

  .manager-history-row {
    display: grid;
    grid-template-columns: 1fr 1.05fr 1.15fr; /* give points more space */
    column-gap: 6px; /* tighter between season + points */
    padding: 8px 10px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.03);
  }

  .manager-history-col {
    padding: 0 6px;
    border-right: 1px solid rgba(255, 255, 255, 0.12);
    font-size: var(--text-sm);
  }

  .manager-history-col--season {
    font-weight: 700;
    padding-left: 0;
  }

  .manager-history-col--points {
    color: var(--color-text-muted);
    padding-right: 12px;
    white-space: nowrap;
  }

  .manager-history-col--rank {
    border-right: none;
    font-weight: 600;
  }

  .manager-history-summary {
    display: grid;
    gap: 2px;
  }


  /* Saved leagues: force 2-row layout (title row, then actions row) */
  #league-sheet #league-list .saved-league-card {
    flex-direction: column;
    align-items: stretch;
  }

  #league-sheet #league-list .saved-league-title {
    display: block; /* natural wrapping */
    min-width: 0;
  }

  #league-sheet #league-list .saved-league-actions {
    display: flex;
    justify-content: space-between; /* Open left, Remove right */
    gap: var(--space-2);
    margin-top: var(--space-1);
    align-items: center;

  }

  /* Push Remove to the far right, keep buttons compact */
  #league-sheet #league-list .saved-league-actions .btn:last-child {
    margin-left: auto;
  }


  .featured-item .featured-check,
  .featured-item .league-check {
    flex-shrink: 0;
    transform: scale(0.95);
  }

  #manager-leagues-sheet input[type="checkbox"] {
    accent-color: var(--color-primary);
  }

  .top-sheet__footer {
    border-top: 1px solid rgba(255, 255, 255, 0.10);
    padding: var(--space-2) var(--space-3);
    background: rgba(0, 0, 0, 0.15);
  }

  .top-sheet__status {
    min-height: 1.2em;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
  }

  .top-sheet__actions {
    display: flex;
    gap: var(--space-2);
    justify-content: flex-end;
  }

  #featured-apply {
    white-space: nowrap;
    min-width: 0;
  }

  /* =========================
   MOBILE (<= 639px)
   ========================= */
  @media (max-width: 639px) {
    /* Mobile-only: let the Entry IDs card grow and fill spare vertical space */
    #auth-check {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 100vh;
      gap: var(--space-3);
    }

    /* First card = Quick Start (natural height), second card = Entry IDs (flexes) */
    #auth-check > .card:last-of-type {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    #auth-check > .card:last-of-type .card-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    /* Make the Manager EntryIDs card fill vertically on mobile */
    .card-body > #manager-form {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    .ids-layout {
      /* This row (textarea + buttons) should take the remaining space
         after the label/banner at the top. */
      flex: 1 1 auto;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      gap: var(--space-3);
    }

    .ids-textarea-wrapper,
    .ids-actions {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
    }

    /* Mobile: textarea fills its column and scrolls if needed */
    .ids-textarea-wrapper .textarea {
      flex: 1 1 auto;
      min-height: 0;
      height: 100%;
      resize: none;
    }

    /* Make all four buttons share equal height and match textarea height
       (within the right column). */
    .ids-actions {
      gap: var(--space-2);
    }

    .ids-actions .btn {
      flex: 1 1 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;         /* allow flex to shrink evenly */
    }

    /* MOBILE-only: tighten the 3 gaps on the EntryIDs card */
    .ids-header {
      /* A) Pull ‚ÄúManager EntryIDs (n) + info‚Äù closer to the card top */
      margin-top: clamp(-8px, -1.6vw, -4px);
      margin-bottom: clamp(4px, 1.2vw, 8px);
    }

    .ids-layout {
      /* C) Bring textarea bottom closer to top of the buttons block */
      gap: clamp(8px, 2.2vw, 14px);
    }

    .ids-actions {
      gap: clamp(8px, 2.2vw, 12px);
    }

    /* Remove the reserved gap from: <div id="status" style="margin-top: var(--space-3);"></div> */
    #status:empty { display: none; }
    #status { margin-top: clamp(6px, 1.6vw, 12px) !important; }

    /* Make the right-column buttons more compact on mobile (padding/font) */
    .ids-actions .btn {
      min-height: 38px;
      padding: 8px 12px;
      font-size: 0.85rem;
    }

    /* Mobile-only: make the top 3 buttons shorter to reduce total card height */
    #edit-btn,
    #save-btn,
    #featured-open {
      min-height: 32px;
      padding-top: 6px;
      padding-bottom: 6px; 
    }

    /* B) Mobile-only: make the two bottom import buttons taller */
    #league-open,
    #manager-leagues-open {
      min-height: clamp(42px, 10vw, 50px);
      padding-top: clamp(9px, 2.2vw, 12px);
      padding-bottom: clamp(9px, 2.2vw, 12px);
    }

    /* IMPORTANT: these must remain INSIDE the media query */
    #edit-btn { font-size: 0.85rem; }

    .ids-actions .btn--featured,
    .ids-actions .btn--league {
      line-height: 1.1;
      padding-top: 8px;
      padding-bottom: 8px;
    }

    #league-sheet .text-muted code {
      display: inline-block;
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    #league-sheet #league-id-input::placeholder {
      font-size: 0.75em;
    }

    /* Fullscreen Featured managers sheet on mobile (like league sheets) */
    #featured-sheet.top-sheet {
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      height: 100vh;   /* fallback */
      height: 100dvh;  /* better on mobile browsers */
      max-height: 100dvh;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    /* Notch-safe padding */
    #featured-sheet .top-sheetheader {
      padding-top: calc(var(--space-3) + env(safe-area-inset-top));
    }

    #featured-sheet .top-sheetfooter {
      padding-bottom: calc(var(--space-2) + env(safe-area-inset-bottom));
    }

    /* Compact saved leagues rows in the import sheet */
    #league-sheet .featured-item,
    #manager-leagues-sheet .featured-item {
      padding-top: 6px;
      padding-bottom: 6px;
    }

    /* Compact standings rows too */
    #league-standings-sheet .featured-item {
      padding-top: 6px;
      padding-bottom: 6px;
    }

    /* FORCE compact buttons inside ALL top-sheet modals on mobile
       (this overrides Layout.astro's global .btn sizing) */
    #league-sheet .btn,
    #league-standings-sheet .btn,
    #featured-sheet .btn,
    #manager-leagues-sheet .btn {
      min-height: 34px !important;
      padding: 6px 10px !important;
      font-size: 0.85rem !important;
    }

    #manager-leagues-sheet code {
      display: inline-block;
      max-width: 100%;
      overflow-wrap: anywhere;
      word-break: break-all;
    }

    /* FIX: Tighter spacing in league import sheet */
    #league-sheet .control {
      gap: var(--space-1);
      margin-bottom: var(--space-1);
    }

    #league-sheet .input {
      min-height: 36px;
      padding: 6px 10px;
    }

    #league-sheet .text-muted {
      margin-top: 4px !important;
      margin-bottom: 0 !important;
    }
  
    /* Remove the reserved gap when status is empty */
    #league-sheet #league-status:empty {
      display: none;
    }

    /* When it does show, keep it tight */
    #league-sheet #league-status {
      min-height: 0 !important;
      margin: 0 0 var(--space-1) 0 !important;
    }

    /* Fullscreen the two league sheets on mobile */
    #league-sheet.top-sheet,
    #league-standings-sheet.top-sheet,
    #manager-leagues-sheet.top-sheet,
    #manager-history-sheet.top-sheet {
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;

      height: 100vh;    /* fallback */
      height: 100dvh;   /* preferred */
      max-height: 100dvh;

      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    /* Notch / safe-area padding */
    #league-sheet .top-sheet__header,
    #league-standings-sheet .top-sheet__header,
    #manager-leagues-sheet .top-sheet__header {
      padding-top: calc(var(--space-3) + env(safe-area-inset-top));
    }

    #league-sheet .top-sheet__footer,
    #league-standings-sheet .top-sheet__footer,
    #manager-leagues-sheet .top-sheet__footer {
      padding-bottom: calc(var(--space-2) + env(safe-area-inset-bottom));
    }

    /* Saved league name smaller */
    #league-sheet #league-list .featured-item__name {
      font-size: 0.85rem;
      line-height: 1.15;
    }

    #league-sheet #league-list .featured-item__note {
      font-size: 0.8rem;
    }
  }


  /* =========================
     DESKTOP (>= 640px)
     ========================= */
  @media (min-width: 640px) {
    .page {
      align-items: stretch;
    }

    /* Desktop-only: shallower buttons in league sheets (does not affect mobile) */
    #league-sheet .btn,
    #league-standings-sheet .btn {
      min-height: 32px !important;
      padding: 6px 10px !important;
      font-size: 0.85rem !important;
    }

    #auth-check {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
    }

    #auth-check .card {
      width: min(820px, 100%);
      margin-inline: auto;
    }

    /* Responsive two-column layout for the IDs textarea + actions */
    .ids-layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(170px, 220px);
      gap: var(--space-4);
      align-items: stretch;
    }

    .ids-textarea-wrapper {
      width: auto;
      flex-shrink: initial;
    }

    .ids-actions {
      width: auto;
      height: 100%;

      display: grid;
      grid-auto-rows: 1fr;          /* every button row same height */
      gap: 8px;                     /* small, consistent gap (adjust if you want) */
      align-content: stretch;
    }

    /* Make each action button fill its grid row */
    .ids-actions .btn {
      height: 100%;
      width: 100%;
      justify-content: center;
    }

    .top-sheet {
      height: 88vh;
      max-height: 88vh;
      left: 50%;
      right: auto;
      width: min(820px, 96vw);
      transform: translate(-50%, -105%);
      border-left: 1px solid rgba(255, 255, 255, 0.12);
      border-right: 1px solid rgba(255, 255, 255, 0.12);
      border-bottom-left-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
    }

    .top-sheet.is-open {
      transform: translate(-50%, 0);
    }

    /* Desktop-only compact rows inside sheets */
    #featured-sheet .featured-item,
    #league-sheet .featured-item,
    #league-standings-sheet .featured-item,
    #manager-leagues-sheet .featured-item {
      padding-top: 6px;
      padding-bottom: 6px;
      gap: 4px 8px;
      font-size: 0.9em;
    }
  }

  /* =========================
     VERY SMALL PHONES (<= 360px)
     ========================= */
  @media (max-width: 360px) {
    .ids-layout {
      flex-direction: column;
    }

    .ids-textarea-wrapper {
      width: 100%;
    }

    .ids-actions {
      flex-direction: row;
      flex-wrap: wrap;
      width: 100%;
      gap: var(--space-2);
    }

    .ids-actions .btn--full-width {
      flex: 1;
      min-width: 80px;
    }
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'
  import { featuredManagers } from '../data/featuredManagers'
  import { setupManagerLeagueImport } from '../scripts/manager-leagues'

  // =========================
  // Single source of truth
  // =========================
  const MAX_MANAGERS = 50

  const authCheckDiv = document.getElementById('auth-check') as HTMLElement
  const loadingDiv = document.getElementById('loading') as HTMLElement
  const requireLoginDiv = document.getElementById('require-login') as HTMLElement
  const form = document.getElementById('manager-form') as HTMLFormElement
  const textarea = document.getElementById('ids') as HTMLTextAreaElement
  const status = document.getElementById('status') as HTMLElement
  const countEl = document.getElementById('count') as HTMLElement
  const editBtn = document.getElementById('edit-btn') as HTMLButtonElement
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement

  let currentUser: any = null
  let isEditing = false

  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser()

    if (user) {
      currentUser = user
      loadingDiv.style.display = 'none'
      authCheckDiv.style.display = 'block'
      loadManagerIds()
      setupManagerLeagueImport({ supabase, currentUser, loadSavedLeagues })
    } else {
      loadingDiv.style.display = 'none'
      requireLoginDiv.style.display = 'block'
    }
  }

  async function loadManagerIds() {
    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', currentUser.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return
      }

      if (data && data.manager_ids) {
        textarea.value = data.manager_ids.join('\n')
        updateCount()
      } else {
        textarea.value = ''
        updateCount()
      }
    } catch (e) {
      console.error('Error:', e)
    }
  }

  async function saveManagerIds(ids: number[]) {
    try {
      const { data: existing } = await supabase
        .from('user_manager_lists')
        .select('id')
        .eq('user_id', currentUser.id)
        .single()

      if (existing) {
        const { error } = await supabase
          .from('user_manager_lists')
          .update({
            manager_ids: ids,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id)

        if (error) throw error
      } else {
        const { error } = await supabase
          .from('user_manager_lists')
          .insert({
            user_id: currentUser.id,
            manager_ids: ids
          })

        if (error) throw error
      }

      if (ids.length === 0) {
        const { error: cleanupError } = await supabase
          .from('user_league_imports')
          .delete()
          .eq('user_id', currentUser.id)

        if (cleanupError) throw cleanupError
      } else {
        const idsCsv = `(${ids.join(',')})`
        const { error: cleanupError } = await supabase
          .from('user_league_imports')
          .delete()
          .eq('user_id', currentUser.id)
          .not('entry_id', 'in', idsCsv)

        if (cleanupError) throw cleanupError
      }

      return true
    } catch (e) {
      console.error('Error saving manager IDs:', e)
      return false
    }
  }

  function updateCount() {
    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))
    countEl.textContent = String(ids.length)
    if (ids.length > MAX_MANAGERS) {
      countEl.style.color = "var(--color-danger)"
      countEl.textContent = `${ids.length} (max ${MAX_MANAGERS}!)`
    } else {
      countEl.style.color = ids.length > 0 ? "var(--color-success)" : "var(--color-text-muted)"
    }
  }

  function setEditMode(editing: boolean, options: { preserveStatus?: boolean } = {}) {
    isEditing = editing
    textarea.disabled = !editing
    saveBtn.disabled = !editing
    editBtn.textContent = editing ? '‚ùå Cancel' : '‚úèÔ∏è Edit'

    if (!editing) {
      loadManagerIds()
      if (!options.preserveStatus) {
        status.innerHTML = ''
      }
    }
  }
  editBtn.addEventListener('click', () => {
    setEditMode(!isEditing)
  })

  textarea.addEventListener('input', updateCount)

  form.onsubmit = async (e) => {
    e.preventDefault()

    if (!isEditing) return

    const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/))

    if (ids.length === 0) {
      status.innerHTML = "<p class='status status--error'>‚ö†Ô∏è Enter at least one valid EntryID.</p>"
      return
    }

    if (ids.length > MAX_MANAGERS) {
      status.innerHTML = `<p class='status status--error'>‚ö†Ô∏è Maximum ${MAX_MANAGERS} managers allowed.</p>`
      return
    }

    const uniqueIds = [...new Set(ids)].map(id => parseInt(id))

    const success = await saveManagerIds(uniqueIds)

    if (success) {
      let msg = `<p class='status status--success'>‚úÖ Saved ${uniqueIds.length} manager IDs!</p>`

      if (uniqueIds.length !== ids.length) {
        textarea.value = uniqueIds.join('\n')
        updateCount()
        msg += `<p class='status status--warning' style='margin-top: var(--space-2);'>Removed ${ids.length - uniqueIds.length} duplicate(s).</p>`
      }
      status.innerHTML = msg
      setEditMode(false)
    } else {
      status.innerHTML = "<p class='status status--error'>‚ùå Error saving. Please try again.</p>"
    }
  }

  // =========================
  // Featured managers top sheet
  // =========================
  const featuredOpenBtn = document.getElementById('featured-open') as HTMLButtonElement
  const featuredSheet = document.getElementById('featured-sheet') as HTMLElement
  const featuredCloseBtn = document.getElementById('featured-close') as HTMLButtonElement
  const featuredListEl = document.getElementById('featured-list') as HTMLElement
  const featuredSearchInput = document.getElementById('featured-search') as HTMLInputElement
  const featuredApplyBtn = document.getElementById('featured-apply') as HTMLButtonElement
  const featuredClearBtn = document.getElementById('featured-clear') as HTMLButtonElement
  const featuredStatusEl = document.getElementById('featured-status') as HTMLElement
  const featuredDeltaEl = document.getElementById('featured-delta') as HTMLElement
  const managerHistorySheet = document.getElementById('manager-history-sheet') as HTMLElement
  const managerHistoryCloseBtn = document.getElementById('manager-history-close') as HTMLButtonElement
  const managerHistoryTitleEl = document.getElementById('manager-history-title') as HTMLElement
  const managerHistoryStatusEl = document.getElementById('manager-history-status') as HTMLElement
  const managerHistoryListEl = document.getElementById('manager-history-list') as HTMLElement
  const managerHistorySummaryEl = document.getElementById('manager-history-summary') as HTMLElement

  const selectedFeaturedIds = new Set<number>()
  
  const featuredEntryIds = new Set<number>(featuredManagers.map((m) => Number(m.entryId)))

  function syncSelectedFeaturedIdsFromDom() {
    const next = new Set<number>()
    featuredListEl
      .querySelectorAll<HTMLInputElement>('input.featured-check')
      .forEach((cb) => {
        const entryId = Number(cb.dataset.id)
        if (!Number.isFinite(entryId)) return
        if (cb.checked) next.add(entryId)
      })
    selectedFeaturedIds.clear()
    next.forEach((id) => selectedFeaturedIds.add(id))
  }

  function openFeaturedSheet() {
    featuredSheet.classList.add('is-open')
    featuredSheet.setAttribute('aria-hidden', 'false')
  }

  function closeFeaturedSheet() {
    featuredSheet.classList.remove('is-open')
    featuredSheet.setAttribute('aria-hidden', 'true')
  }

  function escapeHtml(s: string) {
    return s.replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&': return '&amp;'
        case '<': return '&lt;'
        case '>': return '&gt;'
        case '"': return '&quot;'
        case "'": return '&#39;'
        default: return ch
      }
    })
  }

  function openManagerHistorySheet() {
    managerHistorySheet.classList.add('is-open')
    managerHistorySheet.setAttribute('aria-hidden', 'false')
  }

  function closeManagerHistorySheet() {
    managerHistorySheet.classList.remove('is-open')
    managerHistorySheet.setAttribute('aria-hidden', 'true')
  }

  function formatHistoryNumber(value: number | null | undefined) {
    if (!Number.isFinite(Number(value))) return '‚Äî'
    return new Intl.NumberFormat('en-GB').format(Number(value))
  }

  async function loadManagerHistory(entryId: number, name: string) {
    managerHistoryTitleEl.textContent = `${name} ‚Äî Season history`
    managerHistoryStatusEl.textContent = 'Loading history...'
    managerHistoryListEl.innerHTML = ''
    openManagerHistorySheet()

    try {
      const res = await fetch(`/api/fpl/entry/${entryId}/history`)
      if (!res.ok) throw new Error('History fetch failed')
      const data = await res.json()
      const past = Array.isArray(data?.past) ? data.past : []

      if (past.length === 0) {
        managerHistoryStatusEl.textContent = 'No season history found.'
        managerHistorySummaryEl.textContent = ''
        return
      }

      const sortedPast = [...past].sort((a: any, b: any) => {
        const ay = Number(String(a?.season_name ?? '').slice(0, 4)) || 0
        const by = Number(String(b?.season_name ?? '').slice(0, 4)) || 0
        return by - ay
      })

      function avgRankForLast(n: number) {
        const ranks = sortedPast.slice(0, n)
          .map((row: any) => Number(row?.rank))
          .filter((r: number) => Number.isFinite(r))
        if (ranks.length === 0) return '‚Äî'
        const avg = Math.round(ranks.reduce((sum, r) => sum + r, 0) / ranks.length)
        return formatHistoryNumber(avg)
      }

      const avg3 = avgRankForLast(3)
      const avg5 = avgRankForLast(5)

      managerHistorySummaryEl.innerHTML = `
        <div>Avg rank (last 3 seasons): <strong>${avg3}</strong></div>
        <div>Avg rank (last 5 seasons): <strong>${avg5}</strong></div>
      `

      managerHistoryStatusEl.textContent = ''
      managerHistoryListEl.innerHTML = sortedPast.map((row: any) => {
        const season = escapeHtml(String(row?.season_name ?? 'Unknown season'))
        const points = formatHistoryNumber(row?.total_points)
        const rank = formatHistoryNumber(row?.rank)

        return `
          <div class="manager-history-row">
            <div class="manager-history-col manager-history-col--season">${season}</div>
            <div class="manager-history-col manager-history-col--points">${points} pts</div>
            <div class="manager-history-col manager-history-col--rank">Rank ${rank}</div>
          </div>
        `
      }).join('')

    } catch (e) {
      console.error(e)
      managerHistoryStatusEl.textContent = 'Failed to load history. Please try again.'
    }
  }

  function parseTextareaIds(): number[] {
    const trimmed = textarea.value.trim()
    if (!trimmed) return []
    return trimmed
      .split(/[\s,]+/)
      .filter(x => x.match(/^\d+$/))
      .map(x => parseInt(x, 10))
  }

  // Manager Sources Sheet
  const managerSourcesOpenBtn = document.getElementById('manager-sources-open') as HTMLButtonElement
  const managerSourcesSheet = document.getElementById('manager-sources-sheet') as HTMLElement
  const managerSourcesCloseBtn = document.getElementById('manager-sources-close') as HTMLButtonElement
  const managerSourcesSearchInput = document.getElementById('manager-sources-search') as HTMLInputElement
  const managerSourcesListEl = document.getElementById('manager-sources-list') as HTMLElement

  type ManagerSourceInfo = {
    entryId: number
    name: string
    source: string
  }

  let allManagerSources: ManagerSourceInfo[] = []

  function openManagerSourcesSheet() {
    managerSourcesSheet.classList.add('is-open')
    managerSourcesSheet.setAttribute('aria-hidden', 'false')
  }

  function closeManagerSourcesSheet() {
    managerSourcesSheet.classList.remove('is-open')
    managerSourcesSheet.setAttribute('aria-hidden', 'true')
  }

  async function fetchManagerName(entryId: number): Promise<string> {
    try {
      const res = await fetch(`/api/fpl/entry/${entryId}/`)
      if (!res.ok) throw new Error('Entry lookup failed')
      const data = await res.json()
      const first = data?.player_first_name ?? ''
      const last = data?.player_last_name ?? ''
      const name = `${first} ${last}`.trim()
      return name || `Manager ${entryId}`
    } catch {
      return `Manager ${entryId}`
    }
  }

  async function fetchManagerImportSource(entryId: number): Promise<string> {
    // Check if it's a featured manager
    const isFeatured = featuredEntryIds.has(entryId)
    
    // Check if imported from a league
    const { data, error } = await supabase
      .from('user_league_imports')
      .select('league_id')
      .eq('user_id', currentUser.id)
      .eq('entry_id', entryId)
      .maybeSingle()

    if (!error && data?.league_id) {
      const leagueId = Number(data.league_id)
      const { data: leagueData } = await supabase
        .from('user_saved_leagues')
        .select('league_name')
        .eq('user_id', currentUser.id)
        .eq('league_id', leagueId)
        .maybeSingle()

      if (leagueData?.league_name) {
        return `Imported from: ${leagueData.league_name}`
      }

      return `Imported from: League ${leagueId}`
    }

    // If not from a league, check if featured
    if (isFeatured) {
      return 'Added from: Featured managers'
    }

    return 'Manually added'
  }

  async function loadManagerSources() {
    const ids = parseTextareaIds()
    if (ids.length === 0) {
      allManagerSources = []
      renderManagerSourcesList()
      return
    }

    managerSourcesListEl.innerHTML = `<div class="text-muted">Loading ${ids.length} managers...</div>`

    const results = await Promise.all(
      ids.map(async (entryId) => {
        const [name, source] = await Promise.all([
          fetchManagerName(entryId),
          fetchManagerImportSource(entryId)
        ])
        return { entryId, name, source }
      })
    )

    allManagerSources = results
    renderManagerSourcesList()
  }

  function renderManagerSourcesList() {
    const query = managerSourcesSearchInput?.value?.trim().toLowerCase() || ''

    const filtered = query
      ? allManagerSources.filter((m) => {
          const idStr = String(m.entryId).toLowerCase()
          const name = m.name.toLowerCase()
          const source = m.source.toLowerCase()
          return idStr.includes(query) || name.includes(query) || source.includes(query)
        })
      : allManagerSources

    if (filtered.length === 0) {
      managerSourcesListEl.innerHTML = `<div class="text-muted">No managers found</div>`
      return
    }

    managerSourcesListEl.innerHTML = filtered
      .map((m) => `
        <div class="manager-source-item">
          <div class="manager-source-item__header">
            <span class="manager-source-item__name">${escapeHtml(m.name)}</span>
            <span class="manager-source-item__id">${m.entryId}</span>
          </div>
          <div class="manager-source-item__footer">
            <span class="manager-source-item__source">${escapeHtml(m.source)}</span>
            <button type="button" class="manager-source-item__delete" data-entry-id="${m.entryId}" title="Remove manager">üóëÔ∏è</button>
          </div>
        </div>
      `)
      .join('')

    // Attach delete handlers
    managerSourcesListEl
      .querySelectorAll<HTMLButtonElement>('.manager-source-item__delete')
      .forEach((btn) => {
        btn.addEventListener('click', async () => {
          const entryId = Number(btn.dataset.entryId)
          if (!Number.isFinite(entryId)) return
          
          if (!confirm(`Remove manager ${entryId} from your list?`)) return

          // Remove from textarea
          const currentIds = parseTextareaIds()
          const updatedIds = currentIds.filter(id => id !== entryId)
          textarea.value = updatedIds.join('\n')
          
          // Save to database
          const success = await saveManagerIds(updatedIds)
          if (success) {
            updateCount()
            // Reload the sources list
            await loadManagerSources()
          } else {
            alert('Failed to remove manager. Please try again.')
          }
        })
      })
  }

  managerSourcesOpenBtn?.addEventListener('click', () => {
    managerSourcesSearchInput.value = ''
    openManagerSourcesSheet()
    loadManagerSources()
  })

  managerSourcesCloseBtn?.addEventListener('click', () => {
    closeManagerSourcesSheet()
  })

  managerSourcesSearchInput?.addEventListener('input', () => {
    renderManagerSourcesList()
  })

  function updateFeaturedActions() {
    const current = new Set(parseTextareaIds())
    const toRemove = [...featuredEntryIds].filter((id) => current.has(id) && !selectedFeaturedIds.has(id))
    const toAdd = [...selectedFeaturedIds].filter((id) => !current.has(id))
    const hasDelta = toRemove.length > 0 || toAdd.length > 0

    featuredApplyBtn.disabled = !hasDelta
    featuredApplyBtn.textContent = 'Apply changes'

    featuredDeltaEl.textContent = hasDelta
      ? `${toAdd.length} add ‚Ä¢ ${toRemove.length} remove`
      : ''
  }

  function renderFeaturedList() {
    const query = featuredSearchInput?.value?.trim().toLowerCase() || ''

    const filtered = query
      ? featuredManagers.filter((m) => {
          const name = String(m.name ?? '').toLowerCase()
          const note = String(m.note ?? '').toLowerCase()
          const entryId = String(m.entryId ?? '').toLowerCase()
          return name.includes(query) || note.includes(query) || entryId.includes(query)
        })
      : featuredManagers

    featuredListEl.innerHTML = filtered.map((m) => {
      const safeName = escapeHtml(String(m.name ?? ''))
      const safeNote = m.note ? escapeHtml(String(m.note)) : ''
      const entryId = Number(m.entryId)
      const checked = selectedFeaturedIds.has(entryId) ? 'checked' : ''

      return `
        <label class="featured-item">
          <input type="checkbox" class="featured-check" data-id="${entryId}" ${checked} />
          <button
            type="button"
            class="featured-item__name featured-item__name-button"
            data-entry-id="${entryId}"
            data-name="${safeName}"
          >
            ${safeName}
          </button>
          ${safeNote ? `<span class="featured-item__note">‚Äî ${safeNote}</span>` : ``}
          <span class="featured-item__id">${safeNote ? `‚Äî ` : ``}<code>${entryId}</code></span>
        </label>
      `

    }).join('')

    featuredListEl.querySelectorAll<HTMLInputElement>('input.featured-check').forEach((cb) => {
      cb.addEventListener('change', () => {
        const id = parseInt(cb.dataset.id || '', 10)
        if (!Number.isFinite(id)) return

        if (cb.checked) selectedFeaturedIds.add(id)
        else selectedFeaturedIds.delete(id)

        updateFeaturedActions()
      })
    })

    featuredListEl.querySelectorAll<HTMLButtonElement>('button.featured-item__name-button').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        event.preventDefault()
        event.stopPropagation()

        const entryId = Number(btn.dataset.entryId)
        if (!Number.isFinite(entryId)) return

        const managerName = btn.dataset.name ? String(btn.dataset.name) : `Manager ${entryId}`
        loadManagerHistory(entryId, managerName)
      })
    })
  }

  function clearFeaturedSelection() {
    selectedFeaturedIds.clear()
    featuredListEl.querySelectorAll<HTMLInputElement>('input.featured-check').forEach(cb => { cb.checked = false })
    updateFeaturedActions()
  }

  featuredOpenBtn?.addEventListener('click', () => {
    selectedFeaturedIds.clear()
    const current = new Set(parseTextareaIds())
    featuredEntryIds.forEach((id) => {
      if (current.has(id)) selectedFeaturedIds.add(id)
    })

    renderFeaturedList()
    featuredStatusEl.textContent = ''
    openFeaturedSheet()
    updateFeaturedActions()
  })

  featuredCloseBtn?.addEventListener('click', () => closeFeaturedSheet())
  managerHistoryCloseBtn?.addEventListener('click', () => closeManagerHistorySheet())

  featuredClearBtn?.addEventListener('click', () => {
    featuredStatusEl.textContent = ''
    clearFeaturedSelection()
  })

  featuredSearchInput?.addEventListener('input', () => {
    renderFeaturedList()
  })

  featuredApplyBtn?.addEventListener('click', async () => {
    syncSelectedFeaturedIdsFromDom()

    if (!isEditing) setEditMode(true)

    const current = new Set(parseTextareaIds())
    const toRemove = [...featuredEntryIds].filter((id) => current.has(id) && !selectedFeaturedIds.has(id))
    const toAdd = [...selectedFeaturedIds].filter((id) => !current.has(id))

    const next = new Set<number>(current)
    toRemove.forEach((id) => next.delete(id))
    toAdd.forEach((id) => next.add(id))

    if (next.size > MAX_MANAGERS) {
      const msg = `‚ùå Too many managers. Limit is ${MAX_MANAGERS}.`
      featuredStatusEl.textContent = msg
      featuredDeltaEl.textContent = ''
      status.innerHTML = `<p class='status status--error'>${msg}</p>`
      return
    }

    textarea.value = Array.from(next).join('\n') + '\n'
    updateCount()

    const saved = await saveManagerIds(Array.from(next))
    if (!saved) {
      const msg = '‚ùå Failed to save changes. Please try again.'
      featuredStatusEl.textContent = msg
      status.innerHTML = `<p class='status status--error'>${msg}</p>`
      return
    }

    setEditMode(false, { preserveStatus: true })

    let msg = ''
    if (toAdd.length > 0 && toRemove.length > 0) {
      msg = `‚úÖ ${toAdd.length} added, ${toRemove.length} removed. Changes saved.`
    } else if (toAdd.length > 0) {
      msg = `‚úÖ ${toAdd.length} added. Changes saved.`
    } else if (toRemove.length > 0) {
      msg = `‚úÖ ${toRemove.length} removed. Changes saved.`
    } else {
      msg = 'No changes to apply.'
    }

    featuredStatusEl.textContent = msg
    status.innerHTML = `<p class='status ${msg.startsWith('‚úÖ') ? 'status--success' : 'status--warning'}'>${msg}</p>`

    updateFeaturedActions()
  })
  updateFeaturedActions()

  // =========================
  // League import
  // =========================

  const leagueOpenBtn = document.getElementById('league-open') as HTMLButtonElement
  const leagueSheet = document.getElementById('league-sheet') as HTMLElement
  const leagueCloseBtn = document.getElementById('league-close') as HTMLButtonElement
  const leagueIdInput = document.getElementById('league-id-input') as HTMLInputElement
  const leagueSaveBtn = document.getElementById('league-save') as HTMLButtonElement
  const leagueRefreshBtn = document.getElementById('league-refresh') as HTMLButtonElement
  const leagueStatusEl = document.getElementById('league-status') as HTMLElement
  const leagueListEl = document.getElementById('league-list') as HTMLElement

  const standingsSheet = document.getElementById('league-standings-sheet') as HTMLElement
  const standingsCloseBtn = document.getElementById('league-standings-close') as HTMLButtonElement
  const standingsTitleEl = document.getElementById('league-standings-title') as HTMLElement
  const standingsSubtitleEl = document.getElementById('league-standings-subtitle') as HTMLElement
  const standingsBannerEl = document.getElementById('league-standings-banner') as HTMLElement
  const standingsListEl = document.getElementById('league-standings-list') as HTMLElement
  const leagueSearchInput = document.getElementById('league-search') as HTMLInputElement
  const applyStatusEl = document.getElementById('league-apply-status') as HTMLElement
  const applySuccessEl = document.getElementById('league-apply-success') as HTMLElement
  const selectNoneBtn = document.getElementById('league-select-none') as HTMLButtonElement
  const applyBtn = document.getElementById('league-apply') as HTMLButtonElement

  type SavedLeague = { league_id: number; league_name: string | null }
  type StandingRow = { rank: number; entryId: number; entryName: string; playerName?: string | null }

  let activeLeague: { id: number; name: string | null } | null = null
  let activeStandings: StandingRow[] = []
  let activeSelectedEntryIds = new Set<number>()
  let previouslyImportedForActiveLeague = new Set<number>()
  let standingsSearchQuery = ''

  function syncActiveSelectedEntryIdsFromDom() {
    const next = new Set<number>()
    standingsListEl
      .querySelectorAll<HTMLInputElement>('input.league-check')
      .forEach((cb) => {
        const entryId = Number(cb.dataset.entryId)
        if (!Number.isFinite(entryId)) return
        if (cb.checked) next.add(entryId)
      })
    activeSelectedEntryIds = next
  }

  function openLeagueSheet() {
    leagueSheet.classList.add('is-open')
    leagueSheet.setAttribute('aria-hidden', 'false')
  }
  function closeLeagueSheet() {
    leagueSheet.classList.remove('is-open')
    leagueSheet.setAttribute('aria-hidden', 'true')
  }
  function openStandingsSheet() {
    standingsSheet.classList.add('is-open')
    standingsSheet.setAttribute('aria-hidden', 'false')
  }
  function closeStandingsSheet() {
    standingsSheet.classList.remove('is-open')
    standingsSheet.setAttribute('aria-hidden', 'true')
  }

  async function fetchLeagueMeta(leagueId: number) {
    const res = await fetch(`/api/fpl/league/${leagueId}`)
    if (!res.ok) throw new Error('League lookup failed')
    return await res.json() as { leagueId: number; leagueName: string | null }
  }

  async function fetchAllStandingsClassic(leagueId: number): Promise<{ leagueName: string | null; rows: StandingRow[] }> {
    let page = 1
    let all: StandingRow[] = []
    let leagueName: string | null = null

    while (true) {
      const res = await fetch(`/api/fpl/league/${leagueId}/standings?page=${page}`)
      if (!res.ok) throw new Error('Standings fetch failed')
      const data = await res.json() as any
      leagueName = leagueName ?? data?.league?.name ?? null
      const results = Array.isArray(data?.results) ? data.results : []
      all = all.concat(results)
      if (!data?.hasNext) break
      page++
      if (page > 50) break
    }

    all.sort((a, b) => a.rank - b.rank)
    return { leagueName, rows: all }
  }

  async function loadSavedLeagues() {
    leagueListEl.innerHTML = ''
    leagueStatusEl.textContent = ''

    const { data, error } = await supabase
      .from('user_saved_leagues')
      .select('league_id, league_name')
      .eq('user_id', currentUser.id)
      .order('updated_at', { ascending: false })

    if (error) {
      console.error(error)
      leagueStatusEl.textContent = 'Error loading saved leagues.'
      return
    }

    const leagues: SavedLeague[] = (data || []).map((x: any) => ({
      league_id: Number(x.league_id),
      league_name: x.league_name ? String(x.league_name) : null,
    }))

    if (leagues.length === 0) {
      leagueListEl.innerHTML = `<div class="text-muted">No saved leagues yet.</div>`
      return
    }

    leagueListEl.innerHTML = leagues.map((l) => {
      const name = l.league_name ? escapeHtml(l.league_name) : `League ${l.league_id}`
      return `
        <div class="featured-item saved-league-card">
          <div class="saved-league-title">
            <span class="featured-item__name">${name}</span>
            <span class="featured-item__note">‚Äî ID: <code>${l.league_id}</code></span>
          </div>

          <div class="saved-league-actions">
            <button type="button" class="btn btn--neutral" data-action="open" data-league-id="${l.league_id}">Open</button>
            <button type="button" class="btn btn--neutral" data-action="remove" data-league-id="${l.league_id}">Remove</button>
         </div>
        </div>

      `
    }).join('')

    leagueListEl.querySelectorAll<HTMLButtonElement>('button[data-action="open"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const leagueId = Number(btn.dataset.leagueId)
        await openLeagueStandings(leagueId)
      })
    })

    leagueListEl.querySelectorAll<HTMLButtonElement>('button[data-action="remove"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const leagueId = Number(btn.dataset.leagueId)
        const ok = confirm(`Remove league ${leagueId}? (This does not change your manager list yet.)`)
        if (!ok) return
        const { error } = await supabase
          .from('user_saved_leagues')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('league_id', leagueId)
        if (error) {
          console.error(error)
          leagueStatusEl.textContent = 'Failed to remove league.'
          return
        }
        await supabase
          .from('user_league_imports')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('league_id', leagueId)

        await loadSavedLeagues()
      })
    })
  }

  function parseLeagueIdFromInput(raw: string): number | null {
    const s = (raw ?? "").trim();
    if (!s) return null;

    if (/^\d+$/.test(s)) return Number(s);

    const m = s.match(/\/leagues\/(\d+)(?:\/|$)/i);
    if (m?.[1]) return Number(m[1]);

    const n = s.match(/\b(\d{3,})\b/);
    if (n?.[1]) return Number(n[1]);

    return null;
  }

  async function saveLeagueById() {
    leagueStatusEl.textContent = ''

    const leagueId = parseLeagueIdFromInput(leagueIdInput.value)
    if (!leagueId || !Number.isFinite(leagueId)) {
     leagueStatusEl.textContent = 'Paste a League ID (number) or league URL.'
     return
    }

    leagueSaveBtn.disabled = true
    try {
      const meta = await fetchLeagueMeta(leagueId)

      const { error } = await supabase
        .from('user_saved_leagues')
        .upsert({
          user_id: currentUser.id,
          league_id: leagueId,
          league_name: meta.leagueName,
          updated_at: new Date().toISOString(),
        }, { onConflict: 'user_id,league_id' })

      if (error) throw error

      leagueStatusEl.textContent = `Saved: ${meta.leagueName || `League ${leagueId}`}`
      leagueIdInput.value = ''
      await loadSavedLeagues()
    } catch (e) {
      console.error(e)
      leagueStatusEl.textContent = 'Could not save. Check the league ID/URL and try again.'
    } finally {
      leagueSaveBtn.disabled = false
    }
  }

  async function loadPreviouslyImportedForLeague(leagueId: number) {
    const { data, error } = await supabase
      .from('user_league_imports')
      .select('entry_id')
      .eq('user_id', currentUser.id)
      .eq('league_id', leagueId)

    if (error) {
      console.error(error)
      return new Set<number>()
    }

    return new Set<number>((data || []).map((r: any) => Number(r.entry_id)))
  }

  async function leagueNamesByIds(leagueIds: number[]) {
    if (leagueIds.length === 0) return new Map<number, string>()
    const { data, error } = await supabase
      .from('user_saved_leagues')
      .select('league_id, league_name')
      .eq('user_id', currentUser.id)
      .in('league_id', leagueIds)

    if (error) {
      console.error(error)
      return new Map<number, string>()
    }

    const m = new Map<number, string>()
    for (const row of (data || []) as any[]) {
      m.set(Number(row.league_id), row.league_name ? String(row.league_name) : `League ${row.league_id}`)
    }
    return m
  }

  async function loadCrossLeagueInfoForEntries(entryIds: number[], excludeLeagueId: number) {
    const { data, error } = await supabase
      .from('user_league_imports')
      .select('entry_id, league_id')
      .eq('user_id', currentUser.id)
      .in('entry_id', entryIds)

    if (error) {
      console.error(error)
      return new Map<number, number[]>()
    }

    const map = new Map<number, number[]>()
    for (const row of (data || []) as any[]) {
      const entryId = Number(row.entry_id)
      const leagueId = Number(row.league_id)
      if (leagueId === excludeLeagueId) continue
      const arr = map.get(entryId) || []
      arr.push(leagueId)
      map.set(entryId, arr)
    }
    return map
  }

  function renderStandingsList() {
    const q = (standingsSearchQuery || '').trim().toLowerCase()

    const filtered = !q
      ? activeStandings
      : activeStandings.filter((r) => {
          const entryName = (r.entryName || '').toLowerCase()
          const playerName = (r.playerName || '').toLowerCase()
          const entryIdStr = String(r.entryId)
          return (
            entryName.includes(q) ||
            playerName.includes(q) ||
            entryIdStr.includes(q)
          )
        })

    standingsListEl.innerHTML = filtered.map((r) => {
      const checked = activeSelectedEntryIds.has(r.entryId) ? 'checked' : ''
      const safeEntryName = escapeHtml(r.entryName || '')
      const safePlayerName = r.playerName ? escapeHtml(r.playerName) : ''
      return `
        <label class="featured-item">
          <input type="checkbox" class="league-check" data-entry-id="${r.entryId}" ${checked} />
          <span class="featured-item__name">${safeEntryName}</span>
          ${safePlayerName ? `<span class="featured-item__note">‚Äî ${safePlayerName}</span>` : ``}
          <span class="featured-item__id"><code>${r.entryId}</code></span>
        </label>
    `
    }).join('')

    standingsListEl.querySelectorAll<HTMLInputElement>('input.league-check').forEach((cb) => {
      cb.addEventListener('change', async () => {
        const entryId = Number(cb.dataset.entryId)
        if (!Number.isFinite(entryId)) return

        if (cb.checked) activeSelectedEntryIds.add(entryId)
        else activeSelectedEntryIds.delete(entryId)

        await updateStandingsBannerAndWarnings()
      })
    })
  }

  async function updateStandingsBannerAndWarnings() {
    syncActiveSelectedEntryIdsFromDom()
    const currentManagerIds = new Set<number>(parseTextareaIds())

    const selected = [...activeSelectedEntryIds]
    const selectedCount = selected.length

    const leagueEntryIdSet = new Set<number>(activeStandings.map((r) => r.entryId))
    const toRemove = [...leagueEntryIdSet]
      .filter((id) => currentManagerIds.has(id) && !activeSelectedEntryIds.has(id))
    const toAdd = selected.filter((id) => !currentManagerIds.has(id))

    const totalAfter = currentManagerIds.size - toRemove.filter((id) => currentManagerIds.has(id)).length + toAdd.length
    const remaining = MAX_MANAGERS - totalAfter

    const hasDelta = (toRemove.length > 0) || (toAdd.length > 0)
    applyBtn.disabled = !hasDelta

    const allRelevant = Array.from(new Set([...toRemove, ...toAdd]))
    const crossLeagueIdsMap = await loadCrossLeagueInfoForEntries(allRelevant, activeLeague!.id)
    const otherLeagueIds = Array.from(new Set(Array.from(crossLeagueIdsMap.values()).flat()))
    const namesMap = await leagueNamesByIds(otherLeagueIds)

    const lines: string[] = []
    lines.push(`Selected in this league: ${selectedCount}`)
    lines.push(`Total after apply: ${totalAfter} / ${MAX_MANAGERS}`)
    lines.push(`Remaining slots after apply: ${remaining}`)

    const warnLines: string[] = []

    for (const id of toAdd) {
      const other = crossLeagueIdsMap.get(id) || []
      if (other.length > 0) {
        const leagues = other.map((lid) => namesMap.get(lid) || `League ${lid}`).join(', ')
        warnLines.push(`‚ö†Ô∏è EntryID ${id} is already selected in: ${leagues}.`)
      }
    }

    for (const id of toRemove) {
      const other = crossLeagueIdsMap.get(id) || []
      if (other.length > 0) {
        const leagues = other.map((lid) => namesMap.get(lid) || `League ${lid}`).join(', ')
        warnLines.push(`‚ö†Ô∏è EntryID ${id} is also selected in: ${leagues}. Unticking here will remove it from your manager list entirely.`)
      }
    }

    standingsBannerEl.innerHTML = lines.join(' ‚Ä¢ ')
    applyStatusEl.textContent = warnLines.join(' ')
  }

  async function openLeagueStandings(leagueId: number) {
    openStandingsSheet()
    applyStatusEl.textContent = ''
    applySuccessEl.textContent = ''
    standingsBannerEl.innerHTML = '<div class="loading-spinner"></div> Loading league standings...'
    standingsListEl.innerHTML = ''
    applyBtn.disabled = true

    closeLeagueSheet()

    try {
      const standings = await fetchAllStandingsClassic(leagueId)
      activeLeague = { id: leagueId, name: standings.leagueName }

      await supabase
        .from('user_saved_leagues')
        .upsert({
          user_id: currentUser.id,
          league_id: leagueId,
          league_name: standings.leagueName,
          updated_at: new Date().toISOString(),
        }, { onConflict: 'user_id,league_id' })

      activeStandings = standings.rows

      standingsSearchQuery = ''
      if (leagueSearchInput) leagueSearchInput.value = ''

      previouslyImportedForActiveLeague = await loadPreviouslyImportedForLeague(leagueId)

      // Build a set of all EntryIDs in this league standings
      const leagueEntryIdSet = new Set<number>(activeStandings.map((r) => r.entryId))

      // Your current saved managers (manual + featured + any previous imports)
      const currentManagerIdSet = new Set<number>(parseTextareaIds())

      // Find managers you already have that are in this league
      const matchesFromCurrentList = new Set<number>()
      for (const id of currentManagerIdSet) {
        if (leagueEntryIdSet.has(id)) matchesFromCurrentList.add(id)
      }

      // Auto-select: union(previouslyImportedForActiveLeague, matchesFromCurrentList)
      activeSelectedEntryIds = new Set<number>([
        ...previouslyImportedForActiveLeague,
        ...matchesFromCurrentList,
      ])

      standingsTitleEl.textContent = standings.leagueName ? standings.leagueName : `League ${leagueId}`
      standingsSubtitleEl.textContent = `Tick/untick manager(s), then 'Apply changes'.`

      renderStandingsList()
      openStandingsSheet()
      await updateStandingsBannerAndWarnings()
    } catch (e) {
      console.error(e)
      standingsBannerEl.innerHTML = 'Failed to load standings. Check league ID and try again.'
      openStandingsSheet()
    }
  }

  async function applyLeagueChanges() {
    if (!activeLeague) return

    applyBtn.disabled = true
    selectNoneBtn.disabled = true

    try {
      if (!isEditing) setEditMode(true)

      // clear any old main-page message
      status.innerHTML = ''
      applySuccessEl.textContent = ''
      syncActiveSelectedEntryIdsFromDom()

      const current = new Set<number>(parseTextareaIds())

      const leagueEntryIdSet = new Set<number>(activeStandings.map((r) => r.entryId))
      const toRemove = [...leagueEntryIdSet]
        .filter((id) => current.has(id) && !activeSelectedEntryIds.has(id))
      const toAdd = [...activeSelectedEntryIds].filter((id) => !current.has(id))

      const next = new Set<number>(current)
      for (const id of toRemove) next.delete(id)
      for (const id of toAdd) next.add(id)

      if (next.size > MAX_MANAGERS) {
        const msg = `‚ùå Too many managers. Limit is ${MAX_MANAGERS}. Reduce your selection.`
        applyStatusEl.textContent = msg
        status.innerHTML = `<p class='status status--error'>${msg}</p>`
        return
      }

      // Update textarea (local) first
      textarea.value = Array.from(next).join('\n') + '\n'
      updateCount()

      // Update import mapping table to reflect current selection for this league
      if (toRemove.length > 0) {
        const { error } = await supabase
          .from('user_league_imports')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('league_id', activeLeague.id)
          .in('entry_id', toRemove as any)

        if (error) throw error
      }

      if (activeSelectedEntryIds.size > 0) {
        const lookup = new Map<number, StandingRow>()
        activeStandings.forEach((r) => lookup.set(r.entryId, r))

        const payload = [...activeSelectedEntryIds].map((entryId) => {
          const row = lookup.get(entryId)
          return {
            user_id: currentUser.id,
            league_id: activeLeague!.id,
            entry_id: entryId,
            entry_name: row?.entryName || null,
            rank: row?.rank || null,
            updated_at: new Date().toISOString(),
          }
        })

        const { error } = await supabase
          .from('user_league_imports')
          .upsert(payload, { onConflict: 'user_id,league_id,entry_id' })

        if (error) throw error
      }

      // Sync "previously imported" set to the current selection
      previouslyImportedForActiveLeague = new Set<number>(activeSelectedEntryIds)
      const saved = await saveManagerIds(Array.from(next))
      if (!saved) throw new Error('Save failed')
      setEditMode(false, { preserveStatus: true })

      // Success message (once)
      const removedCount = toRemove.length
      const addedCount = toAdd.length

      let msg = ''
      if (addedCount > 0 && removedCount > 0) {
        msg = `‚úÖ ${addedCount} manager(s) added and ${removedCount} removed. Changes saved.`
      } else if (addedCount > 0) {
        msg = `‚úÖ ${addedCount} manager(s) added to your list. Changes saved.`
      } else if (removedCount > 0) {
        msg = `‚úÖ ${removedCount} manager(s) removed from your list. Changes savded.`
      } else {
        msg = `No changes to apply.`
      }

      applySuccessEl.textContent = msg
      status.innerHTML = `<p class='status ${msg.startsWith('‚úÖ') ? 'status--success' : 'status--warning'}'>${msg}</p>`

      await updateStandingsBannerAndWarnings()
    } catch (e) {
      console.error(e)
      const msg = '‚ùå Failed to apply changes. Please try again.'
      applyStatusEl.textContent = msg
      status.innerHTML = `<p class='status status--error'>${msg}</p>`
    } finally {
      selectNoneBtn.disabled = false
      await updateStandingsBannerAndWarnings()
    }
  }

  leagueOpenBtn?.addEventListener('click', async () => {
    leagueStatusEl.textContent = ''
    openLeagueSheet()
    await loadSavedLeagues()
  })

  leagueCloseBtn?.addEventListener('click', () => closeLeagueSheet())
  leagueRefreshBtn?.addEventListener('click', async () => loadSavedLeagues())
  leagueSaveBtn?.addEventListener('click', async () => saveLeagueById())

  standingsCloseBtn?.addEventListener('click', () => {
    applySuccessEl.textContent = ''
    applyStatusEl.textContent = ''
    closeStandingsSheet()
  })

  leagueSearchInput?.addEventListener('input', () => {
    standingsSearchQuery = leagueSearchInput.value || ''
    renderStandingsList()
  })

  selectNoneBtn?.addEventListener('click', async () => {
    activeSelectedEntryIds.clear()
    standingsListEl.querySelectorAll<HTMLInputElement>('input.league-check').forEach((cb) => (cb.checked = false))
    await updateStandingsBannerAndWarnings()
  })

  applyBtn?.addEventListener('click', async () => {
    syncActiveSelectedEntryIdsFromDom()
    const current = new Set<number>(parseTextareaIds())
    const leagueEntryIdSet = new Set<number>(activeStandings.map((r) => r.entryId))
    const toRemove = [...leagueEntryIdSet]
      .filter((id) => current.has(id) && !activeSelectedEntryIds.has(id))
    if (toRemove.length > 0) {
      const ok = confirm(`Apply changes?\n\nThis will remove ${toRemove.length} manager(s) from your list if unticked here.`)
      if (!ok) return
    }
    await applyLeagueChanges()
  })

  checkAuth()
</script>
