---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Chip Usage Tracker - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">üéØ Chip Usage Tracker üéØ</h1>
      <p class="page-subtitle">Track which managers have used their chips and when.</p>
    </header>

    <div class="meta-row-wide">
      <span id="manager-count" class="badge badge-wide">Loading...</span>
      <a href="/managers" class="badge badge-wide">‚öô Manage IDs</a>
    </div>

    <div class="controls-inline chips-controls">
      <div class="control-inline">
        <label class="label-small" for="manager-filter">Manager</label>
        <select class="select-small" id="manager-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="control-inline">
        <label class="label-small">&nbsp;</label>
        <button id="refresh-btn" class="btn-row" type="button">üîÑ Refresh</button>
      </div>
    </div>

    <div id="loading-status" class="meta-row"></div>

    <section id="chips-output" aria-live="polite"></section>
  </main>

  <!-- Chip Squad Modal -->
  <div id="chip-modal" class="modal">
    <div class="modal-panel">
      <button id="close-chip-modal" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
      <div id="chip-modal-content"></div>
    </div>
  </div>
</Layout>

<style>
  .meta-row-wide {
    display: flex;
    gap: var(--space-2);
  }

  .badge-wide {
    flex: 1;
    justify-content: center;
    padding: var(--space-2) var(--space-3);
    text-align: center;
  }

  .controls-inline {
    display: flex;
    gap: var(--space-2);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
  }

  .control-inline {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .label-small {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-align: center;
  }

  .select-small {
    width: 100%;
    min-height: 32px;
    padding: 6px 8px;
    font-family: inherit;
    font-size: 13px;
    color: var(--color-text);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .select-small:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .btn-row {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
  }

  .btn-row:hover {
    background: var(--color-primary-hover);
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  const out = document.getElementById("chips-output");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");
  const managerFilterSelect = document.getElementById("manager-filter");
  const chipModal = document.getElementById("chip-modal");
  const chipModalContent = document.getElementById("chip-modal-content");
  const closeChipModal = document.getElementById("close-chip-modal");

  let managerIds = [];
  let playerCache = new Map();
  let teamCache = new Map();
  let allManagersData = [];

  // Load token for cancellation
  let currentLoadToken = 0;

  function populateManagerFilter(data) {
    if (!managerFilterSelect) return;

    const prev = managerFilterSelect.value || "";
    managerFilterSelect.innerHTML = `<option value="">All</option>`;

    const managers = data
      .map((m) => ({
        entryId: String(m.entryId ?? ""),
        managerName: String(m.managerName ?? ""),
      }))
      .filter((m) => m.entryId && m.managerName);

    managers.sort((a, b) => a.managerName.localeCompare(b.managerName));

    for (const m of managers) {
      const opt = document.createElement("option");
      opt.value = m.entryId;
      opt.textContent = m.managerName;
      managerFilterSelect.appendChild(opt);
    }

    managerFilterSelect.value = prev;
  }

  function renderChipsTable() {
    const filterId = managerFilterSelect?.value || "";
    const filtered = filterId
      ? allManagersData.filter((m) => String(m.entryId) === filterId)
      : allManagersData;

    if (filtered.length > 0) {
      out.innerHTML = makeChipsTable(filtered);
      attachChipButtons();
    } else {
      out.innerHTML = "<p class='status status--error'>No managers match this filter.</p>";
    }
  }

  closeChipModal.addEventListener("click", () => {
    chipModal.classList.remove("is-open");
  });

  managerFilterSelect?.addEventListener("change", () => {
    renderChipsTable();
  });

  // ==== Persistent cache (localStorage) ====
  const CHIPS_CACHE_KEY = "fpl_cache_v1_chips";
  const CHIPS_CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12h

  function safeJsonParse(v) {
    try { return JSON.parse(v); } catch { return null; }
  }

  function isFresh(savedAt, ttlMs) {
    if (!savedAt) return false;
    return (Date.now() - Number(savedAt)) < ttlMs;
  }

  function saveChipsSnapshot({ managerIds, allData, playerCache, teamCache }) {
    const snapshot = {
      savedAt: Date.now(),
      managerIds: managerIds || [],
      allData: allData || [],
      playerEntries: Array.from(playerCache.entries()),
      teamEntries: Array.from(teamCache.entries()),
    };
    localStorage.setItem(CHIPS_CACHE_KEY, JSON.stringify(snapshot));
  }

  function loadChipsSnapshot() {
    const raw = localStorage.getItem(CHIPS_CACHE_KEY);
    const snap = safeJsonParse(raw);
    if (!snap || !Array.isArray(snap.allData)) return null;

    return {
      savedAt: snap.savedAt,
      managerIds: snap.managerIds || [],
      allData: snap.allData || [],
      playerCache: new Map(snap.playerEntries || []),
      teamCache: new Map(snap.teamEntries || []),
    };
  }

  function sameManagerIds(a, b) {
    return JSON.stringify(a || []) === JSON.stringify(b || []);
  }

  /**
   * Concurrent mapping with limited concurrency
   */
  async function mapWithConcurrency(items, limit, fn, onProgress) {
    const results = [];
    let currentIndex = 0;
    let completed = 0;

    async function worker() {
      while (currentIndex < items.length) {
        const index = currentIndex++;
        const item = items[index];
        try {
          results[index] = await fn(item, index);
        } catch (e) {
          console.error(`Error processing item ${index}:`, e);
          results[index] = null;
        }
        completed++;
        if (onProgress) onProgress(completed, items.length);
      }
    }

    const workers = Array.from({ length: Math.min(limit, items.length) }, () => worker());
    await Promise.all(workers);
    return results;
  }

  async function fetchBootstrapData(cacheBuster) {
    try {
      const url = cacheBuster
        ? `/api/fpl/bootstrap-static?v=${cacheBuster}`
        : `/api/fpl/bootstrap-static`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Failed to fetch bootstrap data");
      const data = await res.json();

      playerCache = new Map();
      teamCache = new Map();

      data.elements.forEach(player => {
        playerCache.set(player.id, {
          name: player.web_name,
          position: player.element_type === 1 ? "GK" :
                    player.element_type === 2 ? "DEF" :
                    player.element_type === 3 ? "MID" : "FWD",
          teamId: player.team
        });
      });

      data.teams.forEach(team => {
        teamCache.set(team.id, team.short_name);
      });

      return data;
    } catch (e) {
      console.error("Error fetching bootstrap data:", e);
      return null;
    }
  }

  async function fetchManagerData(id, cacheBuster) {
    const historyUrl = cacheBuster
      ? `/api/fpl/entry/${id}/history?v=${cacheBuster}`
      : `/api/fpl/entry/${id}/history`;

    const summaryUrl = cacheBuster
      ? `/api/fpl/entry/${id}?v=${cacheBuster}`
      : `/api/fpl/entry/${id}`;

    try {
      const [historyRes, summaryRes] = await Promise.all([
        fetch(historyUrl),
        fetch(summaryUrl)
      ]);

      if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");

      const historyData = await historyRes.json();
      const summaryData = await summaryRes.json();

      const chips = historyData.chips || [];
      const current = historyData.current || [];
      const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;

      const chipsFormatted = chips.map(c => {
        const gwData = current.find(gw => gw.event === c.event);
        const points = gwData ? gwData.points : 0;

        return {
          name: c.name === "wildcard" ? "WC" :
                c.name === "bboost" ? "BB" :
                c.name === "3xc" ? "TC" :
                c.name === "freehit" ? "FH" : c.name,
          gw: c.event,
          points: points
        };
      });

      return {
        entryId: Number(id),
        managerName,
        chips: chipsFormatted
      };
    } catch (e) {
      console.error(`Error fetching manager ${id}:`, e);
      return null;
    }
  }

  async function showChipSquad(managerId, managerName, chipName, gw, points) {
    const chipEmoji = chipName === "WC" ? "üÉè" :
                      chipName === "BB" ? "ü™ë" :
                      chipName === "TC" ? "üëë" :
                      chipName === "FH" ? "üéØ" : "";

    const chipFull = chipName === "WC" ? "Wildcard" :
                     chipName === "BB" ? "Bench Boost" :
                     chipName === "TC" ? "Triple Captain" :
                     chipName === "FH" ? "Free Hit" : chipName;

    chipModalContent.innerHTML = `<p class="text-muted">Loading squad...</p>`;
    chipModal.classList.add("is-open");

    try {
      const [picksRes, liveRes] = await Promise.all([
        fetch(`/api/fpl/entry/${managerId}/event/${gw}/picks`),
        fetch(`/api/fpl/event/${gw}/live`)
      ]);

      if (!picksRes.ok || !liveRes.ok) throw new Error("Failed to fetch data");

      const picksData = await picksRes.json();
      const liveData = await liveRes.json();

      const livePoints = new Map();
      (liveData.elements || []).forEach(el => {
        livePoints.set(el.id, el.stats?.total_points || 0);
      });

      const picks = (picksData.picks || []).map(pick => {
        const player = playerCache.get(pick.element) || { name: "Unknown", position: "?", teamId: 0 };
        const teamName = teamCache.get(player.teamId) || "???";
        const pts = livePoints.get(pick.element) || 0;

        let multiplier = pick.multiplier || 1;
        let displayPts = pts * multiplier;

        return {
          position: pick.position,
          name: player.name,
          posLabel: player.position,
          team: teamName,
          points: displayPts,
          rawPoints: pts,
          multiplier: multiplier,
          isCaptain: pick.is_captain,
          isViceCaptain: pick.is_vice_captain
        };
      }).sort((a, b) => a.position - b.position);

      const starters = picks.filter(p => p.position <= 11);
      const bench = picks.filter(p => p.position > 11);

      let html = `
        <h2 class="modal-title" style="padding-right:40px;">
          ${chipEmoji} ${chipFull}
        </h2>
        <p class="text-muted" style="margin-bottom:var(--space-3);">
          <strong>${managerName}</strong> ¬∑ GW${gw} ¬∑ <span class="text-success font-bold">${points} pts</span>
        </p>

        <div class="chip-squad-section">
          <h3 class="chip-squad-heading">Starting XI</h3>
          <table class="chip-squad-table">
            <thead>
              <tr>
                <th>Player</th>
                <th class="col-team">Team</th>
                <th class="col-pts">Pts</th>
              </tr>
            </thead>
            <tbody>
      `;

      for (const p of starters) {
        const capLabel = p.isCaptain ? '<span class="cap-badge cap-c">C</span>' :
                         p.isViceCaptain ? '<span class="cap-badge cap-v">V</span>' : '';
        const ptsDisplay = p.multiplier > 1 ? `${p.rawPoints}√ó${p.multiplier}=${p.points}` : p.points;

        html += `
          <tr>
            <td class="player-cell">
              <span class="player-pos">${p.posLabel}</span>
              <span class="player-name">${p.name}</span>
              ${capLabel}
            </td>
            <td class="col-team">${p.team}</td>
            <td class="col-pts">${ptsDisplay}</td>
          </tr>
        `;
      }

      html += `
            </tbody>
          </table>
        </div>

        <div class="chip-squad-section">
          <h3 class="chip-squad-heading">Bench</h3>
          <table class="chip-squad-table bench-table">
            <tbody>
      `;

      for (const p of bench) {
        const ptsDisplay = chipName === "BB" && p.multiplier > 0 ? p.points :
                           `<span class="text-muted">${p.rawPoints}</span>`;
        const rowClass = chipName === "BB" ? "" : "bench-inactive";

        html += `
          <tr class="${rowClass}">
            <td class="player-cell">
              <span class="player-pos">${p.posLabel}</span>
              <span class="player-name">${p.name}</span>
            </td>
            <td class="col-team">${p.team}</td>
            <td class="col-pts">${ptsDisplay}</td>
          </tr>
        `;
      }

      html += `
            </tbody>
          </table>
        </div>
      `;

      chipModalContent.innerHTML = html;

    } catch (error) {
      console.error("Error loading chip squad:", error);
      chipModalContent.innerHTML = "<p class='status status--error'>Error loading squad data.</p>";
    }
  }

  function formatChipsUsed(chips, managerId, managerName) {
    if (chips.length === 0) {
      return '<span class="text-muted">None</span>';
    }

    const sorted = [...chips].sort((a, b) => a.gw - b.gw);
    return sorted.map(c => {
      const emoji = c.name === "WC" ? "üÉè" :
                    c.name === "BB" ? "ü™ë" :
                    c.name === "TC" ? "üëë" :
                    c.name === "FH" ? "üéØ" : "";
      return `<button type="button" class="chip-used-btn"
                data-manager-id="${managerId}"
                data-manager-name="${managerName}"
                data-chip="${c.name}"
                data-gw="${c.gw}"
                data-points="${c.points}">
                ${emoji} ${c.name} <span class="chip-gw">GW${c.gw}</span> <span class="chip-pts">(${c.points})</span>
              </button>`;
    }).join(' ');
  }

  function formatChipsRemaining(chips) {
    const usedChips = chips.map(c => c.name);
    const wcCount = usedChips.filter(c => c === "WC").length;
    const bbCount = usedChips.filter(c => c === "BB").length;
    const tcCount = usedChips.filter(c => c === "TC").length;
    const fhCount = usedChips.filter(c => c === "FH").length;

    const remaining = [];

    const wcRemain = 2 - wcCount;
    const bbRemain = 2 - bbCount;
    const tcRemain = 2 - tcCount;
    const fhRemain = 2 - fhCount;

    if (wcRemain > 0) remaining.push(`<span class="chip-remaining">üÉè WC√ó${wcRemain}</span>`);
    if (bbRemain > 0) remaining.push(`<span class="chip-remaining">ü™ë BB√ó${bbRemain}</span>`);
    if (tcRemain > 0) remaining.push(`<span class="chip-remaining">üëë TC√ó${tcRemain}</span>`);
    if (fhRemain > 0) remaining.push(`<span class="chip-remaining">üéØ FH√ó${fhRemain}</span>`);

    if (remaining.length === 0) {
      return '<span class="text-danger font-bold">All used!</span>';
    }

    return remaining.join(' ');
  }

  function makeChipsTable(managersData) {
    let html = `
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table chips-table">
            <thead>
              <tr>
                <th>Manager</th>
                <th>Used</th>
                <th>Remaining</th>
              </tr>
            </thead>
            <tbody>
    `;

    const sorted = [...managersData].sort((a, b) => a.managerName.localeCompare(b.managerName));

    for (const m of sorted) {
      const usedHtml = formatChipsUsed(m.chips, m.entryId, m.managerName);
      const remainingHtml = formatChipsRemaining(m.chips);

      html += `
        <tr>
          <td class="manager-cell">
            <span class="strong">${m.managerName}</span>
          </td>
          <td class="chips-cell">${usedHtml}</td>
          <td class="chips-cell">${remainingHtml}</td>
        </tr>
      `;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    return html;
  }

  function attachChipButtons() {
    document.querySelectorAll('.chip-used-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const button = e.target.closest('.chip-used-btn');
        const managerId = button.dataset.managerId;
        const managerName = button.dataset.managerName;
        const chipName = button.dataset.chip;
        const gw = parseInt(button.dataset.gw);
        const points = parseInt(button.dataset.points);
        showChipSquad(managerId, managerName, chipName, gw, points);
      });
    });
  }

  async function loadChips(ids, cacheBuster) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return [];
    }

    const loadToken = ++currentLoadToken;
    refreshBtn.disabled = true;

    out.innerHTML = "";
    loadingStatus.textContent = `Fetching latest data...`;

    const managerDataResults = await mapWithConcurrency(
      ids,
      8,
      async (id) => {
        try {
          return await fetchManagerData(id, cacheBuster);
        } catch (e) {
          console.error(`Failed to load manager ${id}:`, e);
          return null;
        }
      },
      (completed, total) => {
        loadingStatus.textContent = `Fetching ${completed}/${total}...`;
      }
    );

    if (loadToken !== currentLoadToken) {
      console.log('Load superseded, aborting');
      return [];
    }

    const allData = managerDataResults.filter((data) => data !== null);

    if (allData.length > 0) {
      allManagersData = allData;
      populateManagerFilter(allManagersData);
      renderChipsTable();
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>‚úÖ Loaded ${allData.length} managers</span>`;
    refreshBtn.disabled = false;

    // Persist snapshot for restarts
    saveChipsSnapshot({ managerIds: ids, allData, playerCache, teamCache });

    return allData;
  }

  (async function init() {
    const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
    if (!authenticated) return;

    managerIds = ids;
    managerCountEl.textContent = `${managerIds.length} managers`;

    const snap = loadChipsSnapshot();
    const canUseSnap =
      snap &&
      Array.isArray(snap.allData) &&
      snap.allData.length > 0 &&
      sameManagerIds(snap.managerIds, managerIds);

    if (canUseSnap) {
      playerCache = snap.playerCache;
      teamCache = snap.teamCache;

      out.innerHTML = makeChipsTable(snap.allData);
      attachChipButtons();

      const ageMins = Math.round((Date.now() - Number(snap.savedAt)) / 60000);
      loadingStatus.textContent = `Loaded from cache (${ageMins}m old).`;

      if (!isFresh(snap.savedAt, CHIPS_CACHE_TTL_MS)) {
        (async () => {
          try {
            loadingStatus.textContent = `Refreshing in background...`;
            const bust = Date.now().toString();
            await fetchBootstrapData(bust);
            await loadChips(managerIds, bust);
          } catch (e) {
            console.warn("Background refresh failed:", e);
            loadingStatus.textContent = `Loaded from cache. (Background refresh failed)`;
          }
        })();
      }
      return;
    }

    loadingStatus.textContent = "Loading player data...";
    await fetchBootstrapData(); // no cache-buster
    await loadChips(managerIds); // no cache-buster
  })();

  refreshBtn.addEventListener('click', async () => {
    const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
    if (!authenticated) return;

    managerIds = ids;
    managerCountEl.textContent = `${managerIds.length} managers`;

    loadingStatus.textContent = "Refreshing...";
    const bust = Date.now().toString();

    await fetchBootstrapData(bust);
    await loadChips(managerIds, bust);
  });
</script>
