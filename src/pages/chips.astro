---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Chip Usage Tracker - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Chip Usage Tracker</h1>
      <p class="page-subtitle">Track which managers have used their chips and when.</p>
    </header>

    <div class="meta-row-wide">
      <span id="manager-count" class="badge badge-wide">Loading...</span>
      <a href="/managers" class="badge badge-wide">âš™ Manage IDs</a>
    </div>

    <div class="status-row">
      <div id="loading-status" class="status-text"></div>
      <button id="refresh-btn" class="btn-refresh" type="button">ğŸ”„ Refresh</button>
    </div>

    <section id="chips-output" aria-live="polite"></section>
  </main>
</Layout>

<style>
  .meta-row-wide {
    display: flex;
    gap: var(--space-2);
  }

  .badge-wide {
    flex: 1;
    justify-content: center;
    padding: var(--space-2) var(--space-3);
    text-align: center;
  }

  .status-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
  }

  .status-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .btn-refresh {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-refresh:hover {
    background: var(--color-primary-hover);
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  const out = document.getElementById("chips-output");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");

  let managerIds = [];

  async function fetchManagerData(id) {
    const historyUrl = `/api/fpl/entry/${id}/history`;
    const summaryUrl = `/api/fpl/entry/${id}`;

    try {
      const [historyRes, summaryRes] = await Promise.all([
        fetch(historyUrl),
        fetch(summaryUrl)
      ]);

      if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");

      const historyData = await historyRes.json();
      const summaryData = await summaryRes.json();

      const chips = historyData.chips || [];
      const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;

      const chipsFormatted = chips.map(c => ({
        name: c.name === "wildcard" ? "WC" :
              c.name === "bboost" ? "BB" :
              c.name === "3xc" ? "TC" :
              c.name === "freehit" ? "FH" : c.name,
        gw: c.event
      }));

      return {
        entryId: Number(id),
        managerName,
        chips: chipsFormatted
      };
    } catch (e) {
      console.error(`Error fetching manager ${id}:`, e);
      return null;
    }
  }

  function formatChipsUsed(chips) {
    if (chips.length === 0) {
      return '<span class="text-muted">None</span>';
    }
    
    const sorted = [...chips].sort((a, b) => a.gw - b.gw);
    return sorted.map(c => {
      const emoji = c.name === "WC" ? "ğŸƒ" : 
                    c.name === "BB" ? "ğŸª‘" : 
                    c.name === "TC" ? "ğŸ‘‘" : 
                    c.name === "FH" ? "ğŸ¯" : "";
      return `<span class="chip-used">${emoji} ${c.name} <span class="chip-gw">GW${c.gw}</span></span>`;
    }).join(' ');
  }

  function formatChipsRemaining(chips) {
    const usedChips = chips.map(c => c.name);
    const wcCount = usedChips.filter(c => c === "WC").length;
    const bbCount = usedChips.filter(c => c === "BB").length;
    const tcCount = usedChips.filter(c => c === "TC").length;
    const fhCount = usedChips.filter(c => c === "FH").length;

    const remaining = [];
    
    const wcRemain = 2 - wcCount;
    const bbRemain = 2 - bbCount;
    const tcRemain = 2 - tcCount;
    const fhRemain = 2 - fhCount;

    if (wcRemain > 0) remaining.push(`<span class="chip-remaining">ğŸƒ WCÃ—${wcRemain}</span>`);
    if (bbRemain > 0) remaining.push(`<span class="chip-remaining">ğŸª‘ BBÃ—${bbRemain}</span>`);
    if (tcRemain > 0) remaining.push(`<span class="chip-remaining">ğŸ‘‘ TCÃ—${tcRemain}</span>`);
    if (fhRemain > 0) remaining.push(`<span class="chip-remaining">ğŸ¯ FHÃ—${fhRemain}</span>`);

    if (remaining.length === 0) {
      return '<span class="text-danger font-bold">All used!</span>';
    }

    return remaining.join(' ');
  }

  function makeChipsTable(managersData) {
    let html = `
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table chips-table">
            <thead>
              <tr>
                <th>Manager</th>
                <th>Used</th>
                <th>Remaining</th>
              </tr>
            </thead>
            <tbody>
    `;

    const sorted = [...managersData].sort((a, b) => a.managerName.localeCompare(b.managerName));

    for (const m of sorted) {
      const usedHtml = formatChipsUsed(m.chips);
      const remainingHtml = formatChipsRemaining(m.chips);

      html += `
        <tr>
          <td class="manager-cell">
            <span class="strong">${m.managerName}</span>
          </td>
          <td class="chips-cell">${usedHtml}</td>
          <td class="chips-cell">${remainingHtml}</td>
        </tr>
      `;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    return html;
  }

  async function loadChips(ids) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    const allData = [];
    out.innerHTML = "";
    loadingStatus.textContent = `Loading 0 of ${ids.length}...`;

    let loaded = 0;
    for (const id of ids) {
      try {
        const data = await fetchManagerData(id);
        if (data) {
          allData.push(data);
          loaded++;

          loadingStatus.textContent = `Loading ${loaded} of ${ids.length}...`;

          out.innerHTML = makeChipsTable(allData);
        }
      } catch (e) {
        console.error(`Failed to load manager ${id}:`, e);
        loaded++;
      }
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>âœ… Loaded ${loaded} managers</span>`;
  }

  async function updateDisplay() {
    managerCountEl.textContent = `${managerIds.length} managers`;
    if (managerIds.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    await loadChips(managerIds);
  }

  (async function init() {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;

    await updateDisplay();
  })();

  refreshBtn.addEventListener('click', async () => {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;
    await updateDisplay();
  });
</script>