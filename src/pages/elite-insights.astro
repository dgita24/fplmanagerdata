---
import Nav from '../components/Nav.astro';
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite Manager Insights - FPL Manager Data</title>
</head>
<body>
<Nav />

<h1>üèÜ Elite Manager Insights</h1>
<p>Statistics, transfer patterns, and formations for elite managers.</p>

<div style="margin-bottom: 1.5em;">
  <label for="view-select" style="font-weight: bold; margin-right: 0.5em;">View:</label>
  <select id="view-select" style="padding: 8px 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc;">
    <option value="top50">World Top 50</option>
    <option value="custom">My Custom Managers</option>
  </select>
  
  <label for="gw-select" style="font-weight: bold; margin-left: 2em; margin-right: 0.5em;">Gameweek:</label>
  <select id="gw-select" style="padding: 8px 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc;">
    <option value="season">Season Total</option>
  </select>
  
  <span id="manager-count" style="margin-left: 1.5em; font-weight: bold;">Loading managers...</span>
  <a href="/managers" style="margin-left: 1em; color: #3182ce;">Manage IDs</a>
</div>

<div id="loading-status" style="margin-bottom: 1em; color: #666;"></div>
<div id="insights-output" style="margin-top:1.5em"></div>

<script>
import { supabase } from '../lib/supabase.ts'

let managerIds = []

async function loadManagerIdsFromSupabase() {
  const { data: { user } } = await supabase.auth.getUser()
  
  if (!user) {
    window.location.replace('/login')
    return { authenticated: false, managerIds: [] }
  }
  
  try {
    const { data, error } = await supabase
      .from('user_manager_lists')
      .select('manager_ids')
      .eq('user_id', user.id)
      .single()
    
    if (error && error.code !== 'PGRST116') {
      console.error('Error loading manager IDs:', error)
      return { authenticated: true, managerIds: [] }
    }
    
    return { authenticated: true, managerIds: data?.manager_ids || [] }
  } catch (e) {
    console.error('Error:', e)
    return { authenticated: false, managerIds: [] }
  }
}

const out = document.getElementById("insights-output");
const loadingStatus = document.getElementById("loading-status");
const managerCountEl = document.getElementById("manager-count");
const viewSelect = document.getElementById("view-select");
const gwSelect = document.getElementById("gw-select");

let currentView = 'top50';
let selectedGW = 'season';

async function populateGWSelector() {
  const { data, error } = await supabase
    .from('top_50_aggregates')
    .select('gameweek')
    .order('gameweek', { ascending: true });
  
  if (error || !data) {
    console.error('Error fetching gameweeks:', error);
    return;
  }
  
  console.log('Fetched gameweeks:', data);
  
  gwSelect.innerHTML = '<option value="season">Season Total</option>';
  
  data.forEach(row => {
    const option = document.createElement('option');
    option.value = row.gameweek;
    option.textContent = `GW ${row.gameweek}`;
    gwSelect.appendChild(option);
  });
}

function aggregateSeasonData(allGameweeks) {
  if (!allGameweeks || allGameweeks.length === 0) return null;
  
  const numGWs = allGameweeks.length;
  const result = {
    managers_analyzed: allGameweeks[0]?.managers_analyzed || 50,
    avg_goals_gk: 0, avg_goals_def: 0, avg_goals_mid: 0, avg_goals_fwd: 0,
    avg_assists_gk: 0, avg_assists_def: 0, avg_assists_mid: 0, avg_assists_fwd: 0,
    avg_cs_gk: 0, avg_cs_def: 0, avg_cs_mid: 0, avg_cs_fwd: 0,
    avg_bonus_points: 0, avg_other_points: 0,
    avg_transfers: 0, avg_hits_count: 0, avg_hits_cost: 0,
    most_common_formation: '', formation_distribution: {}
  };
  
  allGameweeks.forEach(gw => {
    result.avg_goals_gk += (gw.avg_goals_gk || 0);
    result.avg_goals_def += (gw.avg_goals_def || 0);
    result.avg_goals_mid += (gw.avg_goals_mid || 0);
    result.avg_goals_fwd += (gw.avg_goals_fwd || 0);
    result.avg_assists_gk += (gw.avg_assists_gk || 0);
    result.avg_assists_def += (gw.avg_assists_def || 0);
    result.avg_assists_mid += (gw.avg_assists_mid || 0);
    result.avg_assists_fwd += (gw.avg_assists_fwd || 0);
    result.avg_cs_gk += (gw.avg_cs_gk || 0);
    result.avg_cs_def += (gw.avg_cs_def || 0);
    result.avg_cs_mid += (gw.avg_cs_mid || 0);
    result.avg_cs_fwd += (gw.avg_cs_fwd || 0);
    result.avg_bonus_points += (gw.avg_bonus_points || 0);
    result.avg_other_points += (gw.avg_other_points || 0);
    result.avg_transfers += (gw.avg_transfers || 0);
    result.avg_hits_count += (gw.avg_hits_count || 0);
    result.avg_hits_cost += (gw.avg_hits_cost || 0);
    
    if (gw.formation_distribution) {
      Object.entries(gw.formation_distribution).forEach(([formation, count]) => {
        result.formation_distribution[formation] = (result.formation_distribution[formation] || 0) + count;
      });
    }
  });
  
  result.avg_transfers = result.avg_transfers / numGWs;
  result.avg_hits_count = result.avg_hits_count / numGWs;
  result.avg_hits_cost = result.avg_hits_cost / numGWs;
  result.avg_bonus_points = result.avg_bonus_points / numGWs;
  result.avg_other_points = result.avg_other_points / numGWs;
  
  if (Object.keys(result.formation_distribution).length > 0) {
    result.most_common_formation = Object.entries(result.formation_distribution)
      .sort(([, a], [, b]) => b - a)[0][0];
  }
  
  return result;
}

function aggregateCustomManagerData(managersData) {
  const numManagers = managersData.length;
  if (numManagers === 0) return null;
  
  const aggregate = {
    managers_analyzed: numManagers,
    avg_goals_gk: 0, avg_goals_def: 0, avg_goals_mid: 0, avg_goals_fwd: 0,
    avg_assists_gk: 0, avg_assists_def: 0, avg_assists_mid: 0, avg_assists_fwd: 0,
    avg_cs_gk: 0, avg_cs_def: 0, avg_cs_mid: 0, avg_cs_fwd: 0,
    avg_bonus_points: 0, avg_other_points: 0,
    avg_transfers: 0, avg_hits_count: 0, avg_hits_cost: 0,
    most_common_formation: '', formation_distribution: {}
  };
  
  managersData.forEach(manager => {
    aggregate.avg_goals_gk += (manager.goals_gk || 0);
    aggregate.avg_goals_def += (manager.goals_def || 0);
    aggregate.avg_goals_mid += (manager.goals_mid || 0);
    aggregate.avg_goals_fwd += (manager.goals_fwd || 0);
    aggregate.avg_assists_gk += (manager.assists_gk || 0);
    aggregate.avg_assists_def += (manager.assists_def || 0);
    aggregate.avg_assists_mid += (manager.assists_mid || 0);
    aggregate.avg_assists_fwd += (manager.assists_fwd || 0);
    aggregate.avg_cs_gk += (manager.cs_gk || 0);
    aggregate.avg_cs_def += (manager.cs_def || 0);
    aggregate.avg_cs_mid += (manager.cs_mid || 0);
    aggregate.avg_cs_fwd += (manager.cs_fwd || 0);
    aggregate.avg_bonus_points += (manager.bonus_points || 0);
    aggregate.avg_other_points += (manager.other_points || 0);
    aggregate.avg_transfers += (manager.total_transfers || 0);
    aggregate.avg_hits_count += (manager.hits_count || 0);
    aggregate.avg_hits_cost += (manager.hits_cost || 0);
    
    if (manager.formations) {
      Object.entries(manager.formations).forEach(([formation, count]) => {
        aggregate.formation_distribution[formation] = (aggregate.formation_distribution[formation] || 0) + count;
      });
    }
  });
  
  aggregate.avg_goals_gk /= numManagers;
  aggregate.avg_goals_def /= numManagers;
  aggregate.avg_goals_mid /= numManagers;
  aggregate.avg_goals_fwd /= numManagers;
  aggregate.avg_assists_gk /= numManagers;
  aggregate.avg_assists_def /= numManagers;
  aggregate.avg_assists_mid /= numManagers;
  aggregate.avg_assists_fwd /= numManagers;
  aggregate.avg_cs_gk /= numManagers;
  aggregate.avg_cs_def /= numManagers;
  aggregate.avg_cs_mid /= numManagers;
  aggregate.avg_cs_fwd /= numManagers;
  aggregate.avg_bonus_points /= numManagers;
  aggregate.avg_other_points /= numManagers;
  aggregate.avg_transfers /= numManagers;
  aggregate.avg_hits_count /= numManagers;
  aggregate.avg_hits_cost /= numManagers;
  
  if (Object.keys(aggregate.formation_distribution).length > 0) {
    aggregate.most_common_formation = Object.entries(aggregate.formation_distribution)
      .sort(([, a], [, b]) => b - a)[0][0];
  }
  
  return aggregate;
}

function renderDataTables(data, gwLabel, gameweek) {
  const goalsGK = (data.avg_goals_gk || 0) * 6;
  const goalsDEF = (data.avg_goals_def || 0) * 6;
  const goalsMID = (data.avg_goals_mid || 0) * 5;
  const goalsFWD = (data.avg_goals_fwd || 0) * 4;
  
  const assistsGK = (data.avg_assists_gk || 0) * 3;
  const assistsDEF = (data.avg_assists_def || 0) * 3;
  const assistsMID = (data.avg_assists_mid || 0) * 3;
  const assistsFWD = (data.avg_assists_fwd || 0) * 3;
  
  const csGK = (data.avg_cs_gk || 0) * 4;
  const csDEF = (data.avg_cs_def || 0) * 4;
  const csMID = (data.avg_cs_mid || 0) * 1;
  
  const pointsGK = goalsGK + assistsGK + csGK;
  const pointsDEF = goalsDEF + assistsDEF + csDEF;
  const pointsMID = goalsMID + assistsMID + csMID;
  const pointsFWD = goalsFWD + assistsFWD;
  
  const totalPoints = pointsGK + pointsDEF + pointsMID + pointsFWD + (data.avg_bonus_points || 0) + (data.avg_other_points || 0);
  
  let html = `
    <h2>üìä ${gwLabel} - ${data.managers_analyzed} Managers</h2>
    
    <h3>Transfer Statistics</h3>
    <table border="1" cellpadding="8" style="border-collapse:collapse; width: 100%; max-width: 800px; margin-bottom: 2em;">
      <tr style="background:#f0f0f0">
        <th>Metric</th>
        <th>Value</th>
      </tr>
      <tr>
        <td><strong>Average Transfers</strong></td>
        <td style="text-align: center; font-weight: bold;">${data.avg_transfers.toFixed(2)}<br/><span style="font-size: 0.85em; color: #666;">Avg per Manager ${gameweek === 'season' ? '(Season)' : '(GW ' + gameweek + ')'}</span></td>
      </tr>
      <tr>
        <td><strong>Transfer Hits</strong></td>
        <td style="text-align: center; font-weight: bold;">${data.avg_hits_count.toFixed(2)}<br/><span style="font-size: 0.85em; color: #666;">Avg per Manager ${gameweek === 'season' ? '(Season)' : '(GW ' + gameweek + ')'}</span></td>
      </tr>
      <tr>
        <td><strong>Hits Cost (points)</strong></td>
        <td style="text-align: center; font-weight: bold; color: #e53e3e;">-${data.avg_hits_cost.toFixed(1)}<br/><span style="font-size: 0.85em; color: #666;">Avg per Manager ${gameweek === 'season' ? '(Season)' : '(GW ' + gameweek + ')'}</span></td>
      </tr>
      <tr style="background:#fffacd">
        <td><strong>Most Used Formation</strong></td>
        <td style="text-align: center; font-weight: bold; font-size: 1.2em;">${data.most_common_formation || 'N/A'}</td>
      </tr>
    </table>
    
    <h3>Points by Position (FPL Scoring)</h3>
    <table border="1" cellpadding="8" style="border-collapse:collapse; width: 100%; max-width: 1000px; margin-bottom: 2em;">
      <tr style="background:#f0f0f0">
        <th>Position</th>
        <th>Goals</th>
        <th>Assists</th>
        <th>Clean Sheets</th>
        <th>Total Points</th>
      </tr>
      <tr>
        <td><strong>GK</strong></td>
        <td style="text-align: center;">${data.avg_goals_gk.toFixed(2)} (${goalsGK.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_assists_gk.toFixed(2)} (${assistsGK.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_cs_gk.toFixed(2)} (${csGK.toFixed(1)} pts)</td>
        <td style="text-align: center; background:#e6ffe6; font-weight: bold;">${pointsGK.toFixed(1)}</td>
      </tr>
      <tr>
        <td><strong>DEF</strong></td>
        <td style="text-align: center;">${data.avg_goals_def.toFixed(2)} (${goalsDEF.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_assists_def.toFixed(2)} (${assistsDEF.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_cs_def.toFixed(2)} (${csDEF.toFixed(1)} pts)</td>
        <td style="text-align: center; background:#e6ffe6; font-weight: bold;">${pointsDEF.toFixed(1)}</td>
      </tr>
      <tr>
        <td><strong>MID</strong></td>
        <td style="text-align: center;">${data.avg_goals_mid.toFixed(2)} (${goalsMID.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_assists_mid.toFixed(2)} (${assistsMID.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_cs_mid.toFixed(2)} (${csMID.toFixed(1)} pts)</td>
        <td style="text-align: center; background:#e6ffe6; font-weight: bold;">${pointsMID.toFixed(1)}</td>
      </tr>
      <tr>
        <td><strong>FWD</strong></td>
        <td style="text-align: center;">${data.avg_goals_fwd.toFixed(2)} (${goalsFWD.toFixed(1)} pts)</td>
        <td style="text-align: center;">${data.avg_assists_fwd.toFixed(2)} (${assistsFWD.toFixed(1)} pts)</td>
        <td style="text-align: center;">0.00 (0.0 pts)</td>
        <td style="text-align: center; background:#e6ffe6; font-weight: bold;">${pointsFWD.toFixed(1)}</td>
      </tr>
      <tr style="background:#d4edda">
        <td colspan="4"><strong>Bonus + Other Points</strong></td>
        <td style="text-align: center; font-weight: bold;">${((data.avg_bonus_points || 0) + (data.avg_other_points || 0)).toFixed(1)}</td>
      </tr>
    </table>
    <p style="font-size: 0.9em; color: #666; max-width: 1000px;"><em>FPL Scoring: Goals (GK/DEF: 6pts, MID: 5pts, FWD: 4pts), Assists (3pts all), Clean Sheets (GK/DEF: 4pts, MID: 1pt)</em></p>
  `;
  
  if (data.formation_distribution && Object.keys(data.formation_distribution).length > 0) {
    const sortedFormations = Object.entries(data.formation_distribution)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 10);
    
    const totalCount = sortedFormations.reduce((sum, [, count]) => sum + count, 0);
    
    html += `
      <h3>Formation Distribution</h3>
      <table border="1" cellpadding="8" style="border-collapse:collapse; width: 100%; max-width: 600px; margin-bottom: 2em;">
        <tr style="background:#f0f0f0">
          <th>Formation</th>
          <th>Uses</th>
          <th>Percentage</th>
        </tr>
    `;
    
    sortedFormations.forEach(([formation, count]) => {
      const percentage = ((count / totalCount) * 100).toFixed(1);
      html += `
        <tr>
          <td style="font-weight: bold; text-align: center;">${formation}</td>
          <td style="text-align: center;">${count}</td>
          <td style="text-align: center;">${percentage}%</td>
        </tr>
      `;
    });
    
    html += `</table>`;
  }
  
  return html;
}

async function displayTop50() {
  out.innerHTML = '<p style="color: #666;">Loading Top 50 data...</p>';
  
  try {
    let aggregateData;
    let gwLabel;
    
    if (selectedGW === 'season') {
      const { data: allData, error } = await supabase
        .from('top_50_aggregates')
        .select('*')
        .order('gameweek', { ascending: true });
      
      if (error || !allData || allData.length === 0) {
        out.innerHTML = '<p style="color: #e53e3e;">‚ùå No Top 50 data available yet.</p>';
        return;
      }
      
      aggregateData = aggregateSeasonData(allData);
      gwLabel = `Season Total (GW 1-${allData[allData.length - 1].gameweek})`;
      loadingStatus.innerHTML = `<span style="color:#38a169">‚úÖ Loaded data for ${allData.length} gameweeks</span>`;
    } else {
      const { data, error } = await supabase
        .from('top_50_aggregates')
        .select('*')
        .eq('gameweek', selectedGW)
        .single();
      
      if (error || !data) {
        out.innerHTML = '<p style="color: #e53e3e;">‚ùå No data for this gameweek.</p>';
        return;
      }
      
      aggregateData = data;
      gwLabel = `GW ${selectedGW}`;
      loadingStatus.innerHTML = `<span style="color:#38a169">‚úÖ Loaded data for GW ${selectedGW}</span>`;
    }
    
    out.innerHTML = `<h2 style="color:#667eea">üèÜ World Top 50</h2>` + renderDataTables(aggregateData, gwLabel, selectedGW);
  } catch (error) {
    console.error('Error displaying Top 50:', error);
    out.innerHTML = '<p style="color: #e53e3e;">‚ùå Error loading data.</p>';
  }
}

async function displayCustomManagers() {
  if (managerIds.length === 0) {
    out.innerHTML = '<p style="color: #e53e3e;">No custom managers added. <a href="/managers">Add managers here</a>.</p>';
    loadingStatus.textContent = '';
    return;
  }
  
  out.innerHTML = '<p style="color: #666;">Loading custom managers data...</p>';
  loadingStatus.textContent = 'Fetching data from database...';
  
  try {
    let managersData;
    let gwLabel;
    
    if (selectedGW === 'season') {
      const { data, error } = await supabase
        .from('elite_manager_insights')
        .select('*')
        .in('manager_id', managerIds)
        .order('gameweek', { ascending: true });
      
      if (error || !data || data.length === 0) {
        out.innerHTML = '<p style="color: #e53e3e;">‚ÑπÔ∏è No data available for custom managers yet.</p>';
        loadingStatus.textContent = '';
        return;
      }
      
      managersData = data;
      gwLabel = 'Season Total';
      loadingStatus.innerHTML = `<span style="color:#38a169">‚úÖ Loaded data for ${data.length} gameweeks</span>`;
    } else {
      const { data, error } = await supabase
        .from('elite_manager_insights')
        .select('*')
        .in('manager_id', managerIds)
        .eq('gameweek', selectedGW);
      
      if (error || !data || data.length === 0) {
        out.innerHTML = `<p style="color: #e53e3e;">‚ÑπÔ∏è No data for GW ${selectedGW} for custom managers.</p>`;
        loadingStatus.textContent = '';
        return;
      }
      
      managersData = data;
      gwLabel = `GW ${selectedGW}`;
      loadingStatus.innerHTML = `<span style="color:#38a169">‚úÖ Loaded data for GW ${selectedGW}</span>`;
    }
    
    const aggregateData = aggregateCustomManagerData(managersData);
    out.innerHTML = `<h2 style="color:#667eea">üë• Custom Managers</h2>` + renderDataTables(aggregateData, gwLabel, selectedGW);
  } catch (error) {
    console.error('Error displaying custom managers:', error);
    out.innerHTML = '<p style="color: #e53e3e;">‚ùå Error loading data.</p>';
    loadingStatus.textContent = '';
  }
}

async function updateView() {
  if (currentView === 'top50') {
    await displayTop50();
  } else {
    await displayCustomManagers();
  }
}

(async function init() {
  const { managerIds: ids } = await loadManagerIdsFromSupabase();
  managerIds = ids;
  managerCountEl.textContent = `${ids.length} manager(s) tracked`;
  
  await populateGWSelector();
  
  viewSelect.addEventListener('change', () => {
    currentView = viewSelect.value;
    updateView();
  });
  
  gwSelect.addEventListener('change', () => {
    selectedGW = gwSelect.value;
    updateView();
  });
  
  await updateView();
})();
</script>

<style>
  table {
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  th {
    font-weight: bold;
    padding: 8px;
  }
  td {
    padding: 8px;
  }
  h2 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }
  h3 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: #2d3748;
  }
</style>
</body>
</html>
