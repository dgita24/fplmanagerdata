---
import Nav from '../components/Nav.astro';
---

<Nav />
<h1>üèÜ Elite Manager Insights</h1>
<p>Premium statistics: points distribution, transfer patterns, and formations used by top managers vs. your tracked managers.</p>

<div style="margin-bottom: 1.5em;">
  <label for="view-select" style="font-weight: bold; margin-right: 0.5em;">View:</label>
  <select id="view-select" style="padding: 8px 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc;">
    <option value="top50">World Top 50</option>
    <option value="custom">My Custom Managers</option>
  </select>
  
  <span id="manager-count" style="margin-left: 1.5em; color: #666;"></span>
  <a href="/managers" style="margin-left: 1em; color: #3182ce;">Manage IDs</a>
</div>

<div id="data-status" style="margin-bottom: 1em; padding: 1em; background: #f0f9ff; border-radius: 4px; border-left: 4px solid #3182ce;">
  <p style="margin: 0; color: #1e40af;">Loading...</p>
</div>

<div id="insights-output" style="margin-top:1.5em"></div>

<script type="module">
const SUPABASE_URL = 'https://fnehvaoqqmkrhxcqslta.supabase.co';
const SUPABASE_KEY = 'sb_publishable_MWe6etLwK0ONF0hbSJX4fA_pqxUcXLK';

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

function loadManagerIds() {
  try {
    return JSON.parse(localStorage.getItem("globalManagerIds")) || [];
  } catch {
    return [];
  }
}

const out = document.getElementById("insights-output");
const dataStatus = document.getElementById("data-status");
const managerCountEl = document.getElementById("manager-count");
const viewSelect = document.getElementById("view-select");

let currentView = 'top50';
let latestGW = null;

async function fetchLatestGW() {
  const { data, error } = await supabase
    .from('top_50_aggregates')
    .select('gameweek, data_fetched_at')
    .order('gameweek', { ascending: false })
    .limit(1)
    .single();
  
  if (error) {
    console.error('Error fetching latest GW:', error);
    return null;
  }
  
  return data;
}

function renderPointsTable(data, isAverage = false) {
  const positions = ['GK', 'DEF', 'MID', 'FWD'];
  const prefix = isAverage ? 'avg_' : '';
  
  const goals = {
    GK: data[`${prefix}goals_gk`] || 0,
    DEF: data[`${prefix}goals_def`] || 0,
    MID: data[`${prefix}goals_mid`] || 0,
    FWD: data[`${prefix}goals_fwd`] || 0,
  };
  
  const assists = {
    GK: data[`${prefix}assists_gk`] || 0,
    DEF: data[`${prefix}assists_def`] || 0,
    MID: data[`${prefix}assists_mid`] || 0,
    FWD: data[`${prefix}assists_fwd`] || 0,
  };
  
  const cleanSheets = {
    GK: data[`${prefix}cs_gk`] || 0,
    DEF: data[`${prefix}cs_def`] || 0,
    MID: data[`${prefix}cs_mid`] || 0,
    FWD: data[`${prefix}cs_fwd`] || 0,
  };
  
  const bonus = data[`${prefix}bonus_points`] || 0;
  const other = data[`${prefix}other_points`] || 0;
  
  const totalGoals = Object.values(goals).reduce((a, b) => a + b, 0);
  const totalAssists = Object.values(assists).reduce((a, b) => a + b, 0);
  const totalCS = Object.values(cleanSheets).reduce((a, b) => a + b, 0);
  
  return `
    <table border="1" cellpadding="8" style="border-collapse:collapse; width:100%; margin-top: 1em;">
      <tr style="background:#f0f0f0">
        <th>Category</th>
        <th>GK</th>
        <th>DEF</th>
        <th>MID</th>
        <th>FWD</th>
        <th>Total</th>
      </tr>
      <tr>
        <td><strong>Goals</strong></td>
        ${positions.map(pos => `<td style="text-align:center">${goals[pos]}</td>`).join('')}
        <td style="text-align:center"><strong>${totalGoals}</strong></td>
      </tr>
      <tr style="background:#f9f9f9">
        <td><strong>Assists</strong></td>
        ${positions.map(pos => `<td style="text-align:center">${assists[pos]}</td>`).join('')}
        <td style="text-align:center"><strong>${totalAssists}</strong></td>
      </tr>
      <tr>
        <td><strong>Clean Sheets</strong></td>
        ${positions.map(pos => `<td style="text-align:center">${cleanSheets[pos]}</td>`).join('')}
        <td style="text-align:center"><strong>${totalCS}</strong></td>
      </tr>
      <tr style="background:#f9f9f9">
        <td><strong>Bonus Points</strong></td>
        <td colspan="4" style="text-align:center">-</td>
        <td style="text-align:center"><strong>${bonus}</strong></td>
      </tr>
      <tr>
        <td><strong>Other Points</strong></td>
        <td colspan="4" style="text-align:center">-</td>
        <td style="text-align:center"><strong>${other}</strong></td>
      </tr>
    </table>
  `;
}

async function displayTop50() {
  out.innerHTML = '<p style="color: #666;">Loading Top 50 data...</p>';
  
  const gwInfo = await fetchLatestGW();
  if (!gwInfo) {
    out.innerHTML = '<p style="color: red;">‚ùå No Top 50 data available yet. The automated job will fetch it after the next gameweek finishes.</p>';
    return;
  }
  
  latestGW = gwInfo.gameweek;
  const fetchDate = new Date(gwInfo.data_fetched_at).toLocaleString();
  
  dataStatus.innerHTML = `
    <p style="margin: 0; color: #1e40af;">
      üìä Showing data for <strong>GW ${latestGW}</strong> | 
      Last updated: <strong>${fetchDate}</strong>
    </p>
  `;
  
  const { data: aggregate, error } = await supabase
    .from('top_50_aggregates')
    .select('*')
    .eq('gameweek', latestGW)
    .single();
  
  if (error) {
    console.error('Error fetching aggregate:', error);
    out.innerHTML = '<p style="color: red;">Error loading data.</p>';
    return;
  }
  
  let html = `
    <div style="background: linear-gradient(to right, #fef3c7, #fde68a); padding: 1.5em; border-radius: 8px; border: 2px solid #f59e0b; margin-bottom: 2em;">
      <h2 style="color: #92400e; margin-top: 0;">üèÜ World Top 50 Averages (GW ${latestGW})</h2>
      <p style="color: #92400e; margin-bottom: 1em;">Based on ${aggregate.managers_analyzed} managers</p>
      
      <h3 style="color: #92400e;">Points Distribution</h3>
      ${renderPointsTable(aggregate, true)}
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1em; margin-top: 1.5em;">
        <div style="background: white; padding: 1em; border-radius: 4px;">
          <p style="color: #666; font-size: 14px; margin: 0;">Average Transfers</p>
          <p style="font-size: 24px; font-weight: bold; margin: 0.5em 0 0 0;">${aggregate.avg_transfers}</p>
        </div>
        <div style="background: white; padding: 1em; border-radius: 4px;">
          <p style="color: #666; font-size: 14px; margin: 0;">Average Hits</p>
          <p style="font-size: 24px; font-weight: bold; margin: 0.5em 0 0 0;">${aggregate.avg_hits_count} (-${aggregate.avg_hits_cost} pts)</p>
        </div>
        <div style="background: white; padding: 1em; border-radius: 4px;">
          <p style="color: #666; font-size: 14px; margin: 0;">Most Common Formation</p>
          <p style="font-size: 28px; font-weight: bold; color: #3182ce; margin: 0.5em 0 0 0;">${aggregate.most_common_formation}</p>
        </div>
      </div>
      
      <div style="margin-top: 1.5em; background: white; padding: 1em; border-radius: 4px;">
        <p style="color: #666; font-size: 14px; margin: 0 0 0.5em 0;">Formation Distribution (Top 5):</p>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5em;">
          ${Object.entries(aggregate.formation_distribution || {})
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5)
            .map(([formation, count]) => 
              `<span style="display: inline-block; background: #e6f2ff; padding: 6px 12px; border-radius: 4px; font-size: 14px;">
                ${formation}: ${count} uses
              </span>`
            ).join('')}
        </div>
      </div>
    </div>
  `;
  
  out.innerHTML = html;
}

async function displayCustomManagers() {
  const managerIds = loadManagerIds();
  
  if (managerIds.length === 0) {
    out.innerHTML = '<p style="color: #666;">No custom managers added yet. <a href="/managers">Add manager IDs</a> to see their insights.</p>';
    return;
  }
  
  out.innerHTML = '<p style="color: #666;">Loading your managers...</p>';
  
  const gwInfo = await fetchLatestGW();
  if (!gwInfo) {
    out.innerHTML = '<p style="color: red;">‚ùå No data available yet. Data will be fetched automatically after gameweeks finish.</p>';
    return;
  }
  
  latestGW = gwInfo.gameweek;
  const fetchDate = new Date(gwInfo.data_fetched_at).toLocaleString();
  
  dataStatus.innerHTML = `
    <p style="margin: 0; color: #1e40af;">
      üìä Showing data for <strong>GW ${latestGW}</strong> | 
      Last updated: <strong>${fetchDate}</strong> |
      <span style="color: #dc2626;">‚ö†Ô∏è Custom manager data needs to be fetched on-demand (feature coming soon)</span>
    </p>
  `;
  
  // For now, show a message that custom manager fetching needs to be implemented
  out.innerHTML = `
    <div style="background: #fffbeb; padding: 1.5em; border-radius: 8px; border: 2px solid #f59e0b;">
      <h3 style="margin-top: 0;">üöß Custom Manager Insights - Coming Soon</h3>
      <p>Your tracked managers (${managerIds.length} total):</p>
      <ul>
        ${managerIds.slice(0, 10).map(id => `<li>Manager ID: ${id}</li>`).join('')}
        ${managerIds.length > 10 ? `<li><em>...and ${managerIds.length - 10} more</em></li>` : ''}
      </ul>
      <p><strong>Next step:</strong> We need to add a feature to fetch your custom managers' data on-demand. This will work similarly to the Top 50 but for your specific list.</p>
    </div>
  `;
}

async function updateView() {
  if (currentView === 'top50') {
    await displayTop50();
  } else {
    await displayCustomManagers();
  }
}

// Initialize
(async function init() {
  const ids = loadManagerIds();
  managerCountEl.textContent = `(${ids.length} manager${ids.length !== 1 ? 's' : ''} tracked)`;
  
  viewSelect.addEventListener('change', () => {
    currentView = viewSelect.value;
    updateView();
  });
  
  // Load initial view
  await updateView();
})();
</script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 2em;
    max-width: 1400px;
    margin: 0 auto;
  }
  
  table {
    font-size: 14px;
  }
  
  table th {
    font-weight: 600;
  }
</style>