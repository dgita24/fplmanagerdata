---
import Nav from '../components/Nav.astro';
---
<Nav />
<h1>âš¡ Live FPL Tracker</h1>
<p>Real-time points, ranks, and captain picks</p>

<button id="refresh-btn" style="padding: 10px 20px; margin-bottom: 1em; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
  ðŸ”„ Refresh Data
</button>

<div id="output"></div>

<script>
function loadManagerIds() {
  try {
    return JSON.parse(localStorage.getItem("globalManagerIds")) || [];
  } catch {
    return [];
  }
}

const out = document.getElementById("output");
const refreshBtn = document.getElementById("refresh-btn");

async function fetchLiveData() {
  const ids = loadManagerIds();
  if (ids.length === 0) {
    out.innerHTML = '<p>No managers added yet. <a href="/managers">Add manager IDs</a>.</p>';
    return;
  }

  refreshBtn.disabled = true;
  refreshBtn.textContent = "Loading...";

  try {
    // Get current gameweek
    const bootstrapRes = await fetch("/api/fpl/bootstrap-static");
    if (!bootstrapRes.ok) throw new Error("Failed to fetch bootstrap data");
    
    const bootstrap = await bootstrapRes.json();
    const currentGW = bootstrap.events.find(e => e.is_current)?.id;

    if (!currentGW) {
      out.innerHTML = "<p>No active gameweek found.</p>";
      refreshBtn.disabled = false;
      refreshBtn.textContent = "ðŸ”„ Refresh Data";
      return;
    }

    // Build player map
    const playerMap = {};
    bootstrap.elements.forEach(p => {
      playerMap[p.id] = p.web_name;
    });

    // Fetch all manager data
    const managerData = await Promise.all(
      ids.map(async (id) => {
        try {
          const entryRes = await fetch(`/api/fpl/entry/${id}`);
          if (!entryRes.ok) throw new Error(`Failed to fetch entry for ${id}`);
          const entry = await entryRes.json();

          const picksRes = await fetch(`/api/fpl/entry/${id}/event/${currentGW}/picks`);
          if (!picksRes.ok) throw new Error(`Failed to fetch picks for ${id}`);
          const picks = await picksRes.json();

          return {
            id,
            name: `${entry.player_first_name} ${entry.player_last_name}`,
            teamName: entry.name,
            gwPoints: entry.summary_event_points || 0,
            totalPoints: entry.summary_overall_points || 0,
            rank: entry.summary_overall_rank || 0,
            captain: picks.picks?.find(p => p.is_captain)?.element || null,
            viceCaptain: picks.picks?.find(p => p.is_vice_captain)?.element || null
          };
        } catch (e) {
          console.error(`Error fetching manager ${id}:`, e);
          return null;
        }
      })
    );

    const validManagers = managerData.filter(m => m !== null);

    if (validManagers.length === 0) {
      out.innerHTML = "<p style='color: red;'>Failed to load any manager data.</p>";
      refreshBtn.disabled = false;
      refreshBtn.textContent = "ðŸ”„ Refresh Data";
      return;
    }

    // Sort by GW points descending
    validManagers.sort((a, b) => b.gwPoints - a.gwPoints);

    let html = `
      <h2>Gameweek ${currentGW} - Live Standings</h2>
      <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; margin-top: 1em;">
        <thead>
          <tr style="background: #f0f0f0;">
            <th>Pos</th>
            <th>Manager</th>
            <th>Team</th>
            <th>GW Points</th>
            <th>Total Points</th>
            <th>Overall Rank</th>
            <th>Captain</th>
            <th>Vice Captain</th>
          </tr>
        </thead>
        <tbody>
    `;

    validManagers.forEach((m, idx) => {
      html += `
        <tr>
          <td style="text-align: center; font-weight: bold;">${idx + 1}</td>
          <td><a href="/squads?manager=${m.id}" style="color: #3182ce; text-decoration: none;">${m.name}</a></td>
          <td>${m.teamName}</td>
          <td style="text-align: center; font-weight: bold; color: #38a169;">${m.gwPoints}</td>
          <td style="text-align: center;">${m.totalPoints}</td>
          <td style="text-align: center;">${m.rank.toLocaleString()}</td>
          <td style="text-align: center;">${playerMap[m.captain] || 'N/A'}</td>
          <td style="text-align: center;">${playerMap[m.viceCaptain] || 'N/A'}</td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    out.innerHTML = html;

  } catch (error) {
    console.error("Error fetching live data:", error);
    out.innerHTML = `<p style='color: red;'>Error loading data: ${error.message}</p>`;
  } finally {
    refreshBtn.disabled = false;
    refreshBtn.textContent = "ðŸ”„ Refresh Data";
  }
}

refreshBtn.addEventListener("click", fetchLiveData);
fetchLiveData();
</script>

<style>
  table { font-size: 14px; }
  th { font-weight: 600; }
  a:hover { text-decoration: underline !important; }
</style>