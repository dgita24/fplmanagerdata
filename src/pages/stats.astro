---

import Nav from '../components/Nav.astro';
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>League Statistics  Manager Summary - FPL Manager Data</title>
</head>
<body>
<Nav />
<h1>League Statistics & Manager Summary</h1>
<p>Overview of all managers' performance, rankings, and chip usage.</p>

<div style="margin-bottom: 1.5em;">
  <label for="view-select" style="font-weight: bold; margin-right: 0.5em;">View:</label>
  <select id="view-select" style="padding: 8px 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc;">
    <option value="custom">My Custom Managers</option>
    <option value="top50">World Top 50</option>
  </select>
  
  <span id="manager-count" style="margin-left: 1.5em; font-weight: bold;">Loading managers...</span>
  <a href="/managers" style="margin-left: 1em; color: #3182ce;">Manage IDs</a>
  <button id="refresh-btn" style="margin-left: 1em; padding: 5px 12px;">Refresh Data</button>
</div>

<div id="loading-status" style="margin-bottom: 1em; color: #666;"></div>
<div id="stats-output" style="margin-top:1.5em"></div>

<script>
import { supabase } from '../lib/supabase.ts'

let managerIds = []

async function loadManagerIdsFromSupabase() {
  const { data: { user } } = await supabase.auth.getUser()
  
  if (!user) {
    window.location.replace('/login')
    return { authenticated: false, managerIds: [] }
  }
  
  try {
    const { data, error } = await supabase
      .from('user_manager_lists')
      .select('manager_ids')
      .eq('user_id', user.id)
      .single()
    
    if (error && error.code !== 'PGRST116') {
      console.error('Error loading manager IDs:', error)
      return { authenticated: true, managerIds: [] }
    }
    
    return { authenticated: true, managerIds: data?.manager_ids || [] }
  } catch (e) {
    console.error('Error:', e)
    return { authenticated: false, managerIds: [] }
  }
}

const out = document.getElementById("stats-output");
const loadingStatus = document.getElementById("loading-status");
const managerCountEl = document.getElementById("manager-count");
const refreshBtn = document.getElementById("refresh-btn");
const viewSelect = document.getElementById("view-select");

let currentView = 'custom';
let customManagerIds = [];
let top50ManagerIds = [];

async function fetchTop50ManagerIds() {
  try {
    const response = await fetch('/api/fpl/leagues-classic/314/standings/?page_standings=1');
    if (!response.ok) return [];
    
    const data = await response.json();
    const standings = data.standings?.results || [];
    
    return standings.slice(0, 50).map(s => s.entry);
  } catch (error) {
    console.error('Error fetching top 50:', error);
    return [];
  }
}

async function fetchManagerSummary(id) {
  const summaryUrl = `/api/fpl/entry/${id}`;
  const historyUrl = `/api/fpl/entry/${id}/history`;
  
  try {
    const [summaryRes, historyRes] = await Promise.all([
      fetch(summaryUrl),
      fetch(historyUrl)
    ]);
    
    if (!summaryRes.ok || !historyRes.ok) throw new Error("Load error");
    
    const summaryData = await summaryRes.json();
    const historyData = await historyRes.json();
    
    const chips = historyData.chips || [];
    const chipsUsed = chips.length > 0 
      ? chips.map(c => {
          const name = c.name === "wildcard" ? "WC" :
                       c.name === "bboost" ? "BB" :
                       c.name === "3xc" ? "TC" :
                       c.name === "freehit" ? "FH" : c.name;
          return name;
        }).join(", ")
      : "None";
    
    return {
      entryId: Number(id),
      teamName: summaryData.name,
      firstName: summaryData.player_first_name,
      lastName: summaryData.player_last_name,
      managerName: `${summaryData.player_first_name} ${summaryData.player_last_name}`,
      totalPoints: summaryData.summary_overall_points,
      overallRank: summaryData.summary_overall_rank,
      gwPoints: summaryData.summary_event_points,
      gwRank: summaryData.summary_event_rank,
      chipsUsed
    };
  } catch (e) {
    console.error(`Error fetching manager ${id}:`, e);
    return null;
  }
}

function makeStatsTable(managersData) {
  let html = `<h2>League Standings</h2>
  <table border="1" cellpadding="6" style="border-collapse:collapse; width: 100%; max-width: 1200px;">
    <tr style="background:#f0f0f0">
      <th>Rank</th>
      <th>Manager</th>
      <th>Team Name</th>
      <th>Total Points</th>
      <th>Overall Rank</th>
      <th>GW Points</th>
      <th>GW Rank</th>
      <th>Chips Used</th>
    </tr>`;
  
  let rank = 1;
  for (const m of managersData) {
    html += `<tr>
      <td style="font-weight: bold; text-align: center;">${rank}</td>
      <td style="font-weight: bold;">${m.managerName}</td>
      <td>${m.teamName}</td>
      <td style="background:#e6ffe6; font-weight: bold; text-align: center;">${m.totalPoints.toLocaleString()}</td>
      <td style="text-align: center;">${m.overallRank.toLocaleString()}</td>
      <td style="text-align: center;">${m.gwPoints}</td>
      <td style="text-align: center;">${m.gwRank.toLocaleString()}</td>
      <td>${m.chipsUsed}</td>
    </tr>`;
    rank++;
  }
  html += "</table>";
  
  // Add summary stats
  const totalManagers = managersData.length;
  const avgPoints = Math.round(managersData.reduce((sum, m) => sum + m.totalPoints, 0) / totalManagers);
  const avgGWPoints = Math.round(managersData.reduce((sum, m) => sum + m.gwPoints, 0) / totalManagers);
  const leader = managersData[0];
  const lastPlace = managersData[managersData.length - 1];
  const pointsGap = leader.totalPoints - lastPlace.totalPoints;
  
  html += `<div style="margin-top: 2em; padding: 1em; background: #f7fafc; border-left: 4px solid #38a169; max-width: 1200px;">
    <h3>League Summary</h3>
    <ul style="line-height: 1.8;">
      <li><strong>Total Managers:</strong> ${totalManagers}</li>
      <li><strong>League Leader:</strong> ${leader.managerName} (${leader.totalPoints.toLocaleString()} pts)</li>
      <li><strong>Last Place:</strong> ${lastPlace.managerName} (${lastPlace.totalPoints.toLocaleString()} pts)</li>
      <li><strong>Points Gap:</strong> ${pointsGap.toLocaleString()} pts</li>
      <li><strong>Average Total Points:</strong> ${avgPoints.toLocaleString()}</li>
      <li><strong>Average GW Points:</strong> ${avgGWPoints}</li>
    </ul>
  </div>`;
  
  return html;
}

async function loadStats(ids) {
  if (ids.length === 0) {
    out.innerHTML = "<span style='color:red'>No manager IDs found. <a href='/managers'>Add managers here</a>.</span>";
    return;
  }

  const allData = [];
  out.innerHTML = "";
  loadingStatus.textContent = `Loading 0 of ${ids.length} managers...`;
  
  let loaded = 0;
  for (const id of ids) {
    try {
      const data = await fetchManagerSummary(id);
      if (data) {
        allData.push(data);
        loaded++;
        
        loadingStatus.textContent = `Loading ${loaded} of ${ids.length} managers...`;
        
        // Sort by Total Points DESC (best first)
        allData.sort((a, b) => b.totalPoints - a.totalPoints);
        
        // Progressive render
        out.innerHTML = makeStatsTable(allData);
      }
    } catch (e) {
      console.error(`Failed to load manager ${id}:`, e);
      loaded++;
    }
  }
  
  loadingStatus.innerHTML = `<span style='color:#38a169'>âœ… Loaded ${loaded} of ${ids.length} managers</span>`;
}

async function updateDisplay() {
  const ids = currentView === 'custom' ? customManagerIds : top50ManagerIds;
  
  if (currentView === 'custom') {
    managerCountEl.textContent = `${customManagerIds.length} manager(s) configured`;
    if (customManagerIds.length === 0) {
      out.innerHTML = "<span style='color:red'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</span>";
      return;
    }
  } else {
    managerCountEl.textContent = `Top 50 managers`;
    if (top50ManagerIds.length === 0) {
      loadingStatus.textContent = 'Fetching Top 50 managers...';
      top50ManagerIds = await fetchTop50ManagerIds();
      if (top50ManagerIds.length === 0) {
        out.innerHTML = "<span style='color:red'>Failed to fetch Top 50 managers. Please try again later.</span>";
        loadingStatus.textContent = '';
        return;
      }
    }
  }
  
  await loadStats(ids);
}

(async function init() {
  const { managerIds: ids } = await loadManagerIdsFromSupabase();
  customManagerIds = ids;
  
  await updateDisplay();
  
  viewSelect.addEventListener('change', () => {
    currentView = viewSelect.value;
    updateDisplay();
  });
})();

refreshBtn.addEventListener('click', async () => {
  if (currentView === 'custom') {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    customManagerIds = ids;
  } else {
    top50ManagerIds = await fetchTop50ManagerIds();
  }
  await updateDisplay();
});
</script>

<style>
  table {
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  th {
    font-weight: bold;
    padding: 8px;
  }
  td {
    padding: 6px;
  }
  h2 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }
  button {
    background: #3182ce;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    padding: 5px 12px;
  }
  button:hover {
    background: #2c5aa0;
  }
</style></body>
</html>
