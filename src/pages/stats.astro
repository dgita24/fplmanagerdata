---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="League Statistics & Manager Summary - FPL Manager Data">
  <Nav />

  <div class="page">
    <header class="page-header">
      <h1 class="page-title">League Statistics &amp; Manager Summary</h1>
      <p class="page-subtitle">
        Overview of all managers' performance, rankings, and chip usage.
      </p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading managers...</span>
      <a href="/managers" class="badge">âš™ Manage IDs</a>
    </div>

    <section class="controls" aria-label="Stats controls">
      <div class="control" style="grid-column: span 3;">
        <label class="label" for="gw-filter" style="white-space: nowrap;">Select GW</label>
        <input
          class="input"
          type="number"
          id="gw-filter"
          min="1"
          max="38"
          placeholder="Auto"
          inputmode="numeric"
          style="max-width: 180px;"
        />
      </div>

      <div class="control" style="grid-column: span 9;">
        <label class="label" style="white-space: nowrap;">Actions</label>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="refresh-btn" class="btn btn--primary" type="button">ðŸ”„ Refresh Data</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>

    <section id="stats-output" aria-live="polite"></section>

    <!-- Centered modal popup -->
    <div id="manager-modal" class="modal-overlay" style="display: none;">
      <div class="modal-popup">
        <div class="modal-header">
          <h3 id="modal-manager-name" class="modal-title"></h3>
          <button id="modal-close" class="modal-close-btn" aria-label="Close">âœ•</button>
        </div>
        <div class="modal-body" id="modal-content"></div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase.ts'

    async function loadManagerIdsFromSupabase() {
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        window.location.replace('/login')
        return { authenticated: false, managerIds: [] }
      }

      try {
        const { data, error } = await supabase
          .from('user_manager_lists')
          .select('manager_ids')
          .eq('user_id', user.id)
          .single()

        if (error && error.code !== 'PGRST116') {
          console.error('Error loading manager IDs:', error)
          return { authenticated: true, managerIds: [] }
        }

        return { authenticated: true, managerIds: data?.manager_ids || [] }
      } catch (e) {
        console.error('Error:', e)
        return { authenticated: false, managerIds: [] }
      }
    }

    let latestGW = 1;

    async function fetchBootstrapData() {
      try {
        const res = await fetch('/api/fpl/bootstrap-static');
        if (!res.ok) throw new Error("Failed to fetch bootstrap data");
        const data = await res.json();

        const currentEvent = (data.events || []).find(e => e.is_current);
        latestGW = currentEvent ? currentEvent.id : 1;
      } catch (e) {
        console.error("Error fetching bootstrap data:", e);
        latestGW = 1;
      }
    }

    const out = document.getElementById("stats-output");
    const loadingStatus = document.getElementById("loading-status");
    const managerCountEl = document.getElementById("manager-count");
    const refreshBtn = document.getElementById("refresh-btn");
    const gwFilterInput = document.getElementById("gw-filter");

    const modal = document.getElementById("manager-modal");
    const modalContent = document.getElementById("modal-content");
    const modalManagerName = document.getElementById("modal-manager-name");
    const modalCloseBtn = document.getElementById("modal-close");

    let managerIds = [];
    let managersData = [];

    function chipLabel(name) {
      return name === "wildcard" ? "WC" :
             name === "bboost" ? "BB" :
             name === "3xc" ? "TC" :
             name === "freehit" ? "FH" :
             name;
    }

    function chipsUsedCountsFromHistory(historyData) {
      const chips = historyData?.chips || [];
      if (!Array.isArray(chips) || chips.length === 0) return [];

      const order = [];
      const counts = new Map();

      for (const c of chips) {
        const label = chipLabel(c.name);
        if (!counts.has(label)) order.push(label);
        counts.set(label, (counts.get(label) || 0) + 1);
      }

      return order.map(label => ({ label, count: counts.get(label) || 0 }));
    }

    function gwStatsFromHistory(historyData, gw) {
      const current = Array.isArray(historyData?.current) ? historyData.current : [];
      const row = current.find(r => Number(r.event) === Number(gw));
      return {
        gwPoints: row ? Number(row.points) || 0 : 0,
        gwRank: row ? Number(row.rank) || 0 : 0
      };
    }

    async function fetchManagerSummary(id, gw) {
      try {
        const [summaryRes, historyRes] = await Promise.all([
          fetch(`/api/fpl/entry/${id}`),
          fetch(`/api/fpl/entry/${id}/history`)
        ]);

        if (!summaryRes.ok || !historyRes.ok) throw new Error("Load error");

        const summaryData = await summaryRes.json();
        const historyData = await historyRes.json();

        return {
          entryId: Number(id),
          managerName: `${summaryData.player_first_name} ${summaryData.player_last_name}`.trim(),
          totalPoints: Number(summaryData.summary_overall_points) || 0,
          overallRank: Number(summaryData.summary_overall_rank) || 0,
          ...gwStatsFromHistory(historyData, gw),
          chipsUsedCounts: chipsUsedCountsFromHistory(historyData)
        };
      } catch (e) {
        console.error(`Error fetching manager ${id}:`, e);
        return null;
      }
    }

    function chipBadgeStyle(label, count) {
      const isTwice = Number(count) >= 2;

      const palette = {
        WC: { lightBg: '#FDE68A', darkBg: '#B45309', lightText: '#3B2F00', darkText: '#FFFFFF' },
        BB: { lightBg: '#BBF7D0', darkBg: '#15803D', lightText: '#052E16', darkText: '#FFFFFF' },
        TC: { lightBg: '#FECACA', darkBg: '#B91C1C', lightText: '#450A0A', darkText: '#FFFFFF' },
        FH: { lightBg: '#FED7AA', darkBg: '#C2410C', lightText: '#431407', darkText: '#FFFFFF' }
      };

      const p = palette[label] || { lightBg: '#E2E8F0', darkBg: '#475569', lightText: '#0F172A', darkText: '#FFFFFF' };
      const bg = isTwice ? p.darkBg : p.lightBg;
      const fg = isTwice ? p.darkText : p.lightText;
      const border = isTwice ? 'rgba(0,0,0,0.10)' : 'rgba(0,0,0,0.08)';

      return `background:${bg}; color:${fg}; border:1px solid ${border};`;
    }

    function chipsDisplayHtml(chipsCounts) {
      if (!chipsCounts || chipsCounts.length === 0) {
        return `<span style="color: var(--muted); font-style: italic;">No chips used</span>`;
      }

      return `
        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;">
          ${chipsCounts.map(({ label, count }) => {
            const text = `${label}Ã—${count}`;
            const style = chipBadgeStyle(label, count);
            return `<span class="badge badge--chip" style="${style}">${text}</span>`;
          }).join("")}
        </div>
      `;
    }

    function chipsInlineCountsHtml(chipsCounts) {
      if (!chipsCounts || chipsCounts.length === 0) {
        return `<span style="color: var(--muted);">None</span>`;
      }

      return `
        <div style="
          display: flex;
          gap: 4px;
          flex-wrap: wrap;
          margin-top: 4px;
          max-width: 100%;
        ">
          ${chipsCounts.map(({ label, count }) => {
            const text = `${label}Ã—${count}`;
            const style = chipBadgeStyle(label, count);
            return `<span class="badge badge--chip" style="${style}">${text}</span>`;
          }).join("")}
        </div>
      `;
    }

    // Desktop table view
    function makeStatsTable(managersData, gw) {
      let html = `
        <h2 class="page-title desktop-only" style="font-size: 1.1rem;">League Standings (GW${gw})</h2>

        <div class="table-shell desktop-only">
          <div class="table-scroll" role="region" aria-label="League standings table">
            <table class="data-table" style="min-width: 720px;">
              <thead>
                <tr>
                  <th class="num" style="width: 52px;">Rank</th>
                  <th style="min-width: 180px;">Manager<br/><span style="font-weight: 600; color: var(--muted);">Chips Used</span></th>
                  <th class="num" style="width: 84px;">Total<br/>Points</th>
                  <th class="num" style="width: 98px;">Overall<br/>Rank</th>
                  <th class="num" style="width: 64px;">GW<br/>Pts</th>
                  <th class="num" style="width: 72px;">GW<br/>Rank</th>
                </tr>
              </thead>
              <tbody>
      `;

      let rank = 1;
      for (const m of managersData) {
        html += `
          <tr>
            <td class="num strong">${rank}</td>
            <td>
              <a href="/squads?manager=${m.entryId}" style="
                display: block;
                font-size: 1.15rem;
                font-weight: 700;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.2;
              ">
                ${m.managerName}
              </a>
              ${chipsInlineCountsHtml(m.chipsUsedCounts)}
            </td>
            <td class="num strong">${Number(m.totalPoints).toLocaleString()}</td>
            <td class="num">${Number(m.overallRank).toLocaleString()}</td>
            <td class="num">${Number(m.gwPoints).toLocaleString()}</td>
            <td class="num">${Number(m.gwRank).toLocaleString()}</td>
          </tr>
        `;
        rank++;
      }

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;

      return html;
    }

    // Mobile card view - ONE LINE PER MANAGER
    function makeManagerCards(data) {
      let html = `<div class="manager-cards mobile-only">`;

      let rank = 1;
      for (const m of data) {
        html += `
          <div class="manager-card" data-manager-id="${m.entryId}">
            <div class="card-rank">${rank}</div>
            <div class="card-name">${m.managerName}</div>
            <div class="card-points">${Number(m.totalPoints).toLocaleString()}</div>
            <button class="card-expand-btn" aria-label="View details for ${m.managerName}">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        `;
        rank++;
      }

      html += `</div>`;
      return html;
    }

    function openModal(manager) {
      modalManagerName.textContent = manager.managerName;

      modalContent.innerHTML = `
        <div class="modal-stat-row">
          <span class="modal-stat-label">Overall Rank</span>
          <span class="modal-stat-value">${Number(manager.overallRank).toLocaleString()}</span>
        </div>
        <div class="modal-stat-row">
          <span class="modal-stat-label">GW Points</span>
          <span class="modal-stat-value">${Number(manager.gwPoints).toLocaleString()}</span>
        </div>
        <div class="modal-stat-row">
          <span class="modal-stat-label">GW Rank</span>
          <span class="modal-stat-value">${Number(manager.gwRank).toLocaleString()}</span>
        </div>
        <div class="modal-stat-row" style="flex-direction: column; align-items: flex-start;">
          <span class="modal-stat-label" style="margin-bottom: 4px;">Chips Used</span>
          ${chipsDisplayHtml(manager.chipsUsedCounts)}
        </div>
      `;

      modal.style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      modal.style.display = "none";
      document.body.style.overflow = "";
    }

    modalCloseBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    function resetStatsTableScrollHard() {
      const els = document.querySelectorAll('#stats-output .table-scroll');
      els.forEach(el => { el.scrollLeft = 0; });

      requestAnimationFrame(() => {
        els.forEach(el => { el.scrollLeft = 0; });
      });

      setTimeout(() => {
        els.forEach(el => { el.scrollLeft = 0; });
      }, 50);

      setTimeout(() => {
        els.forEach(el => { el.scrollLeft = 0; });
      }, 250);
    }

    async function loadStats(ids, gw) {
      if (ids.length === 0) {
        out.innerHTML = "<span style='color:red'>No manager IDs found. <a href='/managers'>Add managers here</a>.</span>";
        return;
      }

      managersData = [];
      out.innerHTML = "";
      loadingStatus.textContent = `Loading 0 of ${ids.length} managers for GW${gw}...`;

      let loaded = 0;
      for (const id of ids) {
        const data = await fetchManagerSummary(id, gw);
        if (data) {
          managersData.push(data);
        }
        loaded++;
        loadingStatus.textContent = `Loading ${loaded} of ${ids.length} managers...`;

        managersData.sort((a, b) => b.totalPoints - a.totalPoints);
        
        // Render both desktop table and mobile cards
        out.innerHTML = makeStatsTable(managersData, gw) + makeManagerCards(managersData);

        resetStatsTableScrollHard();

        // Attach click handlers to mobile cards
        document.querySelectorAll('.card-expand-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.manager-card');
            const managerId = Number(card.dataset.managerId);
            const manager = managersData.find(m => m.entryId === managerId);
            if (manager) openModal(manager);
          });
        });
      }

      loadingStatus.innerHTML = `<span style='color:#16a34a; font-weight: 700;'>âœ… Loaded ${loaded} of ${ids.length} managers (GW${gw})</span>`;
      resetStatsTableScrollHard();
    }

    async function updateDisplay() {
      managerCountEl.textContent = `${managerIds.length} manager(s) configured`;
      if (managerIds.length === 0) {
        out.innerHTML = "<span style='color:red'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</span>";
        return;
      }

      const gw = parseInt(gwFilterInput.value) || latestGW;
      await loadStats(managerIds, gw);
    }

    (async function init() {
      await fetchBootstrapData();

      gwFilterInput.value = latestGW;
      gwFilterInput.placeholder = `Latest: GW${latestGW}`;

      const { managerIds: ids } = await loadManagerIdsFromSupabase();
      managerIds = ids;

      await updateDisplay();
    })();

    gwFilterInput.addEventListener('change', async () => {
      const gw = parseInt(gwFilterInput.value);
      if (gw && gw >= 1 && gw <= 38) {
        await loadStats(managerIds, gw);
      }
    });

    refreshBtn.addEventListener('click', async () => {
      const { managerIds: ids } = await loadManagerIdsFromSupabase();
      managerIds = ids;
      await updateDisplay();
    });
  </script>

  <style>
    /* CRITICAL: Only show ONE view at a time */
    .desktop-only {
      display: none;
    }

    .mobile-only {
      display: block;
    }

    @media (min-width: 640px) {
      .desktop-only {
        display: block;
      }

      .mobile-only {
        display: none !important;
      }
    }

    /* Mobile cards - ONE LINE per manager, full width */
    .manager-cards {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .manager-card {
      display: grid;
      grid-template-columns: 36px 1fr auto 32px;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #fff;
      min-height: 44px;
    }

    .card-rank {
      font-size: 0.95rem;
      font-weight: 900;
      color: var(--text);
      text-align: center;
    }

    .card-name {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-points {
      font-size: 0.95rem;
      font-weight: 900;
      color: var(--primary);
      white-space: nowrap;
    }

    .card-expand-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
    }

    .card-expand-btn:active {
      transform: scale(0.9);
    }

    /* Centered modal popup */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-popup {
      background: #fff;
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-height: 90vh;
      overflow-y: auto;
      animation: popIn 0.2s ease-out;
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: #fff;
      border-radius: 12px 12px 0 0;
    }

    .modal-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }

    .modal-close-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--muted);
      transition: all 0.2s;
    }

    .modal-close-btn:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
      display: grid;
      gap: 12px;
    }

    .modal-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--surface);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .modal-stat-label {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--muted);
    }

    .modal-stat-value {
      font-size: 1.05rem;
      font-weight: 900;
      color: var(--text);
    }
  </style>
</Layout>
