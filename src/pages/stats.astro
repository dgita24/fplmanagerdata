---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="League Statistics - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">League Statistics</h1>
      <p class="page-subtitle">Overview of all managers' performance, rankings, and chip usage.</p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading managers...</span>
      <a href="/managers" class="badge">âš™ Manage IDs</a>
    </div>

    <section class="controls">
      <div class="control">
        <label class="label" for="gw-filter">Select GW</label>
        <input class="input" type="number" id="gw-filter" min="1" max="38" placeholder="Auto" inputmode="numeric" />
      </div>

      <div class="control">
        <label class="label">Actions</label>
        <div class="control-actions">
          <button id="refresh-btn" class="btn btn--primary" type="button">ðŸ”„ Refresh</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>
    <section id="stats-output" aria-live="polite"></section>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase.ts'

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  let latestGW = 1;

  async function fetchBootstrapData() {
    try {
      const res = await fetch('/api/fpl/bootstrap-static');
      if (!res.ok) throw new Error("Failed to fetch bootstrap data");
      const data = await res.json();

      const currentEvent = (data.events || []).find(e => e.is_current);
      latestGW = currentEvent ? currentEvent.id : 1;
    } catch (e) {
      console.error("Error fetching bootstrap data:", e);
      latestGW = 1;
    }
  }

  const out = document.getElementById("stats-output");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");
  const gwFilterInput = document.getElementById("gw-filter");

  let managerIds = [];
  let lastManagersData = [];

  function chipLabel(name) {
    return name === "wildcard" ? "WC" :
           name === "bboost" ? "BB" :
           name === "3xc" ? "TC" :
           name === "freehit" ? "FH" :
           name;
  }

  function chipsUsedArrayFromHistory(historyData) {
    const chips = historyData?.chips || [];
    if (!Array.isArray(chips) || chips.length === 0) return [];

    const used = [];
    for (const c of chips) {
      const label = chipLabel(c.name);
      if (!used.includes(label)) used.push(label);
    }
    return used;
  }

  function gwStatsFromHistory(historyData, gw) {
    const current = Array.isArray(historyData?.current) ? historyData.current : [];
    const row = current.find(r => Number(r.event) === Number(gw));
    return {
      gwPoints: row ? Number(row.points) || 0 : 0,
      gwRank: row ? Number(row.rank) || 0 : 0
    };
  }

  async function fetchManagerSummary(id, gw) {
    const summaryUrl = `/api/fpl/entry/${id}`;
    const historyUrl = `/api/fpl/entry/${id}/history`;

    try {
      const [summaryRes, historyRes] = await Promise.all([
        fetch(summaryUrl),
        fetch(historyUrl)
      ]);

      if (!summaryRes.ok || !historyRes.ok) throw new Error("Load error");

      const summaryData = await summaryRes.json();
      const historyData = await historyRes.json();

      const chipsUsedArr = chipsUsedArrayFromHistory(historyData);
      const { gwPoints, gwRank } = gwStatsFromHistory(historyData, gw);

      return {
        entryId: Number(id),
        teamName: summaryData.name,
        managerName: `${summaryData.player_first_name} ${summaryData.player_last_name}`.trim(),
        totalPoints: Number(summaryData.summary_overall_points) || 0,
        overallRank: Number(summaryData.summary_overall_rank) || 0,
        gwPoints,
        gwRank,
        chipsUsedArr
      };
    } catch (e) {
      console.error(`Error fetching manager ${id}:`, e);
      return null;
    }
  }

  function chipsGridHtml(chipsArr) {
    if (!chipsArr || chipsArr.length === 0) return `<span class="text-muted">None</span>`;

    return chipsArr.slice(0, 8).map(c => `<span class="badge">${c}</span>`).join(" ");
  }

  function makeStatsTable(managersData, gw) {
    let html = `
      <h2 class="section-title">League Standings (GW${gw})</h2>
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table">
            <thead>
              <tr>
                <th class="num">Rank</th>
                <th>Manager</th>
                <th>Team Name</th>
                <th class="num">Total Pts</th>
                <th class="num">Overall Rank</th>
                <th class="num">GW Pts</th>
                <th class="num">GW Rank</th>
              </tr>
            </thead>
            <tbody>
    `;

    let rank = 1;
    for (const m of managersData) {
      html += `
        <tr>
          <td class="num strong">${rank}</td>
          <td class="strong">
            <a href="/squads?manager=${m.entryId}">${m.managerName}</a>
          </td>
          <td class="truncate">${m.teamName}</td>
          <td class="num strong">${Number(m.totalPoints).toLocaleString()}</td>
          <td class="num">${Number(m.overallRank).toLocaleString()}</td>
          <td class="num">${Number(m.gwPoints).toLocaleString()}</td>
          <td class="num">${Number(m.gwRank).toLocaleString()}</td>
        </tr>
      `;
      rank++;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    return html;
  }

  async function loadStats(ids, gw) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    const allData = [];
    lastManagersData = [];
    out.innerHTML = "";
    loadingStatus.textContent = `Loading 0 of ${ids.length} managers for GW${gw}...`;

    let loaded = 0;
    for (const id of ids) {
      try {
        const data = await fetchManagerSummary(id, gw);
        if (data) {
          allData.push(data);
          loaded++;

          loadingStatus.textContent = `Loading ${loaded} of ${ids.length} managers...`;

          allData.sort((a, b) => b.totalPoints - a.totalPoints);

          lastManagersData = allData;
          out.innerHTML = makeStatsTable(allData, gw);
        }
      } catch (e) {
        console.error(`Failed to load manager ${id}:`, e);
        loaded++;
      }
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>âœ… Loaded ${loaded} of ${ids.length} managers (GW${gw})</span>`;
  }

  async function updateDisplay() {
    managerCountEl.textContent = `${managerIds.length} manager(s) configured`;
    if (managerIds.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    const gw = parseInt(gwFilterInput.value) || latestGW;
    await loadStats(managerIds, gw);
  }

  (async function init() {
    await fetchBootstrapData();

    gwFilterInput.value = latestGW;
    gwFilterInput.placeholder = `Latest: GW${latestGW}`;

    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;

    await updateDisplay();
  })();

  gwFilterInput.addEventListener('change', async () => {
    const gw = parseInt(gwFilterInput.value);
    if (gw && gw >= 1 && gw <= 38) {
      await loadStats(managerIds, gw);
    }
  });

  refreshBtn.addEventListener('click', async () => {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;
    await updateDisplay();
  });
</script>