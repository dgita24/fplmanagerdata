---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="League Statistics - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">League Statistics</h1>
      <p class="page-subtitle">Manager performance, rankings, and chip usage.</p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading...</span>
      <a href="/managers" class="badge">âš™ Manage IDs</a>
    </div>

    <section class="controls">
      <div class="control">
        <label class="label" for="gw-filter">Gameweek</label>
        <select class="select" id="gw-filter">
          <option value="">Select GW</option>
        </select>
      </div>

      <div class="control">
        <label class="label">Actions</label>
        <div class="control-actions">
          <button id="refresh-btn" class="btn btn--primary" type="button">ðŸ”„ Refresh</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>
    <section id="stats-output" aria-live="polite"></section>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase.ts'

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  let latestGW = 1;

  const out = document.getElementById("stats-output");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");
  const gwFilterSelect = document.getElementById("gw-filter");

  let managerIds = [];

  function populateGWSelector(currentGW) {
    gwFilterSelect.innerHTML = '';
    for (let i = 1; i <= 38; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `GW ${i}`;
      if (i === currentGW) option.selected = true;
      gwFilterSelect.appendChild(option);
    }
  }

  async function fetchBootstrapData() {
    try {
      const res = await fetch('/api/fpl/bootstrap-static');
      if (!res.ok) throw new Error("Failed to fetch bootstrap data");
      const data = await res.json();

      const currentEvent = (data.events || []).find(e => e.is_current);
      latestGW = currentEvent ? currentEvent.id : 1;

      populateGWSelector(latestGW);
    } catch (e) {
      console.error("Error fetching bootstrap data:", e);
      latestGW = 1;
    }
  }

  function gwStatsFromHistory(historyData, gw) {
    const current = Array.isArray(historyData?.current) ? historyData.current : [];
    const row = current.find(r => Number(r.event) === Number(gw));
    return {
      gwPoints: row ? Number(row.points) || 0 : 0,
      gwRank: row ? Number(row.rank) || 0 : 0
    };
  }

  async function fetchManagerSummary(id, gw) {
    const summaryUrl = `/api/fpl/entry/${id}`;
    const historyUrl = `/api/fpl/entry/${id}/history`;

    try {
      const [summaryRes, historyRes] = await Promise.all([
        fetch(summaryUrl),
        fetch(historyUrl)
      ]);

      if (!summaryRes.ok || !historyRes.ok) throw new Error("Load error");

      const summaryData = await summaryRes.json();
      const historyData = await historyRes.json();

      const { gwPoints, gwRank } = gwStatsFromHistory(historyData, gw);

      return {
        entryId: Number(id),
        teamName: summaryData.name,
        managerName: `${summaryData.player_first_name} ${summaryData.player_last_name}`.trim(),
        totalPoints: Number(summaryData.summary_overall_points) || 0,
        overallRank: Number(summaryData.summary_overall_rank) || 0,
        gwPoints,
        gwRank
      };
    } catch (e) {
      console.error(`Error fetching manager ${id}:`, e);
      return null;
    }
  }

  function makeStatsTable(managersData, gw) {
    let html = `
      <h2 class="section-title">Standings (GW${gw})</h2>
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table">
            <thead>
              <tr>
                <th class="num" style="width:28px;">#</th>
                <th>Manager</th>
                <th class="num" style="width:50px;">Total</th>
                <th class="num" style="width:60px;">OR</th>
                <th class="num" style="width:40px;">GW</th>
                <th class="num" style="width:60px;">GWR</th>
              </tr>
            </thead>
            <tbody>
    `;

    let rank = 1;
    for (const m of managersData) {
      html += `
        <tr>
          <td class="num strong">${rank}</td>
          <td class="manager-cell">
            <a href="/squads?manager=${m.entryId}" class="strong">${m.managerName}</a>
            <div class="team-name">${m.teamName}</div>
          </td>
          <td class="num strong">${m.totalPoints.toLocaleString()}</td>
          <td class="num">${m.overallRank.toLocaleString()}</td>
          <td class="num">${m.gwPoints}</td>
          <td class="num">${m.gwRank.toLocaleString()}</td>
        </tr>
      `;
      rank++;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    return html;
  }

  async function loadStats(ids, gw) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    const allData = [];
    out.innerHTML = "";
    loadingStatus.textContent = `Loading 0 of ${ids.length}...`;

    let loaded = 0;
    for (const id of ids) {
      try {
        const data = await fetchManagerSummary(id, gw);
        if (data) {
          allData.push(data);
          loaded++;

          loadingStatus.textContent = `Loading ${loaded} of ${ids.length}...`;

          allData.sort((a, b) => b.totalPoints - a.totalPoints);
          out.innerHTML = makeStatsTable(allData, gw);
        }
      } catch (e) {
        console.error(`Failed to load manager ${id}:`, e);
        loaded++;
      }
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>âœ… Loaded ${loaded} managers</span>`;
  }

  async function updateDisplay() {
    managerCountEl.textContent = `${managerIds.length} managers`;
    if (managerIds.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    const gw = parseInt(gwFilterSelect.value) || latestGW;
    await loadStats(managerIds, gw);
  }

  (async function init() {
    await fetchBootstrapData();

    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;

    await updateDisplay();
  })();

  gwFilterSelect.addEventListener('change', async () => {
    const gw = parseInt(gwFilterSelect.value);
    if (gw && gw >= 1 && gw <= 38) {
      await loadStats(managerIds, gw);
    }
  });

  refreshBtn.addEventListener('click', async () => {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;
    await updateDisplay();
  });
</script>