---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="League Statistics & Manager Summary - FPL Manager Data">
  <Nav />

  <!-- Mobile table fallback: turn rows into readable "cards" (no sticky required) -->
  <style>
    /* Hide the mobile 2-col summary cell on desktop/tablet */
    .stats-grid-2 { display: none; }
    .stats-hide-on-mobile { display: table-cell; }

    @media (max-width: 560px) {
      /* On mobile we don't want horizontal scrolling; we want stacked cards */
      .table-scroll { overflow-x: visible; overflow-y: visible; }
      .data-table { min-width: 0 !important; width: 100%; }

      /* Hide header row */
      .data-table thead { display: none; }

      /* Convert table rows/cells into blocks */
      .data-table tbody,
      .data-table tr,
      .data-table td { display: block; width: 100%; }

      .data-table tbody tr {
        border: 1px solid var(--border);
        border-radius: 12px;
        margin: 10px 0;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        background: #fff;
      }

      .data-table tbody tr td {
        border: 0;
        border-bottom: 1px solid var(--border);
        padding: 10px 12px;
        background: #fff;
      }

      .data-table tbody tr td:last-child {
        border-bottom: 0;
      }

      /* Each normal cell shows "Label" above the value */
      .data-table tbody tr td::before {
        content: attr(data-label);
        display: block;
        font-size: 0.85rem;
        color: var(--muted);
        font-weight: 800;
        margin-bottom: 4px;
      }

      /* Manager cell becomes the card header */
      .stats-manager-cell {
        padding: 12px 12px;
      }
      .stats-manager-cell::before {
        content: "Manager";
      }
      .stats-manager-cell a {
        display: inline-block;
        font-size: 1.15rem;
        font-weight: 900;
        line-height: 1.2;
        white-space: normal;
        word-break: break-word;
      }

      /* Hide these desktop-only cells on mobile */
      .stats-hide-on-mobile { display: none !important; }

      /* Show the mobile 2-column summary block on mobile */
      .stats-grid-2 { display: grid !important; }

      .stats-grid-2 {
        grid-template-columns: 1fr 1fr;
        gap: 0;
        padding: 0 !important;
      }

      /* Remove the generic td label for the summary block */
      .stats-grid-2::before { content: ""; display: none; }

      .stats-grid-2 > div {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
      }

      .stats-grid-2 > div:nth-child(odd) {
        border-right: 1px solid var(--border);
      }

      /* Last row in the 2x2 grid: remove bottom borders */
      .stats-grid-2 > div:nth-last-child(-n + 2) {
        border-bottom: 0;
      }
    }
  </style>

  <div class="page">
    <header class="page-header">
      <h1 class="page-title">League Statistics &amp; Manager Summary</h1>
      <p class="page-subtitle">
        Overview of all managers' performance, rankings, and chip usage.
      </p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading managers...</span>
      <a href="/managers" class="badge">âš™ Manage IDs</a>
    </div>

    <section class="controls" aria-label="Stats controls">
      <div class="control" style="grid-column: span 3;">
        <label class="label" for="gw-filter" style="white-space: nowrap;">Select GW</label>
        <input
          class="input"
          type="number"
          id="gw-filter"
          min="1"
          max="38"
          placeholder="Auto"
          inputmode="numeric"
          style="max-width: 180px;"
        />
      </div>

      <div class="control" style="grid-column: span 9;">
        <label class="label" style="white-space: nowrap;">Actions</label>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="refresh-btn" class="btn btn--primary" type="button">ðŸ”„ Refresh Data</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>

    <section id="stats-output" aria-live="polite"></section>
  </div>

  <script>
    import { supabase } from '../lib/supabase.ts'

    async function loadManagerIdsFromSupabase() {
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        window.location.replace('/login')
        return { authenticated: false, managerIds: [] }
      }

      try {
        const { data, error } = await supabase
          .from('user_manager_lists')
          .select('manager_ids')
          .eq('user_id', user.id)
          .single()

        if (error && error.code !== 'PGRST116') {
          console.error('Error loading manager IDs:', error)
          return { authenticated: true, managerIds: [] }
        }

        return { authenticated: true, managerIds: data?.manager_ids || [] }
      } catch (e) {
        console.error('Error:', e)
        return { authenticated: false, managerIds: [] }
      }
    }

    let latestGW = 1;

    async function fetchBootstrapData() {
      try {
        const res = await fetch('/api/fpl/bootstrap-static');
        if (!res.ok) throw new Error("Failed to fetch bootstrap data");
        const data = await res.json();

        const currentEvent = (data.events || []).find(e => e.is_current);
        latestGW = currentEvent ? currentEvent.id : 1;
      } catch (e) {
        console.error("Error fetching bootstrap data:", e);
        latestGW = 1;
      }
    }

    const out = document.getElementById("stats-output");
    const loadingStatus = document.getElementById("loading-status");
    const managerCountEl = document.getElementById("manager-count");
    const refreshBtn = document.getElementById("refresh-btn");
    const gwFilterInput = document.getElementById("gw-filter");

    let managerIds = [];

    function chipLabel(name) {
      return name === "wildcard" ? "WC" :
             name === "bboost" ? "BB" :
             name === "3xc" ? "TC" :
             name === "freehit" ? "FH" :
             name;
    }

    function chipsUsedArrayFromHistory(historyData) {
      const chips = historyData?.chips || [];
      if (!Array.isArray(chips) || chips.length === 0) return [];

      const used = [];
      for (const c of chips) {
        const label = chipLabel(c.name);
        if (!used.includes(label)) used.push(label);
      }
      return used;
    }

    function gwStatsFromHistory(historyData, gw) {
      const current = Array.isArray(historyData?.current) ? historyData.current : [];
      const row = current.find(r => Number(r.event) === Number(gw));
      return {
        gwPoints: row ? Number(row.points) || 0 : 0,
        gwRank: row ? Number(row.rank) || 0 : 0
      };
    }

    async function fetchManagerSummary(id, gw) {
      const summaryUrl = `/api/fpl/entry/${id}`;
      const historyUrl = `/api/fpl/entry/${id}/history`;

      try {
        const [summaryRes, historyRes] = await Promise.all([
          fetch(summaryUrl),
          fetch(historyUrl)
        ]);

        if (!summaryRes.ok || !historyRes.ok) throw new Error("Load error");

        const summaryData = await summaryRes.json();
        const historyData = await historyRes.json();

        const chipsUsedArr = chipsUsedArrayFromHistory(historyData);
        const { gwPoints, gwRank } = gwStatsFromHistory(historyData, gw);

        return {
          entryId: Number(id),
          teamName: summaryData.name,
          managerName: `${summaryData.player_first_name} ${summaryData.player_last_name}`.trim(),
          totalPoints: Number(summaryData.summary_overall_points) || 0,
          overallRank: Number(summaryData.summary_overall_rank) || 0,
          gwPoints,
          gwRank,
          chipsUsedArr
        };
      } catch (e) {
        console.error(`Error fetching manager ${id}:`, e);
        return null;
      }
    }

    function chipsGridHtml(chipsArr) {
      if (!chipsArr || chipsArr.length === 0) return `<span style="color: var(--muted);">None</span>`;

      const limited = chipsArr.slice(0, 8);

      return `
        <div style="
          display: grid;
          grid-template-columns: repeat(4, max-content);
          gap: 6px 8px;
          align-items: center;
          max-width: 100%;
        ">
          ${limited.map(c => `<span class="badge" style="padding: 2px 8px;">${c}</span>`).join("")}
        </div>
      `;
    }

    function makeStatsTable(managersData, gw) {
      let html = `
        <h2 class="page-title" style="font-size: 1.1rem;">League Standings (GW${gw})</h2>

        <div class="table-shell">
          <div class="table-scroll" role="region" aria-label="League standings table" tabindex="0">
            <table class="data-table" style="min-width: 760px;">
              <thead>
                <tr>
                  <th class="num" style="width: 56px;">Rank</th>
                  <th style="width: 200px;">Manager</th>
                  <th style="width: 180px;">Team<br/>Name</th>
                  <th class="num" style="width: 90px;">Total<br/>Points</th>
                  <th class="num" style="width: 110px;">Overall<br/>Rank</th>
                  <th class="num" style="width: 90px;">GW<br/>Points</th>
                  <th class="num" style="width: 90px;">GW<br/>Rank</th>
                  <th style="width: 220px;">Chips<br/>Used</th>
                </tr>
              </thead>
              <tbody>
      `;

      let rank = 1;
      for (const m of managersData) {
        html += `
          <tr>
            <td class="num strong stats-hide-on-mobile" data-label="Rank">${rank}</td>

            <td class="stats-manager-cell" data-label="Manager" style="font-size: 1.15rem; font-weight: 700;">
              <a href="/squads?manager=${m.entryId}">
                ${m.managerName}
              </a>
            </td>

            <td data-label="Team Name" style="width:180px; white-space: normal; overflow-wrap: break-word; line-height: 1.2;">
              ${m.teamName}
            </td>

            <!-- Desktop-only numeric cells -->
            <td class="num strong stats-hide-on-mobile" data-label="Total Points">${Number(m.totalPoints).toLocaleString()}</td>
            <td class="num stats-hide-on-mobile" data-label="Overall Rank">${Number(m.overallRank).toLocaleString()}</td>
            <td class="num stats-hide-on-mobile" data-label="GW Points">${Number(m.gwPoints).toLocaleString()}</td>
            <td class="num stats-hide-on-mobile" data-label="GW Rank">${Number(m.gwRank).toLocaleString()}</td>

            <!-- Mobile-only 2x2 summary grid (replaces the 4 cells above) -->
            <td class="stats-grid-2" data-label="Summary">
              <div>
                <div style="font-size: 0.85rem; color: var(--muted); font-weight: 800; margin-bottom: 4px;">Total Points</div>
                <div class="strong">${Number(m.totalPoints).toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 0.85rem; color: var(--muted); font-weight: 800; margin-bottom: 4px;">Overall Rank</div>
                <div>${Number(m.overallRank).toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 0.85rem; color: var(--muted); font-weight: 800; margin-bottom: 4px;">GW Points</div>
                <div>${Number(m.gwPoints).toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 0.85rem; color: var(--muted); font-weight: 800; margin-bottom: 4px;">GW Rank</div>
                <div>${Number(m.gwRank).toLocaleString()}</div>
              </div>
            </td>

            <td data-label="Chips Used">
              ${chipsGridHtml(m.chipsUsedArr)}
            </td>
          </tr>
        `;
        rank++;
      }

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;

      return html;
    }

    async function loadStats(ids, gw) {
      if (ids.length === 0) {
        out.innerHTML = "<span style='color:red'>No manager IDs found. <a href='/managers'>Add managers here</a>.</span>";
        return;
      }

      const allData = [];
      out.innerHTML = "";
      loadingStatus.textContent = `Loading 0 of ${ids.length} managers for GW${gw}...`;

      let loaded = 0;
      for (const id of ids) {
        try {
          const data = await fetchManagerSummary(id, gw);
          if (data) {
            allData.push(data);
            loaded++;

            loadingStatus.textContent = `Loading ${loaded} of ${ids.length} managers...`;

            allData.sort((a, b) => b.totalPoints - a.totalPoints);

            out.innerHTML = makeStatsTable(allData, gw);
          }
        } catch (e) {
          console.error(`Failed to load manager ${id}:`, e);
          loaded++;
        }
      }

      loadingStatus.innerHTML = `<span style='color:#16a34a; font-weight: 700;'>âœ… Loaded ${loaded} of ${ids.length} managers (GW${gw})</span>`;
    }

    async function updateDisplay() {
      managerCountEl.textContent = `${managerIds.length} manager(s) configured`;
      if (managerIds.length === 0) {
        out.innerHTML = "<span style='color:red'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</span>";
        return;
      }

      const gw = parseInt(gwFilterInput.value) || latestGW;
      await loadStats(managerIds, gw);
    }

    (async function init() {
      await fetchBootstrapData();

      gwFilterInput.value = latestGW;
      gwFilterInput.placeholder = `Latest: GW${latestGW}`;

      const { managerIds: ids } = await loadManagerIdsFromSupabase();
      managerIds = ids;

      await updateDisplay();
    })();

    gwFilterInput.addEventListener('change', async () => {
      const gw = parseInt(gwFilterInput.value);
      if (gw && gw >= 1 && gw <= 38) {
        await loadStats(managerIds, gw);
      }
    });

    refreshBtn.addEventListener('click', async () => {
      const { managerIds: ids } = await loadManagerIdsFromSupabase();
      managerIds = ids;
      await updateDisplay();
    });
  </script>
</Layout>
