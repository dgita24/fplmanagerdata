---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Player Ownership - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Player Ownership</h1>
      <p class="page-subtitle">See which players are owned by how many managers.</p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading...</span>
      <a href="/managers" class="badge">‚öô Manage IDs</a>
    </div>

    <section class="controls">
      <div class="control">
        <label class="label" for="gw-filter">Gameweek</label>
        <select class="select" id="gw-filter">
          <option value="">Select GW</option>
        </select>
      </div>

      <div class="control">
        <label class="label" for="position-filter">Position</label>
        <select class="select" id="position-filter">
          <option value="">All</option>
          <option value="GK">GK</option>
          <option value="DEF">DEF</option>
          <option value="MID">MID</option>
          <option value="FWD">FWD</option>
        </select>
      </div>

      <div class="control">
        <label class="label">Actions</label>
        <div class="control-actions">
          <button id="refresh-btn" class="btn btn--primary" type="button">üîÑ Refresh</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>
    <section id="ownership-output" aria-live="polite"></section>
  </main>

  <!-- Owned By Modal -->
  <div id="owned-by-modal" class="modal">
    <div class="modal-panel modal-panel--compact">
      <button id="close-owned-modal" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
      <div id="owned-by-content"></div>
    </div>
  </div>
</Layout>

<style>
  .modal-panel--compact {
    padding: var(--space-3);
    max-width: 320px;
  }

  .modal-panel--compact .modal-title {
    font-size: var(--text-base);
    margin-bottom: var(--space-2);
    padding-right: var(--space-6);
  }

  .owner-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    max-height: 50vh;
    overflow-y: auto;
  }

  .owner-list li {
    padding: var(--space-1) var(--space-2);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
  }

  .ownership-table .player-cell {
    line-height: 1.2;
  }

  .ownership-table .player-name {
    font-weight: 600;
  }

  .ownership-table .player-count {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .ownership-table .pos-cell,
  .ownership-table .team-cell {
    font-size: var(--text-xs);
    padding: var(--space-1);
  }

  .ownership-table .pct-cell {
    font-size: var(--text-sm);
    font-weight: 700;
  }

  .ownership-table .pct-cell.pct-100 {
    font-size: var(--text-xs);
  }

  .ownership-table td,
  .ownership-table th {
    padding: var(--space-1) var(--space-2);
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  const out = document.getElementById("ownership-output");
  const gwFilterSelect = document.getElementById("gw-filter");
  const positionFilter = document.getElementById("position-filter");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");
  const ownedByModal = document.getElementById("owned-by-modal");
  const ownedByContent = document.getElementById("owned-by-content");
  const closeOwnedModal = document.getElementById("close-owned-modal");

  let managerIds = [];
  let ownershipData = [];
  let latestGW = null;
  let playerCache = new Map();
  let teamCache = new Map();
  let allManagerNames = [];

  closeOwnedModal.addEventListener("click", () => {
    ownedByModal.classList.remove("is-open");
  });

  function populateGWSelector(currentGW) {
    gwFilterSelect.innerHTML = '';
    for (let i = 1; i <= 38; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `GW ${i}`;
      if (i === currentGW) option.selected = true;
      gwFilterSelect.appendChild(option);
    }
  }

  async function fetchBootstrapData() {
    try {
      const res = await fetch('/api/fpl/bootstrap-static');
      if (!res.ok) throw new Error("Failed to fetch bootstrap data");
      const data = await res.json();

      data.elements.forEach(player => {
        playerCache.set(player.id, {
          name: player.web_name,
          position: player.element_type === 1 ? "GK" :
                    player.element_type === 2 ? "DEF" :
                    player.element_type === 3 ? "MID" : "FWD",
          team: player.team
        });
      });

      data.teams.forEach(team => {
        teamCache.set(team.id, team.short_name);
      });

      const currentEvent = data.events.find(e => e.is_current);
      latestGW = currentEvent ? currentEvent.id : 1;
      
      populateGWSelector(latestGW);
    } catch (e) {
      console.error("Error fetching bootstrap data:", e);
    }
  }

  async function fetchManagerSquad(entryId, gw) {
    try {
      const [picksRes, summaryRes] = await Promise.all([
        fetch(`/api/fpl/entry/${entryId}/event/${gw}/picks`),
        fetch(`/api/fpl/entry/${entryId}`)
      ]);

      if (!picksRes.ok || !summaryRes.ok) throw new Error("Failed to fetch data");

      const picksData = await picksRes.json();
      const summaryData = await summaryRes.json();

      const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;

      return {
        entryId,
        managerName,
        picks: picksData.picks.map(p => p.element)
      };
    } catch (e) {
      console.error(`Error fetching squad for ${entryId}:`, e);
      return null;
    }
  }

  function calculateOwnership(managerSquads) {
    const ownership = new Map();

    for (const manager of managerSquads) {
      for (const playerId of manager.picks) {
        if (!ownership.has(playerId)) {
          const playerInfo = playerCache.get(playerId) || { name: "Unknown", position: "?", team: 0 };
          const teamName = teamCache.get(playerInfo.team) || "???";

          ownership.set(playerId, {
            playerId,
            playerName: playerInfo.name,
            position: playerInfo.position,
            teamName: teamName,
            ownedBy: [],
            count: 0
          });
        }

        const entry = ownership.get(playerId);
        entry.ownedBy.push(manager.managerName);
        entry.count++;
      }
    }

    return Array.from(ownership.values());
  }

  function showOwnedByModal(playerName, ownedByList, totalManagers) {
    const allOwn = ownedByList.length === totalManagers;
    
    let html = `<h2 class="modal-title">${playerName}</h2>`;
    html += `<p class="text-muted" style="margin-bottom:var(--space-2); font-size:var(--text-xs);">${ownedByList.length} of ${totalManagers} managers</p>`;
    
    if (allOwn) {
      html += `<p class="text-success font-bold" style="font-size:var(--text-sm);">‚úì Owned by everyone</p>`;
    } else {
      html += `<ul class="owner-list">`;
      ownedByList.forEach(name => {
        html += `<li>${name}</li>`;
      });
      html += `</ul>`;
      
      const notOwned = allManagerNames.filter(n => !ownedByList.includes(n));
      if (notOwned.length > 0 && notOwned.length <= 5) {
        html += `<p class="text-muted" style="margin-top:var(--space-3); font-size:var(--text-xs);"><strong>Not owned by:</strong> ${notOwned.join(", ")}</p>`;
      }
    }
    
    ownedByContent.innerHTML = html;
    ownedByModal.classList.add("is-open");
  }

  function makeOwnershipTable(ownership, positionFilterValue = "") {
    let filtered = ownership;

    if (positionFilterValue) {
      filtered = ownership.filter(p => p.position === positionFilterValue);
    }

    filtered.sort((a, b) => {
      if (b.count !== a.count) return b.count - a.count;
      return a.playerName.localeCompare(b.playerName);
    });

    const totalManagers = allManagerNames.length;

    let html = `
      <div class="meta-row" style="margin-bottom:var(--space-2);">
        <span>Managers: <strong>${totalManagers}</strong></span>
        <span>Players: <strong>${filtered.length}</strong></span>
      </div>

      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table ownership-table">
            <thead>
              <tr>
                <th>Player</th>
                <th class="num pos-cell">Pos</th>
                <th class="num team-cell">Team</th>
                <th class="num">%</th>
                <th class="num">üëÅ</th>
              </tr>
            </thead>
            <tbody>
    `;

    for (const player of filtered) {
      const ownershipPct = ((player.count / totalManagers) * 100).toFixed(0);
      const ownedByJson = JSON.stringify(player.ownedBy).replace(/"/g, '&quot;');
      const pctClass = ownershipPct === "100" ? "pct-cell pct-100" : "pct-cell";

      html += `
        <tr>
          <td class="player-cell">
            <div class="player-name">${player.playerName}</div>
            <div class="player-count">${player.count} of ${totalManagers}</div>
          </td>
          <td class="num pos-cell">${player.position}</td>
          <td class="num team-cell">${player.teamName}</td>
          <td class="num ${pctClass}">${ownershipPct}%</td>
          <td class="num">
            <button 
              class="btn btn--neutral btn--small owned-by-btn" 
              type="button"
              data-player="${player.playerName}"
              data-owned="${ownedByJson}"
              style="padding:2px 6px; min-height:28px;"
            >üëÅ</button>
          </td>
        </tr>
      `;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    return html;
  }

  function attachOwnedByButtons() {
    document.querySelectorAll('.owned-by-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const playerName = e.target.dataset.player;
        const ownedBy = JSON.parse(e.target.dataset.owned);
        showOwnedByModal(playerName, ownedBy, allManagerNames.length);
      });
    });
  }

  async function loadOwnership(ids, gw) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    if (!gw) {
      out.innerHTML = "<p class='status status--warning'>Please select a gameweek.</p>";
      return;
    }

    const managerSquads = [];
    allManagerNames = [];
    out.innerHTML = "";
    loadingStatus.textContent = `Loading 0 of ${ids.length}...`;

    let loaded = 0;
    for (const id of ids) {
      try {
        const data = await fetchManagerSquad(id, gw);
        if (data) {
          managerSquads.push(data);
          allManagerNames.push(data.managerName);
          loaded++;

          loadingStatus.textContent = `Loading ${loaded} of ${ids.length}...`;

          ownershipData = calculateOwnership(managerSquads);
          const posFilter = positionFilter.value;
          out.innerHTML = makeOwnershipTable(ownershipData, posFilter);
          attachOwnedByButtons();
        }
      } catch (e) {
        console.error(`Failed to load manager ${id}:`, e);
        loaded++;
      }
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>‚úÖ Loaded ${loaded} managers for GW${gw}</span>`;
  }

  async function init() {
    loadingStatus.textContent = "Loading player data...";
    await fetchBootstrapData();

    const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
    if (!authenticated) return;

    managerIds = ids;

    await updateDisplay();
  }

  async function updateDisplay() {
    managerCountEl.textContent = `${managerIds.length} managers`;
    if (managerIds.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    const gw = parseInt(gwFilterSelect.value) || latestGW;
    await loadOwnership(managerIds, gw);
  }

  gwFilterSelect.addEventListener('change', async () => {
    const gw = parseInt(gwFilterSelect.value);
    if (gw && gw >= 1 && gw <= 38) {
      loadOwnership(managerIds, gw);
    }
  });

  positionFilter.addEventListener('change', () => {
    const posFilter = positionFilter.value;
    out.innerHTML = makeOwnershipTable(ownershipData, posFilter);
    attachOwnedByButtons();
  });

  refreshBtn.addEventListener('click', async () => {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;
    await updateDisplay();
  });

  init();
</script>