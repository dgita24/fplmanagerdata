---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
import GWPointsModal from "../components/modals/GWPointsModal.astro";
---
<Layout title="Manager Squads - FPL Manager Data">
  <Nav />

  <main class="page squads-page-v1">
    <header class="page-header">
      <h1 class="page-title">âš½  Manager Squads  âš½</h1>
      <p class="page-subtitle">View each manager's squad for any gameweek.</p>
    </header>

    <div class="meta-row-wide">
      <span id="manager-count" class="badge badge-wide">Loading...</span>
      <a href="/managers" class="badge badge-wide">âš™ Manage IDs</a>
    </div>

    <div class="controls-inline">
      <div class="control-inline">
        <label class="label-small" for="gw-filter">Gameweek</label>
        <select class="select-small" id="gw-filter">
          <option value="">Select GW</option>
        </select>
      </div>
      <div class="control-inline">
        <label class="label-small" for="manager-filter">Manager</label>
        <select class="select-small" id="manager-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="control-inline">
        <label class="label-small" for="view-filter">View</label>
        <select class="select-small" id="view-filter">
          <option value="all">All Players</option>
          <option value="captain">Captains</option>
          <option value="vice">Vice Captains</option>
        </select>
      </div>
    </div>

    <div class="status-row">
      <div>
        <div id="loading-status" class="status-text"></div>
        <div id="last-updated" class="status-text"></div>
      </div>
      <button id="refresh-btn" class="btn-refresh" type="button">ðŸ”„ Refresh</button>
    </div>

    <section id="squads-output" aria-live="polite"></section>
  </main>

  <!-- Player Stats Modal -->
  <div id="player-modal" class="modal modal--nested">
    <div class="modal-panel modal-panel--compact">
      <button id="close-player-modal" class="btn btn--danger btn--small modal-close" type="button">âœ•</button>
      <div id="player-modal-content"></div>
    </div>
  </div>

 <GWPointsModal />

  <!-- Manager History Modal -->
  <div id="manager-history-modal" class="modal modal--nested">
    <div class="modal-panel">
      <button id="close-history-modal" class="btn btn--danger btn--small modal-close" type="button">âœ•</button>
      <div id="history-modal-content"></div>
    </div>
  </div>
</Layout>

<style>
  .meta-row-wide {
    display: flex;
    gap: var(--space-2);
  }

  .badge-wide {
    flex: 1;
    justify-content: center;
    padding: var(--space-2) var(--space-3);
    text-align: center;
  }

  .controls-inline {
    display: flex;
    gap: var(--space-2);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
  }

  .control-inline {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .label-small {
    font-size: 11px;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-align: center;
  }

  .select-small {
    width: 100%;
    min-height: 32px;
    padding: 4px 6px;
    font-family: inherit;
    font-size: 12px;
    color: var(--color-text);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .select-small:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .status-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
  }

  .status-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .btn-refresh {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-refresh:hover {
    background: var(--color-primary-hover);
  }

  :global(.squad-card) {
    margin-bottom: var(--space-4);
  }

  :global(.squad-header) {
    display: flex; /* Align items in a row */
    justify-content: center;
    align-items: center;
    gap: 8px;
    padding: var(--space-2) var(--space-3);
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border);
    font-size: var(--text-sm);
  }

  :global(.team-name-span) {
    color: var(--color-text-secondary);
    font-size: 13px;
  }

  :global(.bench-row) {
    background: var(--color-surface-alt);
  }

  :global(.sub-on-row) {
    background: rgb(22 163 74 / 0.1);
  }

  :global(.sub-off-row) {
    background: rgb(220 38 38 / 0.1);
  }

  :global(.dnp-row) {
    background: rgb(220 38 38 / 0.05);
    opacity: 0.7;
  }

  :global(.squad-chip-indicator) {
    text-align: center;
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-warning);
    border-bottom: 1px solid var(--color-border);
  }

  :global(.player-name-btn) {
    background: none;
    border: none;
    color: var(--color-primary);
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    padding: 0;
    text-align: left;
    text-decoration: underline;
    text-decoration-color: transparent;
    transition: text-decoration-color 0.2s;
  }

  :global(.player-name-btn:hover) {
    text-decoration-color: var(--color-primary);
  }

  /* NEW: Specific colors for Captain/Vice */
  /* FIXED: Matched these class names to the script */
  :global(.cap-text-c) {
    color: #22c55e; /* Bold Green */
    font-weight: 800;
  }
  
  :global(.cap-text-vc) {
    color: #f97316; /* Bold Orange */
    font-weight: 800;
  }

  /* UPDATED: Manager Link */
  :global(.manager-link-btn) {
    background: none;
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 16px;
    padding: 0;
    text-decoration: underline;
    text-decoration-color: transparent;
    transition: color 0.2s;
    color: var(--color-warning);
    font-weight: 700;
  }
  
  :global(.manager-link-btn:hover) {
    color: var(--color-warning);
    text-decoration-color: var(--color-warning);
  }

  :global(.squads-page-v1 .squad-table th) {
  font-weight: 700 !important;
  font-size: 13px !important;
  }

  /* Table Columns */
  :global(.pos-col) {
    font-size: var(--text-xs);
    font-weight: 400;
    /* REMOVED: text-transform: uppercase; (This was forcing POS) */
    color: var(--color-text-secondary);
    text-align: center;
    width: 45px; /* Fixed width for mobile */
    white-space: nowrap !important; /* Prevents wrapping */
  }

  /* FIX: Ensure Pos column is centered */
  :global(.squads-page-v1 .squad-table th.pos-col),
  :global(.squads-page-v1 .squad-table td.pos-col) {
    text-align: center !important;
  }

  /* FIX: Ensure Cap column is centered */
  :global(.squads-page-v1 .squad-table th.cap-col),
  :global(.squads-page-v1 .squad-table td.cap-col) {
    text-align: center !important;
  }

  @media (min-width: 640px) {
    :global(.squads-page-v1 table.squad-table) {
      table-layout: fixed !important;
      width: 100% !important;
    }

    :global(.squads-page-v1 .squad-table .pos-num) { width: 60px !important; }
    :global(.squads-page-v1 .squad-table .pos-col) { width: 70px !important; }
    
    /* REDUCED WIDTHS as requested */
    :global(.squads-page-v1 .squad-table .team-col) { width: 70px !important; } /* Reduced from 90 */
    :global(.squads-page-v1 .squad-table .pts-col) { width: 60px !important; }  /* Reduced from 70 */
    :global(.squads-page-v1 .squad-table .cap-col) { width: 50px !important; }

    :global(.squads-page-v1 .squad-table td) {
      overflow-wrap: anywhere;
    }
  }

  @media (max-width: 639px) {
    :global(.squads-page-v1 .squad-table th.cap-col) {
      font-size: 11px !important;
    }

    :global(.squads-page-v1 .squad-table td.player-name) {
      white-space: normal !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
  }

  /* GW Points Modal Styles */
  .modal--gw-points {
    z-index: 10002; /* Higher than nested player modal */
  }

  .modal-panel--gw-points {
    max-width: 500px;
    max-height: 85vh;
    overflow: hidden;
  }

  @media (max-width: 480px) {
    .modal-panel--gw-points {
      max-width: 95vw;
    }
  }


</style>

<script>
  import '../scripts/squads.page.ts';
</script>
