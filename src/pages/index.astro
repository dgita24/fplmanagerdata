---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="FPL Manager Watch">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Welcome to FPL Manager Watch</h1>
      <p class="page-subtitle">
        Track the live standings, player ownership numbers, available FTs and more, of custom picked FPL managers. 
      </p>
    </header>

    <section id="auth-loading" class="card">
      <div class="card-body">
        <h2 class="card-title">Checking loginâ€¦</h2>
        <p class="text-muted">One moment.</p>
      </div>
    </section>

    <!-- Show when NOT logged in -->
    <section id="guest-content" class="card" style="display: none;">
      <div class="card-body">
        <h2 class="card-title">ðŸš€ Get Started</h2>
        <p class="text-muted">
          Create an account or login to start tracking your favourite FPL managers.
        </p>
        <div class="auth-buttons">
          <a href="/login" class="btn btn--primary">Login</a>
          <a href="/signup" class="btn btn--success">Sign Up</a>
        </div>
      </div>
    </section>

    <!-- Show when logged in -->
    <section id="user-content" class="card" style="display: none;">
      <div class="card-body">
        <h2 class="card-title">ðŸš€ First time here?</h2>
        <p class="text-muted">
          To start, add any manager's EntryID (up to a max of 50) on the Managers Page. They'll sync to your account across devices.
        </p>
        <div style="margin-top: var(--space-4);">
          <a href="/managers" class="btn btn--primary btn--full-width">âš™ Go to Managers Page</a>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-body">
        <h2 class="card-title">ðŸ“Š Available Pages</h2>
        <ul class="nav-list">
          <li><a href="/transfers"><strong>Transfers</strong></a> â€” Transfer histories and free transfer calculations</li>
          <li><a href="/squads"><strong>Squads</strong></a> â€” Lineups for any manager</li>
          <li><a href="/chips"><strong>Chips</strong></a> â€” Chip usage summary and detail</li>
          <li><a href="/stats"><strong>Stats</strong></a> â€” League standings and summary metrics</li>
          <li><a href="/ownership"><strong>Ownership</strong></a> â€” Player ownership across managers</li>
          <li><a href="/live"><strong>Live</strong></a> â€” Live GW points and projected standings</li>
        </ul>
      </div>
    </section>
  </main>
</Layout>

<style>
  .nav-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .nav-list li {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .nav-list a {
    font-weight: 600;
  }

  .auth-buttons {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-4);
  }

  .auth-buttons .btn {
    flex: 1;  /* Equal width for both buttons */
    text-align: center;  /* Center the text */
  }

  /* Full-width button for logged-in users */
  .btn--full-width {
    width: 100%;
    text-align: center;
  }
</style>

<script>
  import { supabase } from '../lib/supabase.ts'

  const loading = document.getElementById('auth-loading')
  const guestContent = document.getElementById('guest-content')
  const userContent = document.getElementById('user-content')

  function render(session) {
    const isAuthed = !!session?.user

    if (userContent) userContent.style.display = isAuthed ? 'block' : 'none'
    if (guestContent) guestContent.style.display = isAuthed ? 'none' : 'block'
    if (loading) loading.style.display = 'none'
  }

  const failSafe = setTimeout(() => render(null), 3000)

  async function initAuthUI() {
    try {
      const { data, error } = await supabase.auth.getSession()
      if (error) throw error
      clearTimeout(failSafe)
      render(data.session)
    } catch (err) {
      clearTimeout(failSafe)
      render(null)
      console.error('Auth UI init failed:', err)
    }
  }


  initAuthUI()

  const { data } = supabase.auth.onAuthStateChange((_event, session) => {
  render(session)
  })
  const subscription = data?.subscription


  // optional cleanup
  window.addEventListener('beforeunload', () => {
    subscription?.unsubscribe()
  })

</script>
