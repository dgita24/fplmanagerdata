---
import Nav from '../components/Nav.astro';
---

<Nav />
<h1>Transfers & Free Transfers (FTs) for Next GW</h1>
<p>Display calculated FTs for next GW for all managers.</p>

<div style="margin-bottom: 1em;">
  <span id="manager-count" style="font-weight: bold;">Loading managers...</span>
  <a href="/managers" style="margin-left: 1em; color: #3182ce;">Manage IDs</a>
</div>

<div style="margin-bottom: 1em;">
  <label for="gw-filter">Filter by Gameweek:</label><br>
  <input type="number" id="gw-filter" min="1" max="38" placeholder="Auto" style="width: 100px; padding: 5px;">
  <button id="clear-filter-btn" style="margin-left: 0.5em; padding: 5px 12px;">Show All GWs</button>
  <button id="refresh-btn" style="margin-left: 1em; padding: 5px 12px;">Refresh Data</button>
</div>

<div id="loading-status" style="margin-bottom: 1em; color: #666;"></div>
<div id="transfers-table" style="margin-top:1.5em"></div>

<!-- Transfer History Modal -->
<div id="transfer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background: white; margin: 50px auto; padding: 30px; max-width: 900px; border-radius: 8px; position: relative;">
    <button id="close-modal" style="position: absolute; top: 15px; right: 15px; background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 16px;">âœ• Close</button>
    <div id="modal-content"></div>
  </div>
</div>

<!-- Chip Detail Modal (nested) -->
<div id="chip-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; overflow-y: auto;">
  <div style="background: white; margin: 100px auto; padding: 30px; max-width: 700px; border-radius: 8px; position: relative;">
    <button id="close-chip-modal" style="position: absolute; top: 15px; right: 15px; background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">âœ• Close</button>
    <div id="chip-modal-content"></div>
  </div>
</div>

<script type="module">
// Inline FT calculation logic - MATCHES EXCEL EXACTLY
function calculateFTs(managerHistory) {
  const byGW = new Map();
  managerHistory.forEach(row => byGW.set(row.gw, row));

  for (let i = 0; i < managerHistory.length; ++i) {
    const row = managerHistory[i];
    const E = Number(row.gw);
    const M = Number(row.transfers);
    let Q = 1;
    const prevRow = byGW.get(E - 1);
    const S = prevRow ? 1 : 0;
    
    if (E === 16) {
      Q = 5;
    } else if (E === 1) {
      Q = 0;
    } else if (S === 0) {
      Q = 1;
    } else if (!prevRow) {
      Q = 1;
    } else {
      const prevChip = prevRow.chipPlayed || "";
      const prevFTs = Number(prevRow.FTsStartOfGW);
      const prevTransfers = Number(prevRow.transfers);
      
      if (prevChip === "WC" || prevChip === "FH") {
        Q = Math.max(1, prevFTs - prevTransfers);
      } else {
        Q = Math.min(Math.max(1, prevFTs - prevTransfers + 1), 5);
      }
    }
    row.FTsStartOfGW = Q;
  }

  const maxGW = Math.max(...managerHistory.map(r => r.gw));
  managerHistory.forEach(row => {
    if (row.gw === maxGW) {
      const E = Number(row.gw);
      const Q = Number(row.FTsStartOfGW);
      const M = Number(row.transfers);
      const F = row.chipPlayed || "";
      
      if (E === 15) {
        row.FTsForNextGW = 5;
      } else {
        const inc = (F === "WC" || F === "FH") ? 0 : 1;
        row.FTsForNextGW = Math.min(Math.max(1, Q - M + inc), 5);
      }
    } else {
      row.FTsForNextGW = "";
    }
  });
}

function loadManagerIds() {
  try {
    return JSON.parse(localStorage.getItem("globalManagerIds")) || [];
  } catch {
    return [];
  }
}

const out = document.getElementById("transfers-table");
const gwFilterInput = document.getElementById("gw-filter");
const clearFilterBtn = document.getElementById("clear-filter-btn");
const loadingStatus = document.getElementById("loading-status");
const managerCountEl = document.getElementById("manager-count");
const refreshBtn = document.getElementById("refresh-btn");
const transferModal = document.getElementById("transfer-modal");
const modalContent = document.getElementById("modal-content");
const closeModal = document.getElementById("close-modal");
const chipModal = document.getElementById("chip-modal");
const chipModalContent = document.getElementById("chip-modal-content");
const closeChipModal = document.getElementById("close-chip-modal");

let allHistories = [];
let latestGW = null;
let allPlayersMap = {};

closeModal.addEventListener("click", () => {
  transferModal.style.display = "none";
});

closeChipModal.addEventListener("click", () => {
  chipModal.style.display = "none";
});

// Fetch player names
async function fetchPlayers() {
  try {
    const res = await fetch('/api/fpl/bootstrap-static');
    if (!res.ok) return;
    const data = await res.json();
    data.elements.forEach(p => {
      allPlayersMap[p.id] = p.web_name;
    });
  } catch (e) {
    console.error("Error fetching players:", e);
  }
}

async function showTransferHistory(managerId, managerName) {
  modalContent.innerHTML = "<p>Loading transfer history...</p>";
  transferModal.style.display = "block";

  try {
    // Fetch manager transfers
    const transfersRes = await fetch(`/api/fpl/entry/${managerId}/transfers`);
    const transfers = await transfersRes.json();

    const historyRes = await fetch(`/api/fpl/entry/${managerId}/history`);
    const history = await historyRes.json();

    // Group transfers by GW
    const transfersByGW = {};
    transfers.forEach(t => {
      if (!transfersByGW[t.event]) {
        transfersByGW[t.event] = [];
      }
      transfersByGW[t.event].push(t);
    });

    // Get chips used
    const chipsUsed = {};
    if (history.chips) {
      history.chips.forEach(chip => {
        chipsUsed[chip.event] = chip.name;
      });
    }

    let html = `<h2>${managerName} - Season Transfer History</h2>`;
    html += `<p style="color: #666;">Total Transfers: ${transfers.length}</p>`;

    // Build GW by GW
    const allGWs = [...new Set([...Object.keys(transfersByGW).map(Number), ...Object.keys(chipsUsed).map(Number)])].sort((a, b) => a - b);

    html += `<div style="max-height: 500px; overflow-y: auto;">`;

    allGWs.forEach(gw => {
      const chip = chipsUsed[gw];
      const gwTransfers = transfersByGW[gw] || [];
      const cost = history.current?.find(h => h.event === gw)?.event_transfers_cost || 0;

      html += `<div style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: #f7fafc;">`;
      html += `<h3 style="margin-top: 0;">Gameweek ${gw}</h3>`;

      if (chip) {
        const chipBadge = chip === 'wildcard' ? 'ðŸƒ Wildcard' : chip === 'freehit' ? 'ðŸŽ¯ Free Hit' : chip;
        html += `<button class="chip-btn" data-gw="${gw}" data-manager="${managerId}" data-chip="${chip}" style="background: #805ad5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-size: 14px;">${chipBadge} (Click to view transfers)</button>`;
      } else if (gwTransfers.length > 0) {
        html += `<div style="font-size: 14px;">`;
        gwTransfers.forEach(t => {
          const playerIn = allPlayersMap[t.element_in] || `Player ${t.element_in}`;
          const playerOut = allPlayersMap[t.element_out] || `Player ${t.element_out}`;
          html += `<p style="margin: 5px 0;"><span style="color: #38a169;">â–² ${playerIn}</span> â† <span style="color: #e53e3e;">â–¼ ${playerOut}</span></p>`;
        });
        if (cost > 0) {
          html += `<p style="color: #e53e3e; font-weight: bold; margin-top: 10px;">Hit taken: -${cost} pts</p>`;
        }
        html += `</div>`;
      } else {
        html += `<p style="color: #999; font-style: italic;">No transfers</p>`;
      }

      html += `</div>`;
    });

    html += `</div>`;

    modalContent.innerHTML = html;

    // Add event listeners for chip buttons
    document.querySelectorAll('.chip-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const gw = e.target.dataset.gw;
        const managerId = e.target.dataset.manager;
        const chip = e.target.dataset.chip;
        await showChipTransfers(managerId, gw, chip);
      });
    });

  } catch (error) {
    console.error("Error loading transfer history:", error);
    modalContent.innerHTML = "<p style='color: red;'>Error loading transfer history.</p>";
  }
}

async function showChipTransfers(managerId, gw, chipName) {
  chipModalContent.innerHTML = "<p>Loading chip transfers...</p>";
  chipModal.style.display = "block";

  try {
    // Get the squad before and after
    const picksRes = await fetch(`/api/fpl/entry/${managerId}/event/${gw}/picks`);
    const picks = await picksRes.json();

    const prevGW = parseInt(gw) - 1;
    let prevSquad = [];
    if (prevGW > 0) {
      try {
        const prevPicksRes = await fetch(`/api/fpl/entry/${managerId}/event/${prevGW}/picks`);
        const prevPicks = await prevPicksRes.json();
        prevSquad = prevPicks.picks?.map(p => p.element) || [];
      } catch (e) {
        console.warn("Couldn't fetch previous squad");
      }
    }

    const currentSquad = picks.picks?.map(p => p.element) || [];

    const playersIn = currentSquad.filter(p => !prevSquad.includes(p));
    const playersOut = prevSquad.filter(p => !currentSquad.includes(p));

    const chipDisplay = chipName === 'wildcard' ? 'ðŸƒ Wildcard' : 'ðŸŽ¯ Free Hit';

    let html = `<h2>${chipDisplay} - Gameweek ${gw}</h2>`;
    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">`;
    
    html += `<div style="border: 1px solid #fc8181; border-radius: 6px; padding: 15px; background: #fff5f5;">`;
    html += `<h3 style="color: #e53e3e; margin-top: 0;">Players Out (${playersOut.length})</h3>`;
    playersOut.forEach(pid => {
      html += `<p style="margin: 5px 0;">â–¼ ${allPlayersMap[pid] || `Player ${pid}`}</p>`;
    });
    html += `</div>`;

    html += `<div style="border: 1px solid #68d391; border-radius: 6px; padding: 15px; background: #f0fff4;">`;
    html += `<h3 style="color: #38a169; margin-top: 0;">Players In (${playersIn.length})</h3>`;
    playersIn.forEach(pid => {
      html += `<p style="margin: 5px 0;">â–² ${allPlayersMap[pid] || `Player ${pid}`}</p>`;
    });
    html += `</div>`;

    html += `</div>`;

    chipModalContent.innerHTML = html;

  } catch (error) {
    console.error("Error loading chip transfers:", error);
    chipModalContent.innerHTML = "<p style='color: red;'>Error loading chip transfers.</p>";
  }
}

async function fetchHistory(id) {
  const historyUrl = `/api/fpl/entry/${id}/history`;
  const summaryUrl = `/api/fpl/entry/${id}`;
  
  const [historyRes, summaryRes] = await Promise.all([
    fetch(historyUrl),
    fetch(summaryUrl)
  ]);
  
  if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");
  
  const historyData = await historyRes.json();
  const summaryData = await summaryRes.json();
  
  const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;
  
  let history = historyData.current.map(gw => ({
    entryId: Number(id),
    managerName: managerName,
    gw: gw.event,
    chipPlayed: "",
    transfers: gw.event_transfers,
    transferCost: gw.event_transfers_cost ?? 0,
    benchPoints: gw.points_on_bench ?? 0,
    gwPoints: gw.points,
    totalPoints: gw.total_points
  }));
  
  if (Array.isArray(historyData.chips)) {
    historyData.chips.forEach(c => {
      const row = history.find(gw => gw.gw === c.event);
      if (row) {
        row.chipPlayed = (
          c.name === "wildcard" ? "WC" :
          c.name === "bboost" ? "BB" :
          c.name === "3xc" ? "TC" :
          c.name === "freehit" ? "FH" : c.name
        );
      }
    });
  }
  return history;
}

function makeTable(histories, filterGW = null) {
  let rows = histories.flat();
  
  // Apply GW filter if specified
  if (filterGW !== null && filterGW !== "") {
    const gwNum = Number(filterGW);
    rows = rows.filter(r => r.gw === gwNum);
    
    // When filtering by GW, sort by Total Points DESC (best first)
    rows.sort((a, b) => b.totalPoints - a.totalPoints);
  } else {
    // When showing all GWs, sort by Manager name then GW
    rows.sort((a,b) => a.managerName.localeCompare(b.managerName) || a.gw-b.gw);
  }

  let html = `<table border="1" cellpadding="4" style="border-collapse:collapse">
    <tr>
      <th>Manager</th>
      <th>GW</th>
      <th>ChipPlayed</th>
      <th>Transfers</th>
      <th>TransferCost</th>
      <th>GW Points</th>
      <th>Total Points</th>
      <th>FTs Start of GW</th>
      <th style="background:lightyellow">FTs for next GW</th>
    </tr>`;
  for (const r of rows) {
    html += `<tr>
      <td style="font-weight: bold;"><a href="#" class="manager-link" data-id="${r.entryId}" data-name="${r.managerName}" style="color: #3182ce; text-decoration: none; cursor: pointer;">${r.managerName}</a></td>
      <td>${r.gw}</td>
      <td>${r.chipPlayed || ""}</td>
      <td>${r.transfers ?? ""}</td>
      <td>${r.transferCost ?? ""}</td>
      <td>${r.gwPoints ?? ""}</td>
      <td>${r.totalPoints ?? ""}</td>
      <td>${r.FTsStartOfGW ?? ""}</td>
      <td style="background:lightyellow">${r.FTsForNextGW ?? ""}</td>
    </tr>`;
  }
  html += "</table>";
  return html;
}

async function loadManagers(ids) {
  if (ids.length === 0) {
    out.innerHTML = "<span style='color:red'>No manager IDs found. <a href='/managers'>Add managers here</a>.</span>";
    return;
  }

  allHistories = [];
  latestGW = null;
  out.innerHTML = "";
  loadingStatus.textContent = `Loading 0 of ${ids.length} managers...`;

  let loaded = 0;
  for (const id of ids) {
    try {
      let history = await fetchHistory(id);
      calculateFTs(history);
      allHistories.push(history);
      
      // Track the latest GW across all managers
      const managerMaxGW = Math.max(...history.map(h => h.gw));
      if (latestGW === null || managerMaxGW > latestGW) {
        latestGW = managerMaxGW;
      }
      
      loaded++;
      
      // Update status
      loadingStatus.textContent = `Loading ${loaded} of ${ids.length} managers...`;
      
      // Progressive render WITHOUT filter during loading
      out.innerHTML = makeTable(allHistories, "");
      attachManagerLinks();
    } catch (e) {
      console.error(`Failed to load manager ${id}:`, e);
      loaded++;
      loadingStatus.innerHTML = `<span style='color:orange'>âš ï¸ Failed to load manager ${id}</span>`;
    }
  }
  
  loadingStatus.innerHTML = `<span style='color:#38a169'>âœ… Loaded ${loaded} of ${ids.length} managers</span>`;
  
  // AFTER all managers loaded, auto-set filter to latest GW
  if (latestGW) {
    gwFilterInput.value = latestGW;
    gwFilterInput.placeholder = `Latest: GW${latestGW}`;
    filterByGW(); // Apply the filter
  }
}

function attachManagerLinks() {
  document.querySelectorAll('.manager-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const managerId = e.target.dataset.id;
      const managerName = e.target.dataset.name;
      showTransferHistory(managerId, managerName);
    });
  });
}

function filterByGW() {
  const filterGW = gwFilterInput.value.trim();
  out.innerHTML = makeTable(allHistories, filterGW);
  attachManagerLinks();
}

// Fetch players on init
fetchPlayers();

// Initial load
const managerIds = loadManagerIds();
managerCountEl.textContent = `${managerIds.length} manager(s) configured`;

if (managerIds.length > 0) {
  loadManagers(managerIds);
} else {
  out.innerHTML = "<span style='color:red'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</span>";
}

gwFilterInput.addEventListener('input', filterByGW);

clearFilterBtn.addEventListener('click', () => {
  gwFilterInput.value = "";
  filterByGW();
});

refreshBtn.addEventListener('click', () => {
  gwFilterInput.value = ""; // Clear filter on refresh
  const ids = loadManagerIds();
  loadManagers(ids);
});
</script>

<style>
  button {
    background: #3182ce;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover {
    background: #2c5aa0;
  }
  a:hover {
    text-decoration: underline !important;
  }
  .chip-btn:hover {
    opacity: 0.9;
  }
</style>