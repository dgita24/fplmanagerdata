---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Transfers & Free Transfers - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Transfers & Free Transfers</h1>
      <p class="page-subtitle">Calculated FTs for next GW for all managers.</p>
    </header>

    <div class="meta-row-wide">
      <span id="manager-count" class="badge badge-wide">Loading...</span>
      <a href="/managers" class="badge badge-wide">‚öô Manage IDs</a>
    </div>

    <div class="controls-inline">
      <div class="control-inline">
        <label class="label-small" for="gw-filter">Gameweek</label>
        <select class="select-small" id="gw-filter">
          <option value="">All GWs</option>
        </select>
      </div>
      <div class="control-inline">
        <label class="label-small">&nbsp;</label>
        <button id="refresh-btn" class="btn-row" type="button">üîÑ Refresh</button>
      </div>
    </div>

    <div id="loading-status" class="meta-row"></div>
    <section id="transfers-table" aria-live="polite"></section>
  </main>

  <!-- Transfer History Modal -->
  <div id="transfer-modal" class="modal">
    <div class="modal-panel">
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Chip Detail Modal -->
  <div id="chip-modal" class="modal modal--nested">
    <div class="modal-panel">
      <button id="close-chip-modal" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
      <div id="chip-modal-content"></div>
    </div>
  </div>
</Layout>

<style>
  .meta-row-wide {
    display: flex;
    gap: var(--space-2);
  }

  .badge-wide {
    flex: 1;
    justify-content: center;
    padding: var(--space-2) var(--space-3);
    text-align: center;
  }

  .controls-inline {
    display: flex;
    gap: var(--space-2);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
  }

  .control-inline {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .label-small {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-align: center;
  }

  .select-small {
    width: 100%;
    min-height: 36px;
    padding: 6px 8px;
    font-family: inherit;
    font-size: 13px;
    color: var(--color-text);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .select-small:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .btn-row {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 36px;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
  }

  .btn-row:hover {
    background: var(--color-primary-hover);
  }

  /* Chip headings */
  .chip-text {
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    color: var(--color-text);
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    display: inline;
    appearance: none;
    -webkit-appearance: none;
    box-shadow: none;
    outline: none;
    line-height: inherit;
    text-align: left;
  }

  .chip-text--clickable {
    color: var(--color-primary);
    cursor: pointer;
  }

  .chip-text--clickable:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
  }

  .chip-row {
    margin-bottom: var(--space-2);
  }

  /* Highlight styles for table */
  .hit-highlight {
    color: var(--color-danger) !important;
    font-weight: 700 !important;
  }

  .top-scorer-row {
    color: var(--color-success) !important;
    font-weight: 700 !important;
  }

  .top-scorer-row a {
    color: var(--color-success) !important;
    font-weight: 700 !important;
  }
</style>

<script>
  function calculateFTs(managerHistory) {
    const byGW = new Map();
    managerHistory.forEach(row => byGW.set(row.gw, row));

    for (let i = 0; i < managerHistory.length; ++i) {
      const row = managerHistory[i];
      const E = Number(row.gw);
      const M = Number(row.transfers);
      let Q = 1;
      const prevRow = byGW.get(E - 1);
      const S = prevRow ? 1 : 0;

      if (E === 16) {
        Q = 5;
      } else if (E === 1) {
        Q = 0;
      } else if (S === 0) {
        Q = 1;
      } else if (!prevRow) {
        Q = 1;
      } else {
        const prevChip = prevRow.chipPlayed || "";
        const prevFTs = Number(prevRow.FTsStartOfGW);
        const prevTransfers = Number(prevRow.transfers);

        if (prevChip === "WC" || prevChip === "FH") {
          Q = Math.max(1, prevFTs - prevTransfers);
        } else {
          Q = Math.min(Math.max(1, prevFTs - prevTransfers + 1), 5);
        }
      }
      row.FTsStartOfGW = Q;
    }

    const maxGW = Math.max(...managerHistory.map(r => r.gw));
    managerHistory.forEach(row => {
      if (row.gw === maxGW) {
        const E = Number(row.gw);
        const Q = Number(row.FTsStartOfGW);
        const M = Number(row.transfers);
        const F = row.chipPlayed || "";

        if (E === 15) {
          row.FTsForNextGW = 5;
        } else {
          const inc = (F === "WC" || F === "FH") ? 0 : 1;
          row.FTsForNextGW = Math.min(Math.max(1, Q - M + inc), 5);
        }
      } else {
        row.FTsForNextGW = "";
      }
    });
  }

  import { supabase } from '../lib/supabase.ts'
  import { globalCache, clearCache } from '../lib/globalStore';

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  // Global variables
  let allHistories = [];
  let latestGW = null;
  let allPlayersMap = globalCache.playerCache;
  let currentLoadToken = 0;
  let managerIds = [];

  /**
   * Concurrent mapping with limited concurrency
   */
  async function mapWithConcurrency<T, R>(
    items: T[],
    limit: number,
    fn: (item: T, index: number) => Promise<R | null>,
    onProgress?: (completed: number, total: number) => void
  ): Promise<(R | null)[]> {
    const results: (R | null)[] = [];
    let currentIndex = 0;
    let completed = 0;

    async function worker() {
      while (currentIndex < items.length) {
        const index = currentIndex++;
        const item = items[index];
        try {
          results[index] = await fn(item, index);
        } catch (e) {
          console.error(`Error processing item ${index}:`, e);
          results[index] = null;
        }
        completed++;
        if (onProgress) {
          onProgress(completed, items.length);
        }
      }
    }

    const workers = Array.from({ length: Math.min(limit, items.length) }, () => worker());
    await Promise.all(workers);
    return results;
  }

  function populateGWSelector(currentGW) {
    const gwFilterSelect = document.getElementById("gw-filter") as HTMLSelectElement;
    if (!gwFilterSelect) return;
    
    gwFilterSelect.innerHTML = '<option value="">All GWs</option>';
    for (let i = 1; i <= 38; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `GW ${i}`;
      if (i === currentGW) option.selected = true;
      gwFilterSelect.appendChild(option);
    }
  }

  async function fetchPlayers(cacheBuster?: string) {
    try {
      // Check if we already have bootstrap data in cache with valid structure
      if (!cacheBuster && globalCache.bootstrapData && allPlayersMap.size > 0) {
        // Validate cache structure - ensure it has the format we expect
        const firstPlayer = allPlayersMap.values().next().value;
        if (firstPlayer && typeof firstPlayer === 'object' && 'name' in firstPlayer) {
          const currentEvent = (globalCache.bootstrapData.events || []).find(e => e.is_current);
          latestGW = currentEvent ? currentEvent.id : 1;
          populateGWSelector(latestGW);
          return;
        }
      }

      const v = cacheBuster || Date.now().toString();
      const res = await fetch(`/api/fpl/bootstrap-static?v=${v}`);
      if (!res.ok) return;
      const data = await res.json();
      
      // Clear and repopulate with the structure this page needs
      allPlayersMap.clear();
      data.elements.forEach(p => {
        allPlayersMap.set(p.id, { name: p.web_name, position: p.element_type, team: p.team });
      });

      const currentEvent = (data.events || []).find(e => e.is_current);
      latestGW = currentEvent ? currentEvent.id : 1;
      populateGWSelector(latestGW);

      // Store in global cache
      globalCache.bootstrapData = data;
    } catch (e) {
      console.error("Error fetching players:", e);
    }
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ==============================
  // Table sorting (client-side)
  // Default: Total desc
  // ==============================
  let sortKey = "totalPoints"; // "transferCost" | "gwPoints" | "totalPoints" | "FTsForNextGW"
  let sortDir = "desc";        // "asc" | "desc"

  let lastRenderedRows: any[] = [];

  function normalizeNumber(v) {
    if (v === null || v === undefined || v === "") return Number.NEGATIVE_INFINITY;
    const n = Number(v);
    return Number.isFinite(n) ? n : Number.NEGATIVE_INFINITY;
  }

  function hasAnyHits(rows: any[]) {
    return rows.some(r => Number(r?.transferCost || 0) > 0);
  }

  function sortRows(rows) {
    const copy = [...rows];
    copy.sort((a, b) => {
      const av = normalizeNumber(a?.[sortKey]);
      const bv = normalizeNumber(b?.[sortKey]);
      const delta = av - bv; // ascending
      return sortDir === "asc" ? delta : -delta;
    });
    return copy;
  }

  function setSort(nextKey: string) {
    // Special case: Hit column ("transferCost")
    if (nextKey === "transferCost") {
      // If all hits are 0 in the CURRENT view, fall back to Total desc
      if (!hasAnyHits(lastRenderedRows)) {
        sortKey = "totalPoints";
        sortDir = "desc";
        return;
      }

      // First time clicking Hit: default to DESC (highest hits first)
      if (sortKey !== "transferCost") {
        sortKey = "transferCost";
        sortDir = "desc";
        return;
      }

      // Clicking Hit again toggles direction
      sortDir = sortDir === "asc" ? "desc" : "asc";
      return;
    }

    // Default behavior for other columns
    if (nextKey === sortKey) {
      sortDir = sortDir === "asc" ? "desc" : "asc";
      return;
    }

    sortKey = nextKey;
    sortDir = "desc";
  }

  function attachSortHandlers() {
    document.querySelectorAll(".transfers-table th[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort");
        if (!key) return;

        setSort(key);

        // Re-render the table using the currently selected GW filter
        filterByGW();
      });
    });
  }

  function transferLineHtml(playerOut, playerIn) {
    return `
      <div style="display:flex; align-items:center; gap:var(--space-2); padding:var(--space-2); margin:var(--space-1) 0; border:1px solid var(--color-border); border-radius:var(--radius-md); font-size:var(--text-sm); flex-wrap:wrap;">
        <span class="badge badge--danger">OUT</span>
        <span class="font-bold">${escapeHtml(playerOut)}</span>
        <span class="text-muted">‚Üí</span>
        <span class="badge badge--success">IN</span>
        <span class="font-bold">${escapeHtml(playerIn)}</span>
      </div>
    `;
  }

  async function showTransferHistory(managerId, managerName) {
    const modalContent = document.getElementById("modal-content");
    const transferModal = document.getElementById("transfer-modal");
    if (!modalContent || !transferModal) return;
    
    modalContent.innerHTML = "<p class='text-muted'>Loading transfer history...</p>";
    transferModal.classList.add("is-open");

    try {
      const transfersRes = await fetch(`/api/fpl/entry/${managerId}/transfers`);
      const transfers = await transfersRes.json();

      const historyRes = await fetch(`/api/fpl/entry/${managerId}/history`);
      const history = await historyRes.json();

      const transfersByGW = {};
      transfers.forEach(t => {
        if (!transfersByGW[t.event]) transfersByGW[t.event] = [];
        transfersByGW[t.event].push(t);
      });

      const chipsUsed = {};
      if (history.chips) {
        history.chips.forEach(chip => {
          chipsUsed[chip.event] = chip.name;
        });
      }

      let html = `
        <button id="close-modal-btn" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
        <h2 class="modal-title">${escapeHtml(managerName)}</h2>
        <p class="text-muted" style="margin-bottom:var(--space-3); font-size:13px;">
          Total transfers: <strong>${transfers.length}</strong>
        </p>
        <div class="transfer-history-list">
      `;

      const allGWs = [...new Set([
        ...Object.keys(transfersByGW).map(Number),
        ...Object.keys(chipsUsed).map(Number)
      ])].sort((a, b) => b - a);

      for (const gw of allGWs) {
        const chip = chipsUsed[gw];
        const gwTransfers = transfersByGW[gw] || [];
        const cost = history.current?.find(h => h.event === gw)?.event_transfers_cost || 0;

        html += `<div class="transfer-gw-row">`;
        html += `<div class="transfer-gw-header">`;
        html += `<span class="transfer-gw-label">GW ${gw}</span>`;
        
        if (cost > 0) {
          html += `<span class="transfer-hit-badge">-${cost}</span>`;
        }
        html += `</div>`;

        html += `<div class="transfer-gw-content">`;

        if (chip) {
          const chipDisplay = chip === 'wildcard' ? 'Wildcard' : 
                              chip === 'freehit' ? 'Free Hit' : 
                              chip === 'bboost' ? 'Bench Boost' :
                              chip === '3xc' ? 'Triple Captain' : chip;

          const isClickableChip = chip === 'wildcard' || chip === 'freehit';

          if (isClickableChip) {
            html += `
              <div class="chip-row">
                <button class="chip-text chip-text--clickable chip-btn" data-gw="${gw}" data-manager="${managerId}" data-chip="${chip}" type="button">
                  ${chipDisplay}
                </button>
              </div>
            `;
          } else {
            html += `<div class="chip-row"><span class="chip-text">${chipDisplay}</span></div>`;
          }
        }

        const shouldShowTransfers = !chip || (chip !== 'wildcard' && chip !== 'freehit');

        if (shouldShowTransfers) {
          if (gwTransfers.length > 0) {
            for (const t of gwTransfers) {
              const playerIn = allPlayersMap.get(t.element_in)?.name || `Player ${t.element_in}`;
              const playerOut = allPlayersMap.get(t.element_out)?.name || `Player ${t.element_out}`;
              html += `
                <div class="transfer-row">
                  <span class="transfer-out">‚ñº ${escapeHtml(playerOut)}</span>
                  <span class="transfer-arrow">‚Üí</span>
                  <span class="transfer-in">‚ñ≤ ${escapeHtml(playerIn)}</span>
                </div>
              `;
            }
          } else {
            html += `<span class="text-muted" style="font-size:12px;">No transfers</span>`;
          }
        }

        html += `</div></div>`;
      }

      if (allGWs.length === 0) {
        html += `<p class="text-muted text-center" style="padding:var(--space-4);">No transfer activity yet.</p>`;
      }

      html += `</div>`;

      modalContent.innerHTML = html;

      document.getElementById("close-modal-btn")?.addEventListener("click", () => {
        transferModal.classList.remove("is-open");
      });

      document.querySelectorAll('.chip-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.target.closest('.chip-btn');
          const gw = button.dataset.gw;
          const oderId = button.dataset.manager;
          const chip = button.dataset.chip;
          await showChipTransfers(managerId, gw, chip);
        });
      });

    } catch (error) {
      console.error("Error loading transfer history:", error);
      modalContent.innerHTML = "<p class='status status--error'>Error loading transfer history.</p>";
    }
  }

  async function showChipTransfers(managerId, gw, chipName) {
    const chipModalContent = document.getElementById("chip-modal-content");
    const chipModal = document.getElementById("chip-modal");
    if (!chipModalContent || !chipModal) return;
    
    chipModalContent.innerHTML = "<p class='text-muted'>Loading chip details...</p>";
    chipModal.classList.add("is-open");

    try {
      const picksRes = await fetch(`/api/fpl/entry/${managerId}/event/${gw}/picks`);
      const picks = await picksRes.json();

      const prevGW = parseInt(gw) - 1;
      let prevSquad = [];
      if (prevGW > 0) {
        try {
          const prevPicksRes = await fetch(`/api/fpl/entry/${managerId}/event/${prevGW}/picks`);
          const prevPicks = await prevPicksRes.json();
          prevSquad = prevPicks.picks?.map(p => p.element) || [];
        } catch (e) {
          console.warn("Couldn't fetch previous squad");
        }
      }

      const currentSquad = picks.picks?.map(p => p.element) || [];

      const playersIn = currentSquad.filter(p => !prevSquad.includes(p));
      const playersOut = prevSquad.filter(p => !currentSquad.includes(p));

      const chipDisplay = chipName === 'wildcard' ? 'üÉè Wildcard' : 
                          chipName === 'freehit' ? 'üéØ Free Hit' :
                          chipName === 'bboost' ? 'ü™ë Bench Boost' :
                          chipName === '3xc' ? 'üëë Triple Captain' : chipName;

      let html = `
        <h2 class="modal-title" style="padding-right:40px;">${chipDisplay}</h2>
        <p class="text-muted" style="margin-bottom:var(--space-3); font-size:13px;">Gameweek ${gw}</p>
      `;

      if (chipName === 'wildcard' || chipName === 'freehit') {
        html += `<div class="chip-transfers-grid">`;

        html += `<div class="chip-transfer-section chip-transfer-section--out">`;
        html += `<div class="chip-transfer-header">Out (${playersOut.length})</div>`;
        html += `<div class="chip-transfer-list">`;
        if (playersOut.length > 0) {
          playersOut.forEach(pid => {
            html += `<div class="chip-transfer-item">‚ñº ${escapeHtml(allPlayersMap.get(pid)?.name || `Player ${pid}`)}</div>`;
          });
        } else {
          html += `<div class="chip-transfer-item text-muted">None</div>`;
        }
        html += `</div></div>`;

        html += `<div class="chip-transfer-section chip-transfer-section--in">`;
        html += `<div class="chip-transfer-header">In (${playersIn.length})</div>`;
        html += `<div class="chip-transfer-list">`;
        if (playersIn.length > 0) {
          playersIn.forEach(pid => {
            html += `<div class="chip-transfer-item">‚ñ≤ ${escapeHtml(allPlayersMap.get(pid)?.name || `Player ${pid}`)}</div>`;
          });
        } else {
          html += `<div class="chip-transfer-item text-muted">None</div>`;
        }
        html += `</div></div>`;

        html += `</div>`;
      } else {
        html += `<p class="text-muted text-center" style="padding:var(--space-3);">This chip doesn't involve transfers.</p>`;
      }

      chipModalContent.innerHTML = html;

    } catch (error) {
      console.error("Error loading chip transfers:", error);
      chipModalContent.innerHTML = "<p class='status status--error'>Error loading chip details.</p>";
    }
  }

  
  async function fetchHistory(id, cacheBuster?: string) {
    const v = cacheBuster || Date.now().toString();
    const historyUrl = `/api/fpl/entry/${id}/history?v=${v}`;
    const summaryUrl = `/api/fpl/entry/${id}?v=${v}`;

    const [historyRes, summaryRes] = await Promise.all([
      fetch(historyUrl),
      fetch(summaryUrl)
    ]);

    if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");

    const historyData = await historyRes.json();
    const summaryData = await summaryRes.json();

    const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;

    let history = historyData.current.map(gw => ({
      entryId: Number(id),
      managerName: managerName,
      gw: gw.event,
      chipPlayed: "",
      transfers: gw.event_transfers,
      transferCost: gw.event_transfers_cost ?? 0,
      benchPoints: gw.points_on_bench ?? 0,
      gwPoints: gw.points,
      totalPoints: gw.total_points
    }));

    if (Array.isArray(historyData.chips)) {
      historyData.chips.forEach(c => {
        const row = history.find(gw => gw.gw === c.event);
        if (row) {
          row.chipPlayed = (
            c.name === "wildcard" ? "WC" :
            c.name === "bboost" ? "BB" :
            c.name === "3xc" ? "TC" :
            c.name === "freehit" ? "FH" : c.name
          );
        }
      });
    }
    return history;
  }

  function makeTable(histories, filterGW = null) {
    let rows = histories.flat();

    if (filterGW !== null && filterGW !== "") {
      const gwNum = Number(filterGW);
      rows = rows.filter(r => r.gw === gwNum);
    } else {
      rows.sort((a,b) => a.managerName.localeCompare(b.managerName) || a.gw - b.gw);
    }

    // Find highest GW score for highlighting
    let maxGwPoints = -Infinity;
    if (filterGW !== null && filterGW !== "") {
      rows.forEach(r => {
        if (r.gwPoints > maxGwPoints) {
          maxGwPoints = r.gwPoints;
        }
      });
    }
    
    lastRenderedRows = rows;

    rows = sortRows(rows);

    let html = `
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table transfers-table">
            <thead>
              <tr>
                <th>Manager</th>
                <th class="hit-col sortable-col ${sortKey === "transferCost" ? "is-sorted" : ""}" data-sort="transferCost">Hit</th>
                <th class="gwpts-col sortable-col ${sortKey === "gwPoints" ? "is-sorted" : ""}" data-sort="gwPoints">GW Pts</th>
                <th class="total-col sortable-col ${sortKey === "totalPoints" ? "is-sorted" : ""}" data-sort="totalPoints">Total</th>
                <th class="fts-col sortable-col ${sortKey === "FTsForNextGW" ? "is-sorted" : ""}" data-sort="FTsForNextGW">FTs</th>
              </tr>
            </thead>
            <tbody>
    `;

    for (const r of rows) {
      const hitClass = r.transferCost > 0 ? 'hit-highlight' : '';

      // Determine FT-based row class
      let rowClass = '';
      const fts = Number(r.FTsForNextGW);
      if (fts >= 3 && fts <= 5) {
        rowClass = 'ft-high-row';      // Yellow
      } else if (fts === 2) {
        rowClass = 'ft-medium-row';    // Blue
      } else if (fts === 1) {
        rowClass = 'ft-low-row';       // Red
      }

      html += `
        <tr class="${rowClass}">
          <td class="strong nowrap">
            <a href="#" class="manager-link" data-id="${r.entryId}" data-name="${r.managerName}">${r.managerName}</a>
          </td>
          <td class="num ${hitClass}">${r.transferCost || 0}</td>
          <td class="num">${r.gwPoints ?? ""}</td>
          <td class="num">${r.totalPoints ?? ""}</td>
          <td class="num strong">${r.FTsForNextGW ?? ""}</td>
        </tr>
      `;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    return html;
  }

  async function loadManagers(ids) {
    const out = document.getElementById("transfers-table");
    const loadingStatus = document.getElementById("loading-status");
    const refreshBtn = document.getElementById("refresh-btn") as HTMLButtonElement;
    const gwFilterSelect = document.getElementById("gw-filter") as HTMLSelectElement;
    
    if (!out || !loadingStatus || !refreshBtn) return;
    
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    // Generate load token for cancellation
    const loadToken = ++currentLoadToken;
    
    // Disable refresh button during loading
    refreshBtn.disabled = true;

    allHistories = [];
    latestGW = null;
    out.innerHTML = "";
    loadingStatus.textContent = `Fetching latest data...`;

    // Generate single cache-buster token for this load
    const cacheBuster = Date.now().toString();
    
    // Fetch manager data concurrently with limit of 8
    const historyResults = await mapWithConcurrency(
      ids,
      8,
      async (id) => {
        try {
          const history = await fetchHistory(id, cacheBuster);
          calculateFTs(history);
          return history;
        } catch (e) {
          console.error(`Failed to load manager ${id}:`, e);
          return null;
        }
      },
      (completed, total) => {
        loadingStatus.textContent = `Fetching ${completed}/${total}...`;
      }
    );

    // Check if this load has been superseded
    if (loadToken !== currentLoadToken) {
      console.log('Load superseded, aborting');
      return;
    }

    // Filter out nulls and update allHistories
    allHistories = historyResults.filter((history): history is NonNullable<typeof history> => history !== null);

    // Find latest GW
    for (const history of allHistories) {
      const managerMaxGW = Math.max(...history.map(h => h.gw));
      if (latestGW === null || managerMaxGW > latestGW) {
        latestGW = managerMaxGW;
      }
    }

    // Render table once at the end
    if (allHistories.length > 0) {
      out.innerHTML = makeTable(allHistories, "");
      attachManagerLinks();
      attachSortHandlers();
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>‚úÖ Loaded ${allHistories.length} managers</span>`;

    if (latestGW && gwFilterSelect) {
      gwFilterSelect.value = latestGW;
      const filterByGW = () => {
        const gwFilterSelect = document.getElementById("gw-filter") as HTMLSelectElement;
        const out = document.getElementById("transfers-table");
        if (!gwFilterSelect || !out) return;
        const filterGW = gwFilterSelect.value;
        out.innerHTML = makeTable(allHistories, filterGW);
        attachManagerLinks();
        attachSortHandlers();
      };
      filterByGW();
    }
    
    // Re-enable refresh button
    refreshBtn.disabled = false;
  }

  function attachManagerLinks() {
    document.querySelectorAll('.manager-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const managerId = e.target.dataset.id;
        const managerName = e.target.dataset.name;
        showTransferHistory(managerId, managerName);
      });
    });
  }

  function filterByGW() {
    const gwFilterSelect = document.getElementById("gw-filter") as HTMLSelectElement;
    const out = document.getElementById("transfers-table");
    if (!gwFilterSelect || !out) return;
    const filterGW = gwFilterSelect.value;
    out.innerHTML = makeTable(allHistories, filterGW);
    attachManagerLinks();
    attachSortHandlers();
  }

  async function init() {
    const out = document.getElementById("transfers-table");
    const loadingStatus = document.getElementById("loading-status");
    const managerCountEl = document.getElementById("manager-count");
    const refreshBtn = document.getElementById("refresh-btn") as HTMLButtonElement;
    const gwFilterSelect = document.getElementById("gw-filter") as HTMLSelectElement;
    const chipModal = document.getElementById("chip-modal");
    const closeChipModal = document.getElementById("close-chip-modal");
    
    if (!out || !loadingStatus || !managerCountEl || !refreshBtn) {
      console.error('Required DOM elements not found');
      return;
    }

    // Attach modal close handler
    closeChipModal?.addEventListener("click", () => {
      chipModal?.classList.remove("is-open");
    });

    await fetchPlayers();

    const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
    if (!authenticated) return;

    managerIds = ids;
    managerCountEl.textContent = `${managerIds.length} managers`;

    if (managerIds.length > 0) {
      loadManagers(managerIds);
    } else {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
    }

    // Attach event listeners
    gwFilterSelect?.addEventListener('change', filterByGW);

    refreshBtn.addEventListener('click', async () => {
      clearCache('transfers');
      const { managerIds: ids } = await loadManagerIdsFromSupabase();
      managerIds = ids;
      loadManagers(managerIds);
    });
  }

  // Run init when page loads
  init();
</script>