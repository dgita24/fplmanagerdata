---
import Nav from '../components/Nav.astro';
---
<Nav />
<h1>üîÑ Transfers Tracker</h1>
<p>Track all manager transfers</p>

<button id="fetch-btn" style="padding: 10px 20px; margin-bottom: 1em; background: #3182ce; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
  Fetch Latest Transfers
</button>

<div id="output"></div>

<!-- Transfer History Modal -->
<div id="transfer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background: white; margin: 50px auto; padding: 30px; max-width: 900px; border-radius: 8px; position: relative;">
    <button id="close-modal" style="position: absolute; top: 15px; right: 15px; background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 16px;">‚úï Close</button>
    <div id="modal-content"></div>
  </div>
</div>

<!-- Chip Detail Modal (nested) -->
<div id="chip-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; overflow-y: auto;">
  <div style="background: white; margin: 100px auto; padding: 30px; max-width: 700px; border-radius: 8px; position: relative;">
    <button id="close-chip-modal" style="position: absolute; top: 15px; right: 15px; background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚úï Close</button>
    <div id="chip-modal-content"></div>
  </div>
</div>

<script>
function loadManagerIds() {
  try {
    return JSON.parse(localStorage.getItem("globalManagerIds")) || [];
  } catch {
    return [];
  }
}

const out = document.getElementById("output");
const fetchBtn = document.getElementById("fetch-btn");
const transferModal = document.getElementById("transfer-modal");
const modalContent = document.getElementById("modal-content");
const closeModal = document.getElementById("close-modal");
const chipModal = document.getElementById("chip-modal");
const chipModalContent = document.getElementById("chip-modal-content");
const closeChipModal = document.getElementById("close-chip-modal");

let allPlayersMap = {};
let currentGW = null;

closeModal.addEventListener("click", () => {
  transferModal.style.display = "none";
});

closeChipModal.addEventListener("click", () => {
  chipModal.style.display = "none";
});

async function showTransferHistory(managerId, managerName) {
  modalContent.innerHTML = "<p>Loading transfer history...</p>";
  transferModal.style.display = "block";

  try {
    // Fetch manager history
    const historyRes = await fetch(`https://fantasy.premierleague.com/api/entry/${managerId}/history/`);
    const history = await historyRes.json();

    // Fetch all transfers
    const transfersRes = await fetch(`https://fantasy.premierleague.com/api/entry/${managerId}/transfers/`);
    const transfers = await transfersRes.json();

    // Group transfers by GW
    const transfersByGW = {};
    transfers.forEach(t => {
      if (!transfersByGW[t.event]) {
        transfersByGW[t.event] = [];
      }
      transfersByGW[t.event].push(t);
    });

    // Get chips used
    const chipsUsed = {};
    if (history.chips) {
      history.chips.forEach(chip => {
        chipsUsed[chip.event] = chip.name;
      });
    }

    let html = `<h2>${managerName} - Season Transfer History</h2>`;
    html += `<p style="color: #666;">Total Transfers: ${transfers.length}</p>`;

    // Build GW by GW
    const allGWs = [...new Set([...Object.keys(transfersByGW).map(Number), ...Object.keys(chipsUsed).map(Number)])].sort((a, b) => a - b);

    html += `<div style="max-height: 500px; overflow-y: auto;">`;

    allGWs.forEach(gw => {
      const chip = chipsUsed[gw];
      const gwTransfers = transfersByGW[gw] || [];
      const cost = history.current?.find(h => h.event === gw)?.event_transfers_cost || 0;

      html += `<div style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: #f7fafc;">`;
      html += `<h3 style="margin-top: 0;">Gameweek ${gw}</h3>`;

      if (chip) {
        const chipBadge = chip === 'wildcard' ? 'üÉè Wildcard' : chip === 'freehit' ? 'üéØ Free Hit' : chip;
        html += `<button class="chip-btn" data-gw="${gw}" data-manager="${managerId}" data-chip="${chip}" style="background: #805ad5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-size: 14px;">${chipBadge} (Click to view transfers)</button>`;
      } else if (gwTransfers.length > 0) {
        html += `<div style="font-size: 14px;">`;
        gwTransfers.forEach(t => {
          const playerIn = allPlayersMap[t.element_in] || `Player ${t.element_in}`;
          const playerOut = allPlayersMap[t.element_out] || `Player ${t.element_out}`;
          html += `<p style="margin: 5px 0;"><span style="color: #38a169;">‚ñ≤ ${playerIn}</span> ‚Üê <span style="color: #e53e3e;">‚ñº ${playerOut}</span></p>`;
        });
        if (cost > 0) {
          html += `<p style="color: #e53e3e; font-weight: bold; margin-top: 10px;">Hit taken: -${cost} pts</p>`;
        }
        html += `</div>`;
      } else {
        html += `<p style="color: #999; font-style: italic;">No transfers</p>`;
      }

      html += `</div>`;
    });

    html += `</div>`;

    modalContent.innerHTML = html;

    // Add event listeners for chip buttons
    document.querySelectorAll('.chip-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const gw = e.target.dataset.gw;
        const managerId = e.target.dataset.manager;
        const chip = e.target.dataset.chip;
        await showChipTransfers(managerId, gw, chip);
      });
    });

  } catch (error) {
    console.error("Error loading transfer history:", error);
    modalContent.innerHTML = "<p style='color: red;'>Error loading transfer history.</p>";
  }
}

async function showChipTransfers(managerId, gw, chipName) {
  chipModalContent.innerHTML = "<p>Loading chip transfers...</p>";
  chipModal.style.display = "block";

  try {
    // Get the squad before and after
    const picksRes = await fetch(`https://fantasy.premierleague.com/api/entry/${managerId}/event/${gw}/picks/`);
    const picks = await picksRes.json();

    const prevGW = parseInt(gw) - 1;
    let prevSquad = [];
    if (prevGW > 0) {
      try {
        const prevPicksRes = await fetch(`https://fantasy.premierleague.com/api/entry/${managerId}/event/${prevGW}/picks/`);
        const prevPicks = await prevPicksRes.json();
        prevSquad = prevPicks.picks?.map(p => p.element) || [];
      } catch (e) {
        console.warn("Couldn't fetch previous squad");
      }
    }

    const currentSquad = picks.picks?.map(p => p.element) || [];

    const playersIn = currentSquad.filter(p => !prevSquad.includes(p));
    const playersOut = prevSquad.filter(p => !currentSquad.includes(p));

    const chipDisplay = chipName === 'wildcard' ? 'üÉè Wildcard' : 'üéØ Free Hit';

    let html = `<h2>${chipDisplay} - Gameweek ${gw}</h2>`;
    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">`;
    
    html += `<div style="border: 1px solid #fc8181; border-radius: 6px; padding: 15px; background: #fff5f5;">`;
    html += `<h3 style="color: #e53e3e; margin-top: 0;">Players Out (${playersOut.length})</h3>`;
    playersOut.forEach(pid => {
      html += `<p style="margin: 5px 0;">‚ñº ${allPlayersMap[pid] || `Player ${pid}`}</p>`;
    });
    html += `</div>`;

    html += `<div style="border: 1px solid #68d391; border-radius: 6px; padding: 15px; background: #f0fff4;">`;
    html += `<h3 style="color: #38a169; margin-top: 0;">Players In (${playersIn.length})</h3>`;
    playersIn.forEach(pid => {
      html += `<p style="margin: 5px 0;">‚ñ≤ ${allPlayersMap[pid] || `Player ${pid}`}</p>`;
    });
    html += `</div>`;

    html += `</div>`;

    chipModalContent.innerHTML = html;

  } catch (error) {
    console.error("Error loading chip transfers:", error);
    chipModalContent.innerHTML = "<p style='color: red;'>Error loading chip transfers.</p>";
  }
}

async function fetchTransfers() {
  const ids = loadManagerIds();
  if (ids.length === 0) {
    out.innerHTML = '<p>No managers added yet. <a href="/managers">Add manager IDs</a>.</p>';
    return;
  }

  fetchBtn.disabled = true;
  fetchBtn.textContent = "Loading...";

  try {
    // Get current gameweek and players
    const bootstrapRes = await fetch("https://fantasy.premierleague.com/api/bootstrap-static/");
    const bootstrap = await bootstrapRes.json();
    currentGW = bootstrap.events.find(e => e.is_current)?.id || bootstrap.events[bootstrap.events.length - 1].id;

    // Build player map
    bootstrap.elements.forEach(p => {
      allPlayersMap[p.id] = p.web_name;
    });

    // Fetch latest transfer for each manager
    const managerTransfers = await Promise.all(
      ids.map(async (id) => {
        try {
          const [entryRes, transfersRes] = await Promise.all([
            fetch(`https://fantasy.premierleague.com/api/entry/${id}/`),
            fetch(`https://fantasy.premierleague.com/api/entry/${id}/transfers/`)
          ]);

          const entry = await entryRes.json();
          const transfers = await transfersRes.json();

          const latestTransfer = transfers[transfers.length - 1];

          return {
            id,
            name: `${entry.player_first_name} ${entry.player_last_name}`,
            teamName: entry.name,
            latestTransfer: latestTransfer || null,
            totalTransfers: transfers.length
          };
        } catch (e) {
          console.error(`Error fetching manager ${id}:`, e);
          return null;
        }
      })
    );

    const validManagers = managerTransfers.filter(m => m !== null);

    let html = `
      <h2>Latest Transfers</h2>
      <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; margin-top: 1em;">
        <thead>
          <tr style="background: #f0f0f0;">
            <th>Manager</th>
            <th>Team</th>
            <th>Total Transfers</th>
            <th>Latest Transfer</th>
            <th>GW</th>
          </tr>
        </thead>
        <tbody>
    `;

    validManagers.forEach(m => {
      const transferText = m.latestTransfer 
        ? `${allPlayersMap[m.latestTransfer.element_in]} ‚Üê ${allPlayersMap[m.latestTransfer.element_out]}`
        : 'No transfers yet';
      const gwText = m.latestTransfer ? `GW ${m.latestTransfer.event}` : '-';

      html += `
        <tr>
          <td><a href="#" class="manager-link" data-id="${m.id}" data-name="${m.name}" style="color: #3182ce; text-decoration: none; cursor: pointer;">${m.name}</a></td>
          <td>${m.teamName}</td>
          <td style="text-align: center;">${m.totalTransfers}</td>
          <td>${transferText}</td>
          <td style="text-align: center;">${gwText}</td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    out.innerHTML = html;

    // Add click handlers for manager names
    document.querySelectorAll('.manager-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const managerId = e.target.dataset.id;
        const managerName = e.target.dataset.name;
        showTransferHistory(managerId, managerName);
      });
    });

  } catch (error) {
    console.error("Error fetching transfers:", error);
    out.innerHTML = "<p style='color: red;'>Error loading transfers. Please try again.</p>";
  } finally {
    fetchBtn.disabled = false;
    fetchBtn.textContent = "Fetch Latest Transfers";
  }
}

fetchBtn.addEventListener("click", fetchTransfers);

// Auto-load on page load
fetchTransfers();
</script>

<style>
  table {
    font-size: 14px;
  }
  th {
    font-weight: 600;
  }
  a:hover {
    text-decoration: underline !important;
  }
  .chip-btn:hover {
    opacity: 0.9;
  }
</style>