---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Transfers & Free Transfers - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Transfers & Free Transfers</h1>
      <p class="page-subtitle">Calculated FTs for next GW for all managers.</p>
    </header>

    <div class="meta-row-wide">
      <span id="manager-count" class="badge badge-wide">Loading...</span>
      <a href="/managers" class="badge badge-wide">‚öô Manage IDs</a>
    </div>

    <div class="controls-inline">
      <div class="control-inline">
        <label class="label-small" for="gw-filter">Gameweek</label>
        <select class="select-small" id="gw-filter">
          <option value="">All GWs</option>
        </select>
      </div>
      <div class="control-inline">
        <label class="label-small">&nbsp;</label>
        <button id="refresh-btn" class="btn-row" type="button">üîÑ Refresh</button>
      </div>
    </div>

    <div id="loading-status" class="meta-row"></div>
    <section id="transfers-table" aria-live="polite"></section>
  </main>

  <!-- Transfer History Modal -->
  <div id="transfer-modal" class="modal">
    <div class="modal-panel">
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Chip Detail Modal -->
  <div id="chip-modal" class="modal modal--nested">
    <div class="modal-panel">
      <button id="close-chip-modal" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
      <div id="chip-modal-content"></div>
    </div>
  </div>
</Layout>

<style>
  .meta-row-wide {
    display: flex;
    gap: var(--space-2);
  }

  .badge-wide {
    flex: 1;
    justify-content: center;
    padding: var(--space-2) var(--space-3);
    text-align: center;
  }

  .controls-inline {
    display: flex;
    gap: var(--space-2);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
  }

  .control-inline {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .label-small {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-align: center;
  }

  .select-small {
    width: 100%;
    min-height: 36px;
    padding: 6px 8px;
    font-family: inherit;
    font-size: 13px;
    color: var(--color-text);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .select-small:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .btn-row {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 36px;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
  }

  .btn-row:hover {
    background: var(--color-primary-hover);
  }

  .chip-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    font-weight: 600;
    color: var(--color-primary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .chip-link:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
  }

  .chip-link--static {
    cursor: default;
  }

  .chip-link--static:hover {
    color: var(--color-primary);
    text-decoration: none;
  }

  .chip-row {
    margin-bottom: var(--space-2);
  }

  /* Highlight styles for table */
  .hit-highlight {
    color: var(--color-danger) !important;
    font-weight: 700 !important;
  }

  .top-scorer-row {
    color: var(--color-success) !important;
    font-weight: 700 !important;
  }

  .top-scorer-row a {
    color: var(--color-success) !important;
    font-weight: 700 !important;
  }
</style>

<script>
  function calculateFTs(managerHistory) {
    const byGW = new Map();
    managerHistory.forEach(row => byGW.set(row.gw, row));

    for (let i = 0; i < managerHistory.length; ++i) {
      const row = managerHistory[i];
      const E = Number(row.gw);
      const M = Number(row.transfers);
      let Q = 1;
      const prevRow = byGW.get(E - 1);
      const S = prevRow ? 1 : 0;

      if (E === 16) {
        Q = 5;
      } else if (E === 1) {
        Q = 0;
      } else if (S === 0) {
        Q = 1;
      } else if (!prevRow) {
        Q = 1;
      } else {
        const prevChip = prevRow.chipPlayed || "";
        const prevFTs = Number(prevRow.FTsStartOfGW);
        const prevTransfers = Number(prevRow.transfers);

        if (prevChip === "WC" || prevChip === "FH") {
          Q = Math.max(1, prevFTs - prevTransfers);
        } else {
          Q = Math.min(Math.max(1, prevFTs - prevTransfers + 1), 5);
        }
      }
      row.FTsStartOfGW = Q;
    }

    const maxGW = Math.max(...managerHistory.map(r => r.gw));
    managerHistory.forEach(row => {
      if (row.gw === maxGW) {
        const E = Number(row.gw);
        const Q = Number(row.FTsStartOfGW);
        const M = Number(row.transfers);
        const F = row.chipPlayed || "";

        if (E === 15) {
          row.FTsForNextGW = 5;
        } else {
          const inc = (F === "WC" || F === "FH") ? 0 : 1;
          row.FTsForNextGW = Math.min(Math.max(1, Q - M + inc), 5);
        }
      } else {
        row.FTsForNextGW = "";
      }
    });
  }

  import { supabase } from '../lib/supabase.ts'

  let managerIds = []

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  const out = document.getElementById("transfers-table");
  const gwFilterSelect = document.getElementById("gw-filter");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");
  const transferModal = document.getElementById("transfer-modal");
  const modalContent = document.getElementById("modal-content");
  const chipModal = document.getElementById("chip-modal");
  const chipModalContent = document.getElementById("chip-modal-content");
  const closeChipModal = document.getElementById("close-chip-modal");

  let allHistories = [];
  let latestGW = null;
  let allPlayersMap = {};

  closeChipModal.addEventListener("click", () => {
    chipModal.classList.remove("is-open");
  });

  function populateGWSelector(currentGW) {
    gwFilterSelect.innerHTML = '<option value="">All GWs</option>';
    for (let i = 1; i <= 38; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `GW ${i}`;
      if (i === currentGW) option.selected = true;
      gwFilterSelect.appendChild(option);
    }
  }

  async function fetchPlayers() {
    try {
      const res = await fetch('/api/fpl/bootstrap-static');
      if (!res.ok) return;
      const data = await res.json();
      data.elements.forEach(p => {
        allPlayersMap[p.id] = p.web_name;
      });

      const currentEvent = (data.events || []).find(e => e.is_current);
      latestGW = currentEvent ? currentEvent.id : 1;
      populateGWSelector(latestGW);
    } catch (e) {
      console.error("Error fetching players:", e);
    }
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function transferLineHtml(playerOut, playerIn) {
    return `
      <div style="display:flex; align-items:center; gap:var(--space-2); padding:var(--space-2); margin:var(--space-1) 0; border:1px solid var(--color-border); border-radius:var(--radius-md); font-size:var(--text-sm); flex-wrap:wrap;">
        <span class="badge badge--danger">OUT</span>
        <span class="font-bold">${escapeHtml(playerOut)}</span>
        <span class="text-muted">‚Üí</span>
        <span class="badge badge--success">IN</span>
        <span class="font-bold">${escapeHtml(playerIn)}</span>
      </div>
    `;
  }

  async function showTransferHistory(managerId, managerName) {
    modalContent.innerHTML = "<p class='text-muted'>Loading transfer history...</p>";
    transferModal.classList.add("is-open");

    try {
      const transfersRes = await fetch(`/api/fpl/entry/${managerId}/transfers`);
      const transfers = await transfersRes.json();

      const historyRes = await fetch(`/api/fpl/entry/${managerId}/history`);
      const history = await historyRes.json();

      const transfersByGW = {};
      transfers.forEach(t => {
        if (!transfersByGW[t.event]) transfersByGW[t.event] = [];
        transfersByGW[t.event].push(t);
      });

      const chipsUsed = {};
      if (history.chips) {
        history.chips.forEach(chip => {
          chipsUsed[chip.event] = chip.name;
        });
      }

      let html = `
        <button id="close-modal-btn" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
        <h2 class="modal-title">${escapeHtml(managerName)}</h2>
        <p class="text-muted" style="margin-bottom:var(--space-3); font-size:13px;">
          Total transfers: <strong>${transfers.length}</strong>
        </p>
        <div class="transfer-history-list">
      `;

      const allGWs = [...new Set([
        ...Object.keys(transfersByGW).map(Number),
        ...Object.keys(chipsUsed).map(Number)
      ])].sort((a, b) => b - a);

      for (const gw of allGWs) {
        const chip = chipsUsed[gw];
        const gwTransfers = transfersByGW[gw] || [];
        const cost = history.current?.find(h => h.event === gw)?.event_transfers_cost || 0;

        html += `<div class="transfer-gw-row">`;
        html += `<div class="transfer-gw-header">`;
        html += `<span class="transfer-gw-label">GW ${gw}</span>`;
        
        if (cost > 0) {
          html += `<span class="transfer-hit-badge">-${cost}</span>`;
        }
        html += `</div>`;

        html += `<div class="transfer-gw-content">`;

        if (chip) {
          const chipDisplay = chip === 'wildcard' ? 'Wildcard' : 
                              chip === 'freehit' ? 'Free Hit' : 
                              chip === 'bboost' ? 'Bench Boost' :
                              chip === '3xc' ? 'Triple Captain' : chip;

          const isClickableChip = chip === 'wildcard' || chip === 'freehit';

          if (isClickableChip) {
            html += `
              <div class="chip-row">
                <button class="chip-link chip-btn" data-gw="${gw}" data-manager="${managerId}" data-chip="${chip}" type="button">
                  ${chipDisplay}
                </button>
              </div>
            `;
          } else {
            html += `<div class="chip-row"><span class="chip-link chip-link--static">${chipDisplay}</span></div>`;
          }
        }

        const shouldShowTransfers = !chip || (chip !== 'wildcard' && chip !== 'freehit');

        if (shouldShowTransfers) {
          if (gwTransfers.length > 0) {
            for (const t of gwTransfers) {
              const playerIn = allPlayersMap[t.element_in] || `Player ${t.element_in}`;
              const playerOut = allPlayersMap[t.element_out] || `Player ${t.element_out}`;
              html += `
                <div class="transfer-row">
                  <span class="transfer-out">‚ñº ${escapeHtml(playerOut)}</span>
                  <span class="transfer-arrow">‚Üí</span>
                  <span class="transfer-in">‚ñ≤ ${escapeHtml(playerIn)}</span>
                </div>
              `;
            }
          } else {
            html += `<span class="text-muted" style="font-size:12px;">No transfers</span>`;
          }
        }

        html += `</div></div>`;
      }

      if (allGWs.length === 0) {
        html += `<p class="text-muted text-center" style="padding:var(--space-4);">No transfer activity yet.</p>`;
      }

      html += `</div>`;

      modalContent.innerHTML = html;

      document.getElementById("close-modal-btn")?.addEventListener("click", () => {
        transferModal.classList.remove("is-open");
      });

      document.querySelectorAll('.chip-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.target.closest('.chip-btn');
          const gw = button.dataset.gw;
          const oderId = button.dataset.manager;
          const chip = button.dataset.chip;
          await showChipTransfers(managerId, gw, chip);
        });
      });

    } catch (error) {
      console.error("Error loading transfer history:", error);
      modalContent.innerHTML = "<p class='status status--error'>Error loading transfer history.</p>";
    }
  }

  async function showChipTransfers(managerId, gw, chipName) {
    chipModalContent.innerHTML = "<p class='text-muted'>Loading chip details...</p>";
    chipModal.classList.add("is-open");

    try {
      const picksRes = await fetch(`/api/fpl/entry/${managerId}/event/${gw}/picks`);
      const picks = await picksRes.json();

      const prevGW = parseInt(gw) - 1;
      let prevSquad = [];
      if (prevGW > 0) {
        try {
          const prevPicksRes = await fetch(`/api/fpl/entry/${managerId}/event/${prevGW}/picks`);
          const prevPicks = await prevPicksRes.json();
          prevSquad = prevPicks.picks?.map(p => p.element) || [];
        } catch (e) {
          console.warn("Couldn't fetch previous squad");
        }
      }

      const currentSquad = picks.picks?.map(p => p.element) || [];

      const playersIn = currentSquad.filter(p => !prevSquad.includes(p));
      const playersOut = prevSquad.filter(p => !currentSquad.includes(p));

      const chipDisplay = chipName === 'wildcard' ? 'üÉè Wildcard' : 
                          chipName === 'freehit' ? 'üéØ Free Hit' :
                          chipName === 'bboost' ? 'ü™ë Bench Boost' :
                          chipName === '3xc' ? 'üëë Triple Captain' : chipName;

      let html = `
        <h2 class="modal-title" style="padding-right:40px;">${chipDisplay}</h2>
        <p class="text-muted" style="margin-bottom:var(--space-3); font-size:13px;">Gameweek ${gw}</p>
      `;

      if (chipName === 'wildcard' || chipName === 'freehit') {
        html += `<div class="chip-transfers-grid">`;

        html += `<div class="chip-transfer-section chip-transfer-section--out">`;
        html += `<div class="chip-transfer-header">Out (${playersOut.length})</div>`;
        html += `<div class="chip-transfer-list">`;
        if (playersOut.length > 0) {
          playersOut.forEach(pid => {
            html += `<div class="chip-transfer-item">‚ñº ${escapeHtml(allPlayersMap[pid] || `Player ${pid}`)}</div>`;
          });
        } else {
          html += `<div class="chip-transfer-item text-muted">None</div>`;
        }
        html += `</div></div>`;

        html += `<div class="chip-transfer-section chip-transfer-section--in">`;
        html += `<div class="chip-transfer-header">In (${playersIn.length})</div>`;
        html += `<div class="chip-transfer-list">`;
        if (playersIn.length > 0) {
          playersIn.forEach(pid => {
            html += `<div class="chip-transfer-item">‚ñ≤ ${escapeHtml(allPlayersMap[pid] || `Player ${pid}`)}</div>`;
          });
        } else {
          html += `<div class="chip-transfer-item text-muted">None</div>`;
        }
        html += `</div></div>`;

        html += `</div>`;
      } else {
        html += `<p class="text-muted text-center" style="padding:var(--space-3);">This chip doesn't involve transfers.</p>`;
      }

      chipModalContent.innerHTML = html;

    } catch (error) {
      console.error("Error loading chip transfers:", error);
      chipModalContent.innerHTML = "<p class='status status--error'>Error loading chip details.</p>";
    }
  }

  
  async function fetchHistory(id) {
    const historyUrl = `/api/fpl/entry/${id}/history`;
    const summaryUrl = `/api/fpl/entry/${id}`;

    const [historyRes, summaryRes] = await Promise.all([
      fetch(historyUrl),
      fetch(summaryUrl)
    ]);

    if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");

    const historyData = await historyRes.json();
    const summaryData = await summaryRes.json();

    const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;

    let history = historyData.current.map(gw => ({
      entryId: Number(id),
      managerName: managerName,
      gw: gw.event,
      chipPlayed: "",
      transfers: gw.event_transfers,
      transferCost: gw.event_transfers_cost ?? 0,
      benchPoints: gw.points_on_bench ?? 0,
      gwPoints: gw.points,
      totalPoints: gw.total_points
    }));

    if (Array.isArray(historyData.chips)) {
      historyData.chips.forEach(c => {
        const row = history.find(gw => gw.gw === c.event);
        if (row) {
          row.chipPlayed = (
            c.name === "wildcard" ? "WC" :
            c.name === "bboost" ? "BB" :
            c.name === "3xc" ? "TC" :
            c.name === "freehit" ? "FH" : c.name
          );
        }
      });
    }
    return history;
  }

  function makeTable(histories, filterGW = null) {
    let rows = histories.flat();

    if (filterGW !== null && filterGW !== "") {
      const gwNum = Number(filterGW);
      rows = rows.filter(r => r.gw === gwNum);
      rows.sort((a, b) => b.totalPoints - a.totalPoints);
    } else {
      rows.sort((a,b) => a.managerName.localeCompare(b.managerName) || a.gw - b.gw);
    }

    // Find highest GW score for highlighting
    let maxGwPoints = -Infinity;
    if (filterGW !== null && filterGW !== "") {
      rows.forEach(r => {
        if (r.gwPoints > maxGwPoints) {
          maxGwPoints = r.gwPoints;
        }
      });
    }

    let html = `
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table transfers-table">
            <thead>
              <tr>
                <th>Manager</th>
                <th class="hit-col">Hit</th>
                <th class="gwpts-col">GW Pts</th>
                <th class="total-col">Total</th>
                <th class="fts-col">FTs</th>
              </tr>
            </thead>
            <tbody>
    `;

    for (const r of rows) {
      const hitClass = r.transferCost > 0 ? 'hit-highlight' : '';

      // Determine FT-based row class
      let rowClass = '';
      const fts = Number(r.FTsForNextGW);
      if (fts >= 3 && fts <= 5) {
        rowClass = 'ft-high-row';      // Yellow
      } else if (fts === 2) {
        rowClass = 'ft-medium-row';    // Blue
      } else if (fts === 1) {
        rowClass = 'ft-low-row';       // Red
      }

      html += `
        <tr class="${rowClass}">
          <td class="strong nowrap">
            <a href="#" class="manager-link" data-id="${r.entryId}" data-name="${r.managerName}">${r.managerName}</a>
          </td>
          <td class="num ${hitClass}">${r.transferCost || 0}</td>
          <td class="num">${r.gwPoints ?? ""}</td>
          <td class="num">${r.totalPoints ?? ""}</td>
          <td class="num strong">${r.FTsForNextGW ?? ""}</td>
        </tr>
      `;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    return html;
  }

  async function loadManagers(ids) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    allHistories = [];
    out.innerHTML = "";
    loadingStatus.textContent = `Loading 0 of ${ids.length}...`;

    let loaded = 0;
    for (const id of ids) {
      try {
        let history = await fetchHistory(id);
        calculateFTs(history);
        allHistories.push(history);

        const managerMaxGW = Math.max(...history.map(h => h.gw));
        if (latestGW === null || managerMaxGW > latestGW) {
          latestGW = managerMaxGW;
        }

        loaded++;
        loadingStatus.textContent = `Loading ${loaded} of ${ids.length}...`;
        out.innerHTML = makeTable(allHistories, "");
        attachManagerLinks();
      } catch (e) {
        console.error(`Failed to load manager ${id}:`, e);
        loaded++;
      }
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>‚úÖ Loaded ${loaded} managers</span>`;

    if (latestGW) {
      gwFilterSelect.value = latestGW;
      filterByGW();
    }
  }

  function attachManagerLinks() {
    document.querySelectorAll('.manager-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const managerId = e.target.dataset.id;
        const managerName = e.target.dataset.name;
        showTransferHistory(managerId, managerName);
      });
    });
  }

  function filterByGW() {
    const filterGW = gwFilterSelect.value;
    out.innerHTML = makeTable(allHistories, filterGW);
    attachManagerLinks();
  }

  (async function init() {
    await fetchPlayers();

    const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
    if (!authenticated) return;

    managerIds = ids;
    managerCountEl.textContent = `${managerIds.length} managers`;

    if (managerIds.length > 0) {
      loadManagers(managerIds);
    } else {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
    }
  })();

  gwFilterSelect.addEventListener('change', filterByGW);

  refreshBtn.addEventListener('click', async () => {
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;
    loadManagers(managerIds);
  });
</script>