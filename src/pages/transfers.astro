---
import Nav from '../components/Nav.astro';
import { calculateFTs } from '../components/fts.js';

// UI: default manager IDs for demo (can auto-fill from input)
const defaultIds = ['4290','200','1320','1587','6586','260'];

// "Fetch" in browser JS, so provide HTML container
---

<Nav />
<h1>Transfers & Free Transfers (FTs) for Next GW</h1>
<p>Display calculated FTs for next GW for any set of managers, like your Excel.</p>

<form id="manager-form">
  <label for="ids">Manager EntryIDs (one per line):</label><br>
  <textarea id="ids" rows="6" cols="30" style="font-family:monospace" placeholder="4290&#10;200&#10;1320"></textarea><br>
  <button type="submit">Load History</button>
</form>

<div id="transfers-table" style="margin-top:1.5em"></div>

<script type="module">
// Inline FT calculation logic (from fts.js, slightly rewritten for browser)
function calculateFTs(managerHistory) {
  const byGW = new Map();
  managerHistory.forEach(row => byGW.set(row.gw, row));

  for (let i = 0; i < managerHistory.length; ++i) {
    const row = managerHistory[i];
    const E = Number(row.gw);
    const F = row.chipPlayed || "";
    const M = Number(row.transfers);
    let Q = 1;
    if (E === 16) {
      Q = 5;
    } else if (E === 1) {
      Q = 0;
    } else if (M === 0) {
      Q = 1;
    } else {
      const prevRow = byGW.get(E-1);
      if (!prevRow) {
        Q = 1;
      } else if (["WC","FH"].includes(prevRow.chipPlayed)) {
        Q = Math.max(1, prevRow.FTsStartOfGW - prevRow.transfers);
      } else {
        Q = Math.min(Math.max(1, prevRow.FTsStartOfGW - prevRow.transfers + 1), 5);
      }
    }
    row.FTsStartOfGW = Q;
  }

  const maxGW = Math.max(...managerHistory.map(r => r.gw));
  managerHistory.forEach(row => {
    if (row.gw === maxGW) {
      if (row.gw === 15) {
        row.FTsForNextGW = 5;
      } else {
        const Q = row.FTsStartOfGW;
        const M = row.transfers;
        const F = row.chipPlayed;
        const inc = (F === "WC" || F === "FH") ? 0 : 1;
        row.FTsForNextGW = Math.min(Math.max(1, Q-M+inc), 5);
      }
    } else {
      row.FTsForNextGW = "";
    }
  });
}

// Local storage helpers
function saveEntryIds(ids) {
  localStorage.setItem("entryIds", JSON.stringify(ids));
}
function loadEntryIds() {
  try {
    return JSON.parse(localStorage.getItem("entryIds")) || [];
  } catch {
    return [];
  }
}

const defaultIds = ["4290","200","1320","1587","6586","260"];
const form = document.getElementById("manager-form");
const textarea = document.getElementById("ids");
const out = document.getElementById("transfers-table");

// Try to load IDs from localStorage, else use default:
const idsFromStorage = loadEntryIds();
if (idsFromStorage.length > 0) {
  textarea.value = idsFromStorage.join("\n");
} else {
  textarea.value = defaultIds.join("\n");
}

async function fetchHistory(id) {
  const url = `/api/fpl/entry/${id}/history/`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Load error");
  const data = await res.json();
  let history = data.current.map(gw => ({
    entryId: Number(id),
    gw: gw.event,
    chipPlayed: "",
    transfers: gw.event_transfers,
    transferCost: gw.event_transfers_cost ?? 0,
    benchPoints: gw.points_on_bench ?? 0,
    gwPoints: gw.points,
    totalPoints: gw.total_points
  }));
  if (Array.isArray(data.chips)) {
    data.chips.forEach(c => {
      const row = history.find(gw => gw.gw === c.event);
      if (row) {
        row.chipPlayed = (
          c.name === "wildcard" ? "WC" :
          c.name === "bboost" ? "BB" :
          c.name === "3xc" ? "TC" :
          c.name === "freehit" ? "FH" : c.name
        );
      }
    });
  }
  return history;
}

function makeTable(histories) {
  let rows = histories.flat();
  rows.sort((a,b) => a.entryId-b.entryId || a.gw-b.gw);

  let html = `<table border="1" cellpadding="4" style="border-collapse:collapse">
    <tr>
      <th>EntryID</th>
      <th>GW</th>
      <th>ChipPlayed</th>
      <th>Transfers</th>
      <th>TransferCost</th>
      <th>GW Points</th>
      <th>Total Points</th>
      <th>FTs Start of GW</th>
      <th style="background:lightyellow">FTs for next GW</th>
    </tr>`;
  for (const r of rows) {
    html += `<tr>
      <td>${r.entryId}</td>
      <td>${r.gw}</td>
      <td>${r.chipPlayed || ""}</td>
      <td>${r.transfers ?? ""}</td>
      <td>${r.transferCost ?? ""}</td>
      <td>${r.gwPoints ?? ""}</td>
      <td>${r.totalPoints ?? ""}</td>
      <td>${r.FTsStartOfGW ?? ""}</td>
      <td style="background:lightyellow">${r.FTsForNextGW ?? ""}</td>
    </tr>`;
  }
  html += "</table>";
  return html;
}

async function loadManagers(ids) {
  out.textContent = "Loading...";
  try {
    const allHistories = [];
    for (const id of ids) {
      let history = await fetchHistory(id);
      calculateFTs(history);
      allHistories.push(history);
    }
    out.innerHTML = makeTable(allHistories);
    saveEntryIds(ids); // Save to localStorage on success
  } catch (e) {
    out.innerHTML = "<span style='color:red'>Error loading history. Check EntryIDs and network connection.</span>";
  }
}

// Initial load
const parsedIds = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/));
if (parsedIds.length) loadManagers(parsedIds);

form.onsubmit = (e) => {
  e.preventDefault();
  const ids = textarea.value.trim().split(/[\s,]+/).filter(x => x.match(/^\d+$/));
  if (ids.length === 0) {
    out.innerHTML = "<span style='color:red'>Enter at least one valid EntryID.</span>";
    return;
  }
  loadManagers(ids);
};
</script>
