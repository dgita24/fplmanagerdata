---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Transfers & Free Transfers - FPL Manager Data">
  <Nav />

  <main class="page">
    <header class="page-header">
      <h1 class="page-title">Transfers & Free Transfers</h1>
      <p class="page-subtitle">Calculated FTs for next GW for all managers.</p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading...</span>
      <a href="/managers" class="badge">‚öô Manage IDs</a>
    </div>

    <section class="controls">
      <div class="control">
        <label class="label" for="gw-filter">Gameweek</label>
        <input class="input" type="number" id="gw-filter" min="1" max="38" placeholder="Auto" inputmode="numeric" />
      </div>

      <div class="control">
        <label class="label">Actions</label>
        <div class="control-actions">
          <button id="clear-filter-btn" class="btn btn--neutral" type="button">All GWs</button>
          <button id="refresh-btn" class="btn btn--primary" type="button">üîÑ Refresh</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>
    <section id="transfers-table" aria-live="polite"></section>
  </main>

  <!-- Transfer History Modal -->
  <div id="transfer-modal" class="modal">
    <div class="modal-panel">
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Chip Detail Modal -->
  <div id="chip-modal" class="modal modal--nested">
    <div class="modal-panel">
      <button id="close-chip-modal" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
      <div id="chip-modal-content"></div>
    </div>
  </div>
</Layout>

<script>
  // Inline FT calculation logic - MATCHES EXCEL EXACTLY
  function calculateFTs(managerHistory) {
    const byGW = new Map();
    managerHistory.forEach(row => byGW.set(row.gw, row));

    for (let i = 0; i < managerHistory.length; ++i) {
      const row = managerHistory[i];
      const E = Number(row.gw);
      const M = Number(row.transfers);
      let Q = 1;
      const prevRow = byGW.get(E - 1);
      const S = prevRow ? 1 : 0;

      if (E === 16) {
        Q = 5;
      } else if (E === 1) {
        Q = 0;
      } else if (S === 0) {
        Q = 1;
      } else if (!prevRow) {
        Q = 1;
      } else {
        const prevChip = prevRow.chipPlayed || "";
        const prevFTs = Number(prevRow.FTsStartOfGW);
        const prevTransfers = Number(prevRow.transfers);

        if (prevChip === "WC" || prevChip === "FH") {
          Q = Math.max(1, prevFTs - prevTransfers);
        } else {
          Q = Math.min(Math.max(1, prevFTs - prevTransfers + 1), 5);
        }
      }
      row.FTsStartOfGW = Q;
    }

    const maxGW = Math.max(...managerHistory.map(r => r.gw));
    managerHistory.forEach(row => {
      if (row.gw === maxGW) {
        const E = Number(row.gw);
        const Q = Number(row.FTsStartOfGW);
        const M = Number(row.transfers);
        const F = row.chipPlayed || "";

        if (E === 15) {
          row.FTsForNextGW = 5;
        } else {
          const inc = (F === "WC" || F === "FH") ? 0 : 1;
          row.FTsForNextGW = Math.min(Math.max(1, Q - M + inc), 5);
        }
      } else {
        row.FTsForNextGW = "";
      }
    });
  }

  import { supabase } from '../lib/supabase.ts'

  let managerIds = []

  async function loadManagerIdsFromSupabase() {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      window.location.replace('/login')
      return { authenticated: false, managerIds: [] }
    }

    try {
      const { data, error } = await supabase
        .from('user_manager_lists')
        .select('manager_ids')
        .eq('user_id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading manager IDs:', error)
        return { authenticated: true, managerIds: [] }
      }

      return { authenticated: true, managerIds: data?.manager_ids || [] }
    } catch (e) {
      console.error('Error:', e)
      return { authenticated: false, managerIds: [] }
    }
  }

  const out = document.getElementById("transfers-table");
  const gwFilterInput = document.getElementById("gw-filter");
  const clearFilterBtn = document.getElementById("clear-filter-btn");
  const loadingStatus = document.getElementById("loading-status");
  const managerCountEl = document.getElementById("manager-count");
  const refreshBtn = document.getElementById("refresh-btn");
  const transferModal = document.getElementById("transfer-modal");
  const modalContent = document.getElementById("modal-content");
  const chipModal = document.getElementById("chip-modal");
  const chipModalContent = document.getElementById("chip-modal-content");
  const closeChipModal = document.getElementById("close-chip-modal");

  let allHistories = [];
  let latestGW = null;
  let allPlayersMap = {};

  closeChipModal.addEventListener("click", () => {
    chipModal.classList.remove("is-open");
  });

  async function fetchPlayers() {
    try {
      const res = await fetch('/api/fpl/bootstrap-static');
      if (!res.ok) return;
      const data = await res.json();
      data.elements.forEach(p => {
        allPlayersMap[p.id] = p.web_name;
      });
    } catch (e) {
      console.error("Error fetching players:", e);
    }
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function transferLineHtml(playerOut, playerIn) {
    return `
      <div style="display:flex; align-items:center; gap:var(--space-2); padding:var(--space-2); margin:var(--space-1) 0; border:1px solid var(--color-border); border-radius:var(--radius-md); font-size:var(--text-sm); flex-wrap:wrap;">
        <span class="badge badge--danger">OUT</span>
        <span class="font-bold">${escapeHtml(playerOut)}</span>
        <span class="text-muted">‚Üí</span>
        <span class="badge badge--success">IN</span>
        <span class="font-bold">${escapeHtml(playerIn)}</span>
      </div>
    `;
  }

  async function showTransferHistory(managerId, managerName) {
    modalContent.innerHTML = "<p>Loading transfer history...</p>";
    transferModal.classList.add("is-open");

    try {
      const transfersRes = await fetch(`/api/fpl/entry/${managerId}/transfers`);
      const transfers = await transfersRes.json();

      const historyRes = await fetch(`/api/fpl/entry/${managerId}/history`);
      const history = await historyRes.json();

      const transfersByGW = {};
      transfers.forEach(t => {
        if (!transfersByGW[t.event]) transfersByGW[t.event] = [];
        transfersByGW[t.event].push(t);
      });

      const chipsUsed = {};
      if (history.chips) {
        history.chips.forEach(chip => {
          chipsUsed[chip.event] = chip.name;
        });
      }

      let html = `
        <button id="close-modal-btn" class="btn btn--danger btn--small modal-close" type="button">‚úï</button>
        <h2 class="modal-title">${escapeHtml(managerName)}</h2>
        <p class="text-muted" style="margin-bottom:var(--space-4);">Total Transfers: ${transfers.length}</p>
      `;

      const allGWs = [...new Set([
        ...Object.keys(transfersByGW).map(Number),
        ...Object.keys(chipsUsed).map(Number)
      ])].sort((a, b) => a - b);

      html += `<div style="max-height:60vh; overflow-y:auto;">`;

      allGWs.forEach(gw => {
        const chip = chipsUsed[gw];
        const gwTransfers = transfersByGW[gw] || [];
        const cost = history.current?.find(h => h.event === gw)?.event_transfers_cost || 0;

        html += `<div class="card" style="margin-bottom:var(--space-3);">`;
        html += `<div class="card-body">`;
        html += `<h3 style="margin:0 0 var(--space-2) 0; font-size:var(--text-sm);">GW ${gw}</h3>`;

        if (chip) {
          const chipBadge = chip === 'wildcard' ? 'üÉè Wildcard' : chip === 'freehit' ? 'üéØ Free Hit' : chip;
          html += `<button class="chip-btn btn btn--primary btn--small" data-gw="${gw}" data-manager="${managerId}" data-chip="${chip}" type="button">${chipBadge} (view)</button>`;
        } else if (gwTransfers.length > 0) {
          gwTransfers.forEach(t => {
            const playerIn = allPlayersMap[t.element_in] || `Player ${t.element_in}`;
            const playerOut = allPlayersMap[t.element_out] || `Player ${t.element_out}`;
            html += transferLineHtml(playerOut, playerIn);
          });
          if (cost > 0) {
            html += `<p class="text-danger font-bold" style="margin-top:var(--space-2);">Hit: -${cost} pts</p>`;
          }
        } else {
          html += `<p class="text-muted">No transfers</p>`;
        }

        html += `</div></div>`;
      });

      html += `</div>`;

      modalContent.innerHTML = html;

      document.getElementById("close-modal-btn")?.addEventListener("click", () => {
        transferModal.classList.remove("is-open");
      });

      document.querySelectorAll('.chip-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const gw = e.target.dataset.gw;
          const managerId = e.target.dataset.manager;
          const chip = e.target.dataset.chip;
          await showChipTransfers(managerId, gw, chip);
        });
      });

    } catch (error) {
      console.error("Error loading transfer history:", error);
      modalContent.innerHTML = "<p class='status status--error'>Error loading transfer history.</p>";
    }
  }

  async function showChipTransfers(managerId, gw, chipName) {
    chipModalContent.innerHTML = "<p>Loading chip transfers...</p>";
    chipModal.classList.add("is-open");

    try {
      const picksRes = await fetch(`/api/fpl/entry/${managerId}/event/${gw}/picks`);
      const picks = await picksRes.json();

      const prevGW = parseInt(gw) - 1;
      let prevSquad = [];
      if (prevGW > 0) {
        try {
          const prevPicksRes = await fetch(`/api/fpl/entry/${managerId}/event/${prevGW}/picks`);
          const prevPicks = await prevPicksRes.json();
          prevSquad = prevPicks.picks?.map(p => p.element) || [];
        } catch (e) {
          console.warn("Couldn't fetch previous squad");
        }
      }

      const currentSquad = picks.picks?.map(p => p.element) || [];

      const playersIn = currentSquad.filter(p => !prevSquad.includes(p));
      const playersOut = prevSquad.filter(p => !currentSquad.includes(p));

      const chipDisplay = chipName === 'wildcard' ? 'üÉè Wildcard' : 'üéØ Free Hit';

      let html = `<h2 class="modal-title">${chipDisplay} - GW ${gw}</h2>`;
      html += `<div style="display:grid; gap:var(--space-3);">`;

      html += `<div style="border:1px solid rgb(220 38 38 / 0.35); border-radius:var(--radius-md); padding:var(--space-3); background:rgb(220 38 38 / 0.05);">`;
      html += `<h3 class="text-danger" style="margin:0 0 var(--space-2) 0; font-size:var(--text-sm);">Out (${playersOut.length})</h3>`;
      playersOut.forEach(pid => {
        html += `<p style="margin:var(--space-1) 0; font-size:var(--text-sm);">‚ñº ${escapeHtml(allPlayersMap[pid] || `Player ${pid}`)}</p>`;
      });
      html += `</div>`;

      html += `<div style="border:1px solid rgb(22 163 74 / 0.35); border-radius:var(--radius-md); padding:var(--space-3); background:rgb(22 163 74 / 0.05);">`;
      html += `<h3 class="text-success" style="margin:0 0 var(--space-2) 0; font-size:var(--text-sm);">In (${playersIn.length})</h3>`;
      playersIn.forEach(pid => {
        html += `<p style="margin:var(--space-1) 0; font-size:var(--text-sm);">‚ñ≤ ${escapeHtml(allPlayersMap[pid] || `Player ${pid}`)}</p>`;
      });
      html += `</div>`;

      html += `</div>`;

      chipModalContent.innerHTML = html;

    } catch (error) {
      console.error("Error loading chip transfers:", error);
      chipModalContent.innerHTML = "<p class='status status--error'>Error loading chip transfers.</p>";
    }
  }

  async function fetchHistory(id) {
    const historyUrl = `/api/fpl/entry/${id}/history`;
    const summaryUrl = `/api/fpl/entry/${id}`;

    const [historyRes, summaryRes] = await Promise.all([
      fetch(historyUrl),
      fetch(summaryUrl)
    ]);

    if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");

    const historyData = await historyRes.json();
    const summaryData = await summaryRes.json();

    const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;

    let history = historyData.current.map(gw => ({
      entryId: Number(id),
      managerName: managerName,
      gw: gw.event,
      chipPlayed: "",
      transfers: gw.event_transfers,
      transferCost: gw.event_transfers_cost ?? 0,
      benchPoints: gw.points_on_bench ?? 0,
      gwPoints: gw.points,
      totalPoints: gw.total_points
    }));

    if (Array.isArray(historyData.chips)) {
      historyData.chips.forEach(c => {
        const row = history.find(gw => gw.gw === c.event);
        if (row) {
          row.chipPlayed = (
            c.name === "wildcard" ? "WC" :
            c.name === "bboost" ? "BB" :
            c.name === "3xc" ? "TC" :
            c.name === "freehit" ? "FH" : c.name
          );
        }
      });
    }
    return history;
  }

  function makeTable(histories, filterGW = null) {
    let rows = histories.flat();

    if (filterGW !== null && filterGW !== "") {
      const gwNum = Number(filterGW);
      rows = rows.filter(r => r.gw === gwNum);
      rows.sort((a, b) => b.totalPoints - a.totalPoints);
    } else {
      rows.sort((a,b) => a.managerName.localeCompare(b.managerName) || a.gw-b.gw);
    }

    let html = `
      <div class="table-container">
        <div class="table-scroll">
          <table class="data-table">
            <thead>
              <tr>
                <th>Manager</th>
                <th class="num col-narrow">Hit</th>
                <th class="num col-narrow">GW Pts</th>
                <th class="num col-narrow">Total</th>
                <th class="num col-narrow">FTs Next</th>
              </tr>
            </thead>
            <tbody>
    `;

    for (const r of rows) {
      html += `
        <tr>
          <td class="strong nowrap">
            <a href="#" class="manager-link" data-id="${r.entryId}" data-name="${r.managerName}">${r.managerName}</a>
          </td>
          <td class="num col-narrow">${r.transferCost || 0}</td>
          <td class="num col-narrow">${r.gwPoints ?? ""}</td>
          <td class="num col-narrow">${r.totalPoints ?? ""}</td>
          <td class="num col-narrow strong">${r.FTsForNextGW ?? ""}</td>
        </tr>
      `;
    }

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    return html;
  }

  async function loadManagers(ids) {
    if (ids.length === 0) {
      out.innerHTML = "<p class='status status--error'>No manager IDs found. <a href='/managers'>Add managers here</a>.</p>";
      return;
    }

    allHistories = [];
    latestGW = null;
    out.innerHTML = "";
    loadingStatus.textContent = `Loading 0 of ${ids.length}...`;

    let loaded = 0;
    for (const id of ids) {
      try {
        let history = await fetchHistory(id);
        calculateFTs(history);
        allHistories.push(history);

        const managerMaxGW = Math.max(...history.map(h => h.gw));
        if (latestGW === null || managerMaxGW > latestGW) {
          latestGW = managerMaxGW;
        }

        loaded++;
        loadingStatus.textContent = `Loading ${loaded} of ${ids.length}...`;
        out.innerHTML = makeTable(allHistories, "");
        attachManagerLinks();
      } catch (e) {
        console.error(`Failed to load manager ${id}:`, e);
        loaded++;
      }
    }

    loadingStatus.innerHTML = `<span class='text-success font-bold'>‚úÖ Loaded ${loaded} managers</span>`;

    if (latestGW) {
      gwFilterInput.value = latestGW;
      gwFilterInput.placeholder = `GW${latestGW}`;
      filterByGW();
    }
  }

  function attachManagerLinks() {
    document.querySelectorAll('.manager-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const managerId = e.target.dataset.id;
        const managerName = e.target.dataset.name;
        showTransferHistory(managerId, managerName);
      });
    });
  }

  function filterByGW() {
    const filterGW = gwFilterInput.value.trim();
    out.innerHTML = makeTable(allHistories, filterGW);
    attachManagerLinks();
  }

  fetchPlayers();

  (async function init() {
    await fetchPlayers();

    const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
    if (!authenticated) return;

    managerIds = ids;
    managerCountEl.textContent = `${managerIds.length} managers`;

    if (managerIds.length > 0) {
      loadManagers(managerIds);
    } else {
      out.innerHTML = "<p class='status status--error'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</p>";
    }
  })();

  gwFilterInput.addEventListener('input', filterByGW);

  clearFilterBtn.addEventListener('click', () => {
    gwFilterInput.value = "";
    filterByGW();
  });

  refreshBtn.addEventListener('click', async () => {
    gwFilterInput.value = "";
    const { managerIds: ids } = await loadManagerIdsFromSupabase();
    managerIds = ids;
    loadManagers(managerIds);
  });
</script>