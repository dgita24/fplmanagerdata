---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
---
<Layout title="Transfers & Free Transfers (FTs) - FPL Manager Data">
  <Nav />

  <div class="page">
    <header class="page-header">
      <h1 class="page-title">Transfers &amp; Free Transfers (FTs) for Next GW</h1>
      <p class="page-subtitle">Display calculated FTs for next GW for all managers.</p>
    </header>

    <div class="meta-row">
      <span id="manager-count" class="badge">Loading managers...</span>
      <a href="/managers" class="badge">‚öô Manage IDs</a>
    </div>

    <section class="controls" aria-label="Transfers controls">
      <div class="control" style="grid-column: span 3;">
        <label class="label" for="gw-filter">Filter by Gameweek</label>
        <input class="input" type="number" id="gw-filter" min="1" max="38" placeholder="Auto" inputmode="numeric" />
      </div>

      <div class="control" style="grid-column: span 9;">
        <span class="label">Actions</span>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="clear-filter-btn" class="btn btn--neutral" type="button">Show All GWs</button>
          <button id="refresh-btn" class="btn btn--primary" type="button">üîÑ Refresh Data</button>
        </div>
      </div>
    </section>

    <div id="loading-status" class="meta-row"></div>
    <section id="transfers-table" aria-live="polite"></section>
  </div>

  <!-- Transfer History Modal -->
  <div
    id="transfer-modal"
    style="
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 1000;
      overflow-y: auto;
      padding: 16px;
    "
  >
    <div
      style="
        background: white;
        margin: 24px auto;
        padding: 18px;
        max-width: 1100px;
        width: min(1100px, calc(100vw - 24px));
        border-radius: 12px;
        position: relative;
        box-shadow: var(--shadow-md);
      "
    >
      <button
        id="close-modal"
        class="btn btn--danger"
        style="position: sticky; top: 12px; float: right; z-index: 5;"
        type="button"
      >
        ‚úï Close
      </button>

      <!-- Scrolling content area (taller than before) -->
      <div
        id="modal-content"
        style="
          margin-top: 8px;
          font-size: 1.05rem;
          line-height: 1.55;
          max-height: 85vh;
          overflow-y: auto;
          padding-right: 10px;
        "
      ></div>
    </div>
  </div>

  <!-- Chip Detail Modal (nested) -->
  <div
    id="chip-modal"
    style="
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1001;
      overflow-y: auto;
      padding: 16px;
    "
  >
    <div
      style="
        background: white;
        margin: 40px auto;
        padding: 18px;
        max-width: 800px;
        width: min(800px, calc(100vw - 24px));
        border-radius: 12px;
        position: relative;
        box-shadow: var(--shadow-md);
      "
    >
      <button
        id="close-chip-modal"
        class="btn btn--danger"
        style="position: sticky; top: 12px; float: right; z-index: 5;"
        type="button"
      >
        ‚úï Close
      </button>

      <div
        id="chip-modal-content"
        style="
          margin-top: 8px;
          font-size: 1.05rem;
          line-height: 1.55;
          max-height: 80vh;
          overflow-y: auto;
          padding-right: 10px;
        "
      ></div>
    </div>
  </div>

  <script>
    // Inline FT calculation logic - MATCHES EXCEL EXACTLY
    function calculateFTs(managerHistory) {
      const byGW = new Map();
      managerHistory.forEach(row => byGW.set(row.gw, row));

      for (let i = 0; i < managerHistory.length; ++i) {
        const row = managerHistory[i];
        const E = Number(row.gw);
        const M = Number(row.transfers);
        let Q = 1;
        const prevRow = byGW.get(E - 1);
        const S = prevRow ? 1 : 0;
        
        if (E === 16) {
          Q = 5;
        } else if (E === 1) {
          Q = 0;
        } else if (S === 0) {
          Q = 1;
        } else if (!prevRow) {
          Q = 1;
        } else {
          const prevChip = prevRow.chipPlayed || "";
          const prevFTs = Number(prevRow.FTsStartOfGW);
          const prevTransfers = Number(prevRow.transfers);
          
          if (prevChip === "WC" || prevChip === "FH") {
            Q = Math.max(1, prevFTs - prevTransfers);
          } else {
            Q = Math.min(Math.max(1, prevFTs - prevTransfers + 1), 5);
          }
        }
        row.FTsStartOfGW = Q;
      }

      const maxGW = Math.max(...managerHistory.map(r => r.gw));
      managerHistory.forEach(row => {
        if (row.gw === maxGW) {
          const E = Number(row.gw);
          const Q = Number(row.FTsStartOfGW);
          const M = Number(row.transfers);
          const F = row.chipPlayed || "";
          
          if (E === 15) {
            row.FTsForNextGW = 5;
          } else {
            const inc = (F === "WC" || F === "FH") ? 0 : 1;
            row.FTsForNextGW = Math.min(Math.max(1, Q - M + inc), 5);
          }
        } else {
          row.FTsForNextGW = "";
        }
      });
    }

    import { supabase } from '../lib/supabase.ts'

    let managerIds = []

    async function loadManagerIdsFromSupabase() {
      const { data: { user } } = await supabase.auth.getUser()
      
      if (!user) {
        window.location.replace('/login')
        return { authenticated: false, managerIds: [] }
      }
      
      try {
        const { data, error } = await supabase
          .from('user_manager_lists')
          .select('manager_ids')
          .eq('user_id', user.id)
          .single()
        
        if (error && error.code !== 'PGRST116') {
          console.error('Error loading manager IDs:', error)
          return { authenticated: true, managerIds: [] }
        }
        
        return { authenticated: true, managerIds: data?.manager_ids || [] }
      } catch (e) {
        console.error('Error:', e)
        return { authenticated: false, managerIds: [] }
      }
    }

    const out = document.getElementById("transfers-table");
    const gwFilterInput = document.getElementById("gw-filter");
    const clearFilterBtn = document.getElementById("clear-filter-btn");
    const loadingStatus = document.getElementById("loading-status");
    const managerCountEl = document.getElementById("manager-count");
    const refreshBtn = document.getElementById("refresh-btn");
    const transferModal = document.getElementById("transfer-modal");
    const modalContent = document.getElementById("modal-content");
    const closeModal = document.getElementById("close-modal");
    const chipModal = document.getElementById("chip-modal");
    const chipModalContent = document.getElementById("chip-modal-content");
    const closeChipModal = document.getElementById("close-chip-modal");

    let allHistories = [];
    let latestGW = null;
    let allPlayersMap = {};

    closeModal.addEventListener("click", () => {
      transferModal.style.display = "none";
    });

    closeChipModal.addEventListener("click", () => {
      chipModal.style.display = "none";
    });

    // Close when clicking backdrop
    transferModal.addEventListener("click", (e) => {
      if (e.target === transferModal) transferModal.style.display = "none";
    });

    chipModal.addEventListener("click", (e) => {
      if (e.target === chipModal) chipModal.style.display = "none";
    });

    // Fetch player names
    async function fetchPlayers() {
      try {
        const res = await fetch('/api/fpl/bootstrap-static');
        if (!res.ok) return;
        const data = await res.json();
        data.elements.forEach(p => {
          allPlayersMap[p.id] = p.web_name;
        });
      } catch (e) {
        console.error("Error fetching players:", e);
      }
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function transferLineHtml(playerOut, playerIn) {
      return `
        <div style="
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 12px;
          border: 1px solid var(--border);
          border-radius: 10px;
          background: #fff;
          margin: 8px 0;
        ">
          <span style="
            display:inline-flex;
            align-items:center;
            padding: 3px 10px;
            border-radius: 999px;
            font-weight: 900;
            color: var(--danger);
            background: rgba(220,38,38,0.10);
            border: 1px solid rgba(220,38,38,0.25);
            flex: 0 0 auto;
          ">OUT</span>

          <span style="font-weight: 800; flex: 1 1 auto;">${escapeHtml(playerOut)}</span>

          <span style="color: var(--muted); font-weight: 900; flex: 0 0 auto;">‚Üí</span>

          <span style="
            display:inline-flex;
            align-items:center;
            padding: 3px 10px;
            border-radius: 999px;
            font-weight: 900;
            color: var(--success);
            background: rgba(22,163,74,0.10);
            border: 1px solid rgba(22,163,74,0.25);
            flex: 0 0 auto;
          ">IN</span>

          <span style="font-weight: 800; flex: 1 1 auto;">${escapeHtml(playerIn)}</span>
        </div>
      `;
    }

    async function showTransferHistory(managerId, managerName) {
      modalContent.innerHTML = "<p>Loading transfer history...</p>";
      transferModal.style.display = "block";

      try {
        const transfersRes = await fetch(`/api/fpl/entry/${managerId}/transfers`);
        const transfers = await transfersRes.json();

        const historyRes = await fetch(`/api/fpl/entry/${managerId}/history`);
        const history = await historyRes.json();

        // Group transfers by GW
        const transfersByGW = {};
        transfers.forEach(t => {
          if (!transfersByGW[t.event]) transfersByGW[t.event] = [];
          transfersByGW[t.event].push(t);
        });

        // Get chips used
        const chipsUsed = {};
        if (history.chips) {
          history.chips.forEach(chip => {
            chipsUsed[chip.event] = chip.name;
          });
        }

        let html = `
          <h2 style="margin: 0 0 6px 0; font-size: 1.45rem;">${escapeHtml(managerName)} ‚Äî Season Transfer History</h2>
          <p style="color: var(--muted); margin: 0 0 14px 0; font-size: 1.05rem;">
            Total Transfers: <strong>${transfers.length}</strong>
          </p>
        `;

        const allGWs = [...new Set([
          ...Object.keys(transfersByGW).map(Number),
          ...Object.keys(chipsUsed).map(Number)
        ])].sort((a, b) => a - b);

        html += `<div style="display: grid; gap: 12px;">`;

        allGWs.forEach(gw => {
          const chip = chipsUsed[gw];
          const gwTransfers = transfersByGW[gw] || [];
          const cost = history.current?.find(h => h.event === gw)?.event_transfers_cost || 0;

          html += `
            <div style="
              border: 1px solid var(--border);
              border-radius: 12px;
              padding: 14px;
              background: var(--surface);
            ">
              <div style="display:flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                <h3 style="margin: 0; font-size: 1.2rem;">Gameweek ${gw}</h3>
                ${cost > 0 ? `<div style="font-weight: 900; color: var(--danger);">Hit: -${cost} pts</div>` : `<div style="color: var(--muted); font-weight: 700;">No hit</div>`}
              </div>

              <div style="margin-top: 10px;">
          `;

          if (chip) {
            const chipBadge = chip === 'wildcard' ? 'üÉè Wildcard' : chip === 'freehit' ? 'üéØ Free Hit' : chip;
            html += `
              <button class="chip-btn btn btn--primary"
                data-gw="${gw}" data-manager="${managerId}" data-chip="${chip}" type="button"
                style="font-size: 1.0rem;"
              >
                ${chipBadge} (Click to view transfers)
              </button>
            `;
          } else if (gwTransfers.length > 0) {
            html += `<div style="margin-top: 4px;">`;
            gwTransfers.forEach(t => {
              const playerIn = allPlayersMap[t.element_in] || `Player ${t.element_in}`;
              const playerOut = allPlayersMap[t.element_out] || `Player ${t.element_out}`;

              // Requested order: OUT -> IN
              html += transferLineHtml(playerOut, playerIn);
            });
            html += `</div>`;
          } else {
            html += `<p style="color: var(--muted); font-style: italic; margin: 0;">No transfers</p>`;
          }

          html += `
              </div>
            </div>
          `;
        });

        html += `</div>`;

        modalContent.innerHTML = html;

        document.querySelectorAll('.chip-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const gw = e.target.dataset.gw;
            const managerId = e.target.dataset.manager;
            const chip = e.target.dataset.chip;
            await showChipTransfers(managerId, gw, chip);
          });
        });

      } catch (error) {
        console.error("Error loading transfer history:", error);
        modalContent.innerHTML = "<p style='color: red;'>Error loading transfer history.</p>";
      }
    }

    async function showChipTransfers(managerId, gw, chipName) {
      chipModalContent.innerHTML = "<p>Loading chip transfers...</p>";
      chipModal.style.display = "block";

      try {
        const picksRes = await fetch(`/api/fpl/entry/${managerId}/event/${gw}/picks`);
        const picks = await picksRes.json();

        const prevGW = parseInt(gw) - 1;
        let prevSquad = [];
        if (prevGW > 0) {
          try {
            const prevPicksRes = await fetch(`/api/fpl/entry/${managerId}/event/${prevGW}/picks`);
            const prevPicks = await prevPicksRes.json();
            prevSquad = prevPicks.picks?.map(p => p.element) || [];
          } catch (e) {
            console.warn("Couldn't fetch previous squad");
          }
        }

        const currentSquad = picks.picks?.map(p => p.element) || [];

        const playersIn = currentSquad.filter(p => !prevSquad.includes(p));
        const playersOut = prevSquad.filter(p => !currentSquad.includes(p));

        const chipDisplay = chipName === 'wildcard' ? 'üÉè Wildcard' : 'üéØ Free Hit';

        let html = `<h2 style="margin-top:0; font-size: 1.4rem;">${chipDisplay} ‚Äî Gameweek ${gw}</h2>`;
        html += `<div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; font-size: 1.05rem;">`;

        html += `<div style="border: 1px solid rgba(220,38,38,0.35); border-radius: 12px; padding: 14px; background: #fff5f5;">`;
        html += `<h3 style="color: var(--danger); margin-top: 0;">Players Out (${playersOut.length})</h3>`;
        playersOut.forEach(pid => {
          html += `<p style="margin: 8px 0; font-weight: 800;">${escapeHtml(allPlayersMap[pid] || `Player ${pid}`)}</p>`;
        });
        html += `</div>`;

        html += `<div style="border: 1px solid rgba(22,163,74,0.35); border-radius: 12px; padding: 14px; background: #f0fff4;">`;
        html += `<h3 style="color: var(--success); margin-top: 0;">Players In (${playersIn.length})</h3>`;
        playersIn.forEach(pid => {
          html += `<p style="margin: 8px 0; font-weight: 800;">${escapeHtml(allPlayersMap[pid] || `Player ${pid}`)}</p>`;
        });
        html += `</div>`;

        html += `</div>`;

        chipModalContent.innerHTML = html;

      } catch (error) {
        console.error("Error loading chip transfers:", error);
        chipModalContent.innerHTML = "<p style='color: red;'>Error loading chip transfers.</p>";
      }
    }

    async function fetchHistory(id) {
      const historyUrl = `/api/fpl/entry/${id}/history`;
      const summaryUrl = `/api/fpl/entry/${id}`;
      
      const [historyRes, summaryRes] = await Promise.all([
        fetch(historyUrl),
        fetch(summaryUrl)
      ]);
      
      if (!historyRes.ok || !summaryRes.ok) throw new Error("Load error");
      
      const historyData = await historyRes.json();
      const summaryData = await summaryRes.json();
      
      const managerName = `${summaryData.player_first_name} ${summaryData.player_last_name}`;
      
      let history = historyData.current.map(gw => ({
        entryId: Number(id),
        managerName: managerName,
        gw: gw.event,
        chipPlayed: "",
        transfers: gw.event_transfers,
        transferCost: gw.event_transfers_cost ?? 0,
        benchPoints: gw.points_on_bench ?? 0,
        gwPoints: gw.points,
        totalPoints: gw.total_points
      }));
      
      if (Array.isArray(historyData.chips)) {
        historyData.chips.forEach(c => {
          const row = history.find(gw => gw.gw === c.event);
          if (row) {
            row.chipPlayed = (
              c.name === "wildcard" ? "WC" :
              c.name === "bboost" ? "BB" :
              c.name === "3xc" ? "TC" :
              c.name === "freehit" ? "FH" : c.name
            );
          }
        });
      }
      return history;
    }

    function makeTable(histories, filterGW = null) {
      let rows = histories.flat();
      
      if (filterGW !== null && filterGW !== "") {
        const gwNum = Number(filterGW);
        rows = rows.filter(r => r.gw === gwNum);
        rows.sort((a, b) => b.totalPoints - a.totalPoints);
      } else {
        rows.sort((a,b) => a.managerName.localeCompare(b.managerName) || a.gw-b.gw);
      }

      let html = `
        <div class="table-shell">
          <div class="table-scroll" role="region" aria-label="Transfers table" tabindex="0">
            <table class="data-table" style="--sticky-col-1-width: 240px;">
              <thead>
                <tr>
                  <th class="sticky-col-1">Manager</th>
                  <th class="num">Chip<br/>Played</th>
                  <th class="num">Trans-<br/>fers</th>
                  <th class="num">Transfer<br/>Cost</th>
                  <th class="num">GW<br/>Points</th>
                  <th class="num">Total<br/>Points</th>
                  <th class="num">FTs Start<br/>of GW</th>
                  <th class="num">FTs for<br/>next GW</th>
                </tr>
              </thead>
              <tbody>
      `;

      for (const r of rows) {
        html += `
          <tr>
            <td class="sticky-col-1 strong">
              <a href="#" class="manager-link" data-id="${r.entryId}" data-name="${r.managerName}">${r.managerName}</a>
            </td>
            <td class="num">${r.chipPlayed || ""}</td>
            <td class="num">${r.transfers ?? ""}</td>
            <td class="num">${r.transferCost ?? ""}</td>
            <td class="num">${r.gwPoints ?? ""}</td>
            <td class="num">${r.totalPoints ?? ""}</td>
            <td class="num">${r.FTsStartOfGW ?? ""}</td>
            <td class="num strong">${r.FTsForNextGW ?? ""}</td>
          </tr>
        `;
      }

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
      return html;
    }

    async function loadManagers(ids) {
      if (ids.length === 0) {
        out.innerHTML = "<span style='color:red'>No manager IDs found. <a href='/managers'>Add managers here</a>.</span>";
        return;
      }

      allHistories = [];
      latestGW = null;
      out.innerHTML = "";
      loadingStatus.textContent = `Loading 0 of ${ids.length} managers...`;

      let loaded = 0;
      for (const id of ids) {
        try {
          let history = await fetchHistory(id);
          calculateFTs(history);
          allHistories.push(history);
          
          const managerMaxGW = Math.max(...history.map(h => h.gw));
          if (latestGW === null || managerMaxGW > latestGW) {
            latestGW = managerMaxGW;
          }
          
          loaded++;
          loadingStatus.textContent = `Loading ${loaded} of ${ids.length} managers...`;
          
          out.innerHTML = makeTable(allHistories, "");
          attachManagerLinks();
        } catch (e) {
          console.error(`Failed to load manager ${id}:`, e);
          loaded++;
          loadingStatus.innerHTML = `<span style='color:orange'>‚ö†Ô∏è Failed to load manager ${id}</span>`;
        }
      }
      
      loadingStatus.innerHTML = `<span style='color:#16a34a; font-weight: 700;'>‚úÖ Loaded ${loaded} of ${ids.length} managers</span>`;
      
      if (latestGW) {
        gwFilterInput.value = latestGW;
        gwFilterInput.placeholder = `Latest: GW${latestGW}`;
        filterByGW();
      }
    }

    function attachManagerLinks() {
      document.querySelectorAll('.manager-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const managerId = e.target.dataset.id;
          const managerName = e.target.dataset.name;
          showTransferHistory(managerId, managerName);
        });
      });
    }

    function filterByGW() {
      const filterGW = gwFilterInput.value.trim();
      out.innerHTML = makeTable(allHistories, filterGW);
      attachManagerLinks();
    }

    fetchPlayers();

    (async function init() {
      await fetchPlayers();
      
      const { authenticated, managerIds: ids } = await loadManagerIdsFromSupabase();
      if (!authenticated) return;
      
      managerIds = ids;
      managerCountEl.textContent = `${managerIds.length} manager(s) configured`;

      if (managerIds.length > 0) {
        loadManagers(managerIds);
      } else {
        out.innerHTML = "<span style='color:red'>No manager IDs configured. <a href='/managers'>Add managers here</a>.</span>";
      }
    })();

    gwFilterInput.addEventListener('input', filterByGW);

    clearFilterBtn.addEventListener('click', () => {
      gwFilterInput.value = "";
      filterByGW();
    });

    refreshBtn.addEventListener('click', async () => {
      gwFilterInput.value = "";
      const { managerIds: ids } = await loadManagerIdsFromSupabase();
      managerIds = ids;
      loadManagers(managerIds);
    });
  </script>
</Layout>
